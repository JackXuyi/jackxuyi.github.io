<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>奔跑的蜗牛</title>
  
  <subtitle>奔跑的蜗牛</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2021-01-23T15:13:36.918Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>奔跑的蜗牛</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>粘贴图片</title>
    <link href="http://yoursite.com/2021/01/24/%E7%B2%98%E8%B4%B4%E5%9B%BE%E7%89%87/"/>
    <id>http://yoursite.com/2021/01/24/粘贴图片/</id>
    <published>2021-01-23T22:16:19.000Z</published>
    <updated>2021-01-23T15:13:36.918Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>优化用户编辑体验，实现在编辑内容（markdown 或富文本）时通过复制的方式实现图片的插入</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ol><li>监听剪贴板事件中的 <code>paste</code> 事件</li><li>通过事件的回调对象获取粘贴内容，若为文本则执行默认操作，若为图片类型则阻止默认操作并继续处理</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cb = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> data = event.clipboardData <span class="comment">// 获取粘贴内容</span></span><br><span class="line">  <span class="keyword">let</span> fileContent</span><br><span class="line">  <span class="keyword">let</span> stopFlag = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// 遍历对象获取粘贴文件</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; data &amp;&amp; data.items &amp;&amp; i &lt; data.items.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> item = data.items[i]</span><br><span class="line">    <span class="keyword">if</span> (item.kind === <span class="string">'file'</span> &amp;&amp; item.type.match(<span class="string">'^image/'</span>)) &#123;</span><br><span class="line">      stopFlag = <span class="literal">true</span></span><br><span class="line">      fileContent = item.getAsFile()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 对 fileContent 做处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><ul><li><code>event</code> 是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ClipboardEvent" target="_blank" rel="noopener"><code>ClipboardEvent</code></a> 类型，可以通过 <code>clipboardData</code> 属性拿到数据内容</li><li><code>clipboardData</code> 是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer" target="_blank" rel="noopener"> DataTransfer`</a>对象，在粘贴事件中可以通过 <code>items</code> 属性获取粘贴的内容和数据类型，其是一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItemList" target="_blank" rel="noopener"><code>DataTransferItemList</code></a> 对象，通过 <code>for</code> 循环的方式遍历每一个元素，每个元素都是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItem" target="_blank" rel="noopener"><code>DataTransferItem</code></a>对象</li></ul><h4 id="DataTransferItem-对象"><a href="#DataTransferItem-对象" class="headerlink" title="DataTransferItem 对象"></a><code>DataTransferItem</code> 对象</h4><h5 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h5><ul><li><code>kind</code>： 拖拽项的种类，<code>string</code> 或是 <code>file</code></li><li><code>type</code>：拖拽项的类型，一般是一个 MIME 类型</li></ul><h5 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h5><ul><li><code>getAsFile()</code>：返回一个关联拖拽项的 File 对象 （当拖拽项不是一个文件时返回 null）</li><li><code>getAsString()</code>：使用拖拽项的字符串作为参数执行指定回调函数。</li><li><code>webkitGetAsEntry()</code>：返回一个基于 FileSystemEntry 的对象来表示文件系统中选中的项目。通常是返回一个 FileSystemFileEntry 或是 FileSystemDirectoryEntry 对象.</li></ul><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol><li>在 <code>mac</code> 上复制一张图片文件时会产生两个记录，第一个记录是文件名，第二个对象是文件本身</li><li>在 <code>mac</code> 上复制一个非图片类型的文件时，也会产生两个记录，一个是文件名，另一个是文件的缩略图，但是这个文章的缩略图通过 <code>getAsFile</code> 方法无法获取到内容</li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/Events/paste" target="_blank" rel="noopener">paste 事件</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;优化用户编辑体验，实现在编辑内容（markdown 或富文本）时通过复制的方式实现图片的插入&lt;/p&gt;
&lt;h3 id=&quot;实现&quot;&gt;&lt;a href
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>跨页面通信</title>
    <link href="http://yoursite.com/2021/01/17/%E8%B7%A8%E9%A1%B5%E9%9D%A2%E9%80%9A%E4%BF%A1/"/>
    <id>http://yoursite.com/2021/01/17/跨页面通信/</id>
    <published>2021-01-17T13:37:39.000Z</published>
    <updated>2021-01-17T14:59:28.314Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在浏览器中每个页面都运行在单独的进程中，如何实现页面间的通信？</p><h3 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h3><h4 id="BroadCastChannel"><a href="#BroadCastChannel" class="headerlink" title="BroadCastChannel"></a>BroadCastChannel</h4><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/BroadcastChannel" target="_blank" rel="noopener">BroadcastChannel</a> 接口代理了一个命名频道，可以让指定 origin 下的任意 browsing context 来订阅它。它允许同源的不同浏览器窗口，Tab 页，frame 或者 iframe 下的不同文档之间相互通信。通过触发一个 <code>message</code> 事件，消息可以广播到所有监听了该频道的 <code>BroadcastChannel</code> 对象。</p><ol><li>构建一个实例</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bc = <span class="keyword">new</span> BroadcastChannel(<span class="string">'channel'</span>)</span><br></pre></td></tr></table></figure><ol start="2"><li>调用 <code>postMessage</code> 发送消息</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bc.postMessage(data)</span><br></pre></td></tr></table></figure><ol start="3"><li>分别监听 <code>onmessage</code> 和 <code>onmessageerror</code> 事件来接收数据和错误消息</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bc.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// e.data是发送过来的数据，可以根据数据做一些事情</span></span><br><span class="line">&#125;</span><br><span class="line">bc.onmessageerror = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 错误消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>调用 <code>close</code> 关闭通道，并销毁 <code>BroadcastChannel</code> 对象</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bc.close()</span><br></pre></td></tr></table></figure><h4 id="localStorage-实现"><a href="#localStorage-实现" class="headerlink" title="localStorage 实现"></a>localStorage 实现</h4><p>当前页面使用的 <code>storage</code> 被其他页面修改时会触发 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/StorageEvent" target="_blank" rel="noopener"><code>StorageEvent</code></a> 事件</p><ol><li>在源页面设置值触发事件</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localStorage.setItem(<span class="string">'newValue'</span>, <span class="string">'new'</span>)</span><br></pre></td></tr></table></figure><ol start="2"><li>在接收页面监听 <code>storage</code> 事件以实现通信</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'storage'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// e.newValue表示新设置的值</span></span><br><span class="line">  <span class="comment">// e.key表示新设置的值的键</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h4 id="其它方案"><a href="#其它方案" class="headerlink" title="其它方案"></a>其它方案</h4><ol><li><code>Service Worker</code>: 一个可以长期运行在后台的 Worker，能够实现与页面的双向通信。</li><li><code>Shared Worker</code>: Worker 家族的另一个成员。普通的 Worker 之间是独立运行、数据互不相通；而多个 Tab 注册的 Shared Worker 则可以实现数据共享。</li><li><code>IndexedDB</code>: 数据存储技术</li><li><code>window.open + window.opener</code>: 当我们使用 window.open 打开页面时，方法会返回一个被打开页面 window 的引用。而在未显示指定 no opener 时，被打开的页面可以通过 window.opener 获取到打开它的页面的引用 —— 通过这种方式我们就将这些页面建立起了联系（一种树形结构）。</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/visibilitychange_event" target="_blank" rel="noopener"><code>visibilitychange</code></a>: 当其选项卡的内容变得可见或被隐藏时，会在文档上触发 visibilitychange (能见度更改)事件。</li></ol><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://github.com/kd-cloud-web/Blog/issues/41" target="_blank" rel="noopener">几种跨页面通信的方案</a></li><li><a href="https://zhuanlan.zhihu.com/p/81237384" target="_blank" rel="noopener">跨页面的通信解决方案</a></li><li><a href="https://juejin.cn/post/6844903495636615176" target="_blank" rel="noopener">跨页面通信的各种姿势</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;在浏览器中每个页面都运行在单独的进程中，如何实现页面间的通信？&lt;/p&gt;
&lt;h3 id=&quot;实现方案&quot;&gt;&lt;a href=&quot;#实现方案&quot; clas
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>nodejs中实现websocket服务</title>
    <link href="http://yoursite.com/2021/01/06/nodejs%E4%B8%AD%E5%AE%9E%E7%8E%B0websocket%E6%9C%8D%E5%8A%A1/"/>
    <id>http://yoursite.com/2021/01/06/nodejs中实现websocket服务/</id>
    <published>2021-01-05T22:57:14.000Z</published>
    <updated>2021-01-05T15:33:42.759Z</updated>
    
    <content type="html"><![CDATA[<h3 id="建立链接"><a href="#建立链接" class="headerlink" title="建立链接"></a>建立链接</h3><p>若要实现 WebSocket 协议，首先需要浏览器主动发起一个 HTTP 请求。</p><p>这个请求头包含“Upgrade”字段，内容为“websocket”（注：upgrade 字段用于改变 HTTP 协议版本或换用其他协议，这里显然是换用了 websocket 协议），还有一个最重要的字段“Sec-WebSocket-Key”，这是一个随机的经过 base64 编码的字符串，像密钥一样用于服务器和客户端的握手过程。一旦服务器君接收到来自客户端的 upgrade 请求，便会将请求头中的“Sec-WebSocket-Key”字段提取出来，追加一个固定的“魔串”：<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>，并进行 SHA-1 加密，然后再次经过 base64 编码生成一个新的 key，作为响应头中的“Sec-WebSocket-Accept”字段的内容返回给浏览器。一旦浏览器接收到来自服务器的响应，便会解析响应中的“Sec-WebSocket-Accept”字段，与自己加密编码后的串进行匹配，一旦匹配成功，便有建立连接的可能了（因为还依赖许多其他因素）。</p><p>这是一个基本的 Client 请求头：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Upgrade:</span> <span class="string">websocket</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">Upgrade</span></span><br><span class="line"><span class="attr">Sec-WebSocket-Key:</span> <span class="string">************==</span></span><br><span class="line"><span class="attr">Sec-WebSocket-Version:</span> <span class="string">**</span></span><br></pre></td></tr></table></figure><p>Server 正确接收后，会返回一个响应头：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Upgrade：websocket</span></span><br><span class="line"><span class="attr">Connnection:</span> <span class="string">Upgrade</span></span><br><span class="line"><span class="attr">Sec-WebSocket-Accept:</span> <span class="string">******************</span></span><br></pre></td></tr></table></figure><p>这表示双方握手成功了，之后就是全双工的通信。</p><h4 id="js-代码实现"><a href="#js-代码实现" class="headerlink" title="js 代码实现"></a>js 代码实现</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构建响应头</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildHeaders</span>(<span class="params">secWebsocketKey</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 计算返回的key</span></span><br><span class="line">  <span class="keyword">const</span> resKey = crypto</span><br><span class="line">    .createHash(<span class="string">'sha1'</span>)</span><br><span class="line">    .update(secWebsocketKey + <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>)</span><br><span class="line">    .digest(<span class="string">'base64'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造响应头</span></span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">'HTTP/1.1 101 Switching Protocols'</span>,</span><br><span class="line">    <span class="string">'Upgrade: websocket'</span>,</span><br><span class="line">    <span class="string">'Connection: Upgrade'</span>,</span><br><span class="line">    <span class="string">'Sec-WebSocket-Accept: '</span> + resKey,</span><br><span class="line">  ]</span><br><span class="line">    .concat(<span class="string">''</span>, <span class="string">''</span>)</span><br><span class="line">    .join(<span class="string">'\r\n'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解析数据"><a href="#解析数据" class="headerlink" title="解析数据"></a>解析数据</h3><h4 id="Frame（帧）"><a href="#Frame（帧）" class="headerlink" title="Frame（帧）"></a>Frame（帧）</h4><p>WebSocket 传输的数据都是以 Frame（帧）的形式实现的，就像 TCP/UDP 协议中的报文段 Segment。下面就是一个 Frame：（以 bit 为单位表示）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment">  1               2               3               4</span></span><br><span class="line"><span class="comment">  0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7</span></span><br><span class="line"><span class="comment"> +-+-+-+-+-------+-+-------------+-------------------------------+</span></span><br><span class="line"><span class="comment"> |F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span></span><br><span class="line"><span class="comment"> |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span></span><br><span class="line"><span class="comment"> |N|V|V|V|       |S|             |   (if payload len==126/127)   |</span></span><br><span class="line"><span class="comment"> | |1|2|3|       |K|             |                               |</span></span><br><span class="line"><span class="comment"> +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span></span><br><span class="line"><span class="comment"> |     Extended payload length continued, if payload len == 127  |</span></span><br><span class="line"><span class="comment"> + - - - - - - - - - - - - - - - +-------------------------------+</span></span><br><span class="line"><span class="comment"> |                               |Masking-key, if MASK set to 1  |</span></span><br><span class="line"><span class="comment"> +-------------------------------+-------------------------------+</span></span><br><span class="line"><span class="comment"> | Masking-key (continued)       |          Payload Data         |</span></span><br><span class="line"><span class="comment"> +-------------------------------- - - - - - - - - - - - - - - - +</span></span><br><span class="line"><span class="comment"> :                     Payload Data continued ...                :</span></span><br><span class="line"><span class="comment"> + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span></span><br><span class="line"><span class="comment"> |                     Payload Data continued ...                |</span></span><br><span class="line"><span class="comment"> +---------------------------------------------------------------+</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><h5 id="按照-RFC-中的描述："><a href="#按照-RFC-中的描述：" class="headerlink" title="按照 RFC 中的描述："></a>按照 RFC 中的描述：</h5><ul><li>FIN： 1 bit， 0 表示还有后续帧，1 表示最后一帧</li><li>RSV1、2、3： 没个 1 bit，除非一个扩展经过协商赋予了非零值以某种含义，否则必须为 0，如果没有定义非零值，并且收到了非零的 RSV，则 websocket 链接会失败</li><li>Opcode： 4 bit，如果收到了未知的 opcode，最后会断开链接, 这四位的值组合结果的含义分别如下：</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">0x0 :</span> <span class="string">代表连续的帧</span></span><br><span class="line"><span class="attr">0x1 :</span> <span class="string">text帧</span></span><br><span class="line"><span class="number">0x2</span> <span class="string">：</span> <span class="string">binary帧</span></span><br><span class="line"><span class="number">0x3</span><span class="number">-0x7</span> <span class="string">：</span> <span class="string">为非控制帧而预留的</span></span><br><span class="line"><span class="number">0x8</span> <span class="string">：</span> <span class="string">关闭握手帧</span></span><br><span class="line"><span class="number">0x9</span> <span class="string">：</span> <span class="string">ping帧</span></span><br><span class="line"><span class="attr">0xA :</span> <span class="string">pong</span> <span class="string">帧</span></span><br><span class="line"><span class="number">0xB</span><span class="number">-0xF</span> <span class="string">：</span> <span class="string">为非控制帧而预留的</span></span><br></pre></td></tr></table></figure><ul><li>Mask： 1 bit，0 表示数据没有添加掩码，1 表示数据被添加了掩码，如果置 1， “Masking-key”就会被赋值，所有从客户端发往服务器的帧都会被置 1</li><li>Payload length： 7 bit | 7+16 bit | 7+64 bit，“payload data” 的长度如果在 0~125 bytes 范围内，它就是“payload length”，如果是 126 bytes， 紧随其后的被表示为 16 bits 的 2 bytes 无符号整型就是“payload length”，如果是 127 bytes， 紧随其后的被表示为 64 bits 的 8 bytes 无符号整型就是“payload length”</li><li>Masking-key： 0 or 4 bytes，所有从客户端发送到服务器的帧都包含一个 32 bits 的掩码（如果“mask bit”被设置成 1），否则为 0 bit。一旦掩码被设置，所有接收到的 payload data 都必须与该值以一种算法做异或运算来获取真实值。</li><li>Payload data: n bytes，数据内容</li></ul><h4 id="读取数据帧"><a href="#读取数据帧" class="headerlink" title="读取数据帧"></a>读取数据帧</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomReadSocket</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> MAGIC_STRING = <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(req, socket, head) &#123;</span><br><span class="line">    <span class="keyword">super</span>()</span><br><span class="line">    <span class="comment">// 保存上下文信息</span></span><br><span class="line">    <span class="keyword">this</span>.req = req</span><br><span class="line">    <span class="keyword">this</span>.socket = socket</span><br><span class="line">    <span class="keyword">this</span>.head = head</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部状态</span></span><br><span class="line">    <span class="keyword">this</span>.dataType = <span class="string">''</span></span><br><span class="line">    <span class="keyword">this</span>.resHeaders = <span class="keyword">this</span>.buildHeaders(req.headers[<span class="string">'sec-websocket-key'</span>])</span><br><span class="line">    <span class="keyword">this</span>.buffer = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收数据</span></span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">'data'</span>, <span class="keyword">this</span>.handleData)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应给客户端</span></span><br><span class="line">    <span class="keyword">this</span>.socket.write(<span class="keyword">this</span>.resHeaders)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建响应头</span></span><br><span class="line">  buildHeaders(secWebsocketKey) &#123;</span><br><span class="line">    <span class="comment">// 计算返回的key</span></span><br><span class="line">    <span class="keyword">const</span> resKey = crypto</span><br><span class="line">      .createHash(<span class="string">'sha1'</span>)</span><br><span class="line">      .update(secWebsocketKey + CustomReadSocket.MAGIC_STRING)</span><br><span class="line">      .digest(<span class="string">'base64'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造响应头</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      <span class="string">'HTTP/1.1 101 Switching Protocols'</span>,</span><br><span class="line">      <span class="string">'Upgrade: websocket'</span>,</span><br><span class="line">      <span class="string">'Connection: Upgrade'</span>,</span><br><span class="line">      <span class="string">'Sec-WebSocket-Accept: '</span> + resKey,</span><br><span class="line">    ]</span><br><span class="line">      .concat(<span class="string">''</span>, <span class="string">''</span>)</span><br><span class="line">      .join(<span class="string">'\r\n'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理收到的数据</span></span><br><span class="line">  handleData = <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> type = <span class="keyword">this</span>.getFrameType(data[<span class="number">0</span>])</span><br><span class="line">      <span class="keyword">if</span> (type &amp;&amp; type !== <span class="string">'continue'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.dataType = type</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (type === <span class="string">'continue'</span> || type === <span class="string">'text'</span> || type === <span class="string">'binary'</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> maskLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.hasMask(data[<span class="number">1</span>])) &#123;</span><br><span class="line">          maskLen = <span class="number">4</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> [start, len] = <span class="keyword">this</span>.getFrameDataLength(data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.getDataFromFrame(</span><br><span class="line">          data.slice(start + maskLen),</span><br><span class="line">          data.slice(start, start + maskLen),</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="keyword">this</span>.isLastFrame(data[<span class="number">0</span>]))</span><br><span class="line">    <span class="keyword">this</span>.handleAllType(<span class="keyword">this</span>.dataType)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取当前帧类型</span></span><br><span class="line">  getFrameType(byte) &#123;</span><br><span class="line">    <span class="keyword">const</span> realType = byte &amp; <span class="number">0x7f</span></span><br><span class="line">    <span class="keyword">if</span> (!realType) &#123;</span><br><span class="line">      <span class="comment">// 代表连续的帧</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'continue'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x01</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'text'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x09</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'ping'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x0a</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'pong'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x02</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'binary'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x08</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'close'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理所有帧类型</span></span><br><span class="line">  handleAllType(type) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'continue'</span>: &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'continue'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'text'</span>: &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'message'</span>, <span class="keyword">this</span>.buffer.toString())</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'binary'</span>: &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'message'</span>, <span class="keyword">this</span>.buffer)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'close'</span>: &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'ping'</span>: &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'ping'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'pong'</span>: &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'pong'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'others'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 释放 buffer 和重置数据类型</span></span><br><span class="line">    <span class="keyword">this</span>.buffer = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.dataType = <span class="string">''</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否是最后一个帧</span></span><br><span class="line">  isLastFrame(byte) &#123;</span><br><span class="line">    <span class="keyword">return</span> !!(byte &amp; <span class="number">0x80</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取帧的长度</span></span><br><span class="line">  getFrameDataLength(buffer) &#123;</span><br><span class="line">    <span class="comment">// 第二个字节的底 7 位</span></span><br><span class="line">    <span class="keyword">const</span> firtLen = buffer[<span class="number">1</span>] &amp; <span class="number">0x7f</span></span><br><span class="line">    <span class="keyword">if</span> (firtLen &lt; <span class="number">125</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [<span class="number">2</span>, firtLen]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firtLen === <span class="number">126</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> len = buffer.readUInt16BE(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">return</span> [<span class="number">4</span>, len]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> len = buffer.readUInt64BE(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">return</span> [<span class="number">10</span>, len]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否有掩码</span></span><br><span class="line">  hasMask(byte) &#123;</span><br><span class="line">    <span class="keyword">return</span> !!(<span class="number">0x80</span> &amp; byte)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从帧里提取数据</span></span><br><span class="line">  getDataFromFrame(buffer, maskBuffer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (buffer &amp;&amp; buffer.length) &#123;</span><br><span class="line">      <span class="keyword">const</span> len = buffer.length</span><br><span class="line">      <span class="keyword">if</span> (maskBuffer &amp;&amp; maskBuffer.length === <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">          buffer[i] = buffer[i] ^ maskBuffer[i % <span class="number">4</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.buffer = <span class="keyword">this</span>.buffer ? Buffer.concat([<span class="keyword">this</span>.buffer, buffer]) : buffer</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="写入数据帧"><a href="#写入数据帧" class="headerlink" title="写入数据帧"></a>写入数据帧</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomWebsocket</span> <span class="keyword">extends</span> <span class="title">CustomReadSocket</span> </span>&#123;</span><br><span class="line">  timer = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">constructor</span>(req, socket, head, options) &#123;</span><br><span class="line">    <span class="keyword">super</span>(req, socket, head)</span><br><span class="line">    <span class="keyword">this</span>.options = options</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.timeout()</span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">'data'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.timeout()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  send(message) &#123;</span><br><span class="line">    <span class="keyword">const</span> buffer = Buffer.from(message)</span><br><span class="line">    <span class="keyword">const</span> list = <span class="keyword">this</span>.buildDataFrameList(<span class="string">'text'</span>, buffer)</span><br><span class="line">    list.forEach(<span class="function">(<span class="params">frame</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.socket.write(frame)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">this</span>.timeout()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ping() &#123;</span><br><span class="line">    <span class="keyword">const</span> frame = <span class="keyword">this</span>.buildFrame(<span class="string">'ping'</span>)</span><br><span class="line">    <span class="keyword">this</span>.socket.write(frame)</span><br><span class="line">    <span class="keyword">this</span>.timeout()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pong() &#123;</span><br><span class="line">    <span class="keyword">const</span> frame = <span class="keyword">this</span>.buildFrame(<span class="string">'pong'</span>)</span><br><span class="line">    <span class="keyword">this</span>.socket.write(frame)</span><br><span class="line">    <span class="keyword">this</span>.timeout()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close() &#123;</span><br><span class="line">    <span class="keyword">const</span> frame = <span class="keyword">this</span>.buildFrame(<span class="string">'close'</span>)</span><br><span class="line">    <span class="keyword">this</span>.socket.write(frame)</span><br><span class="line">    <span class="keyword">this</span>.socket.end()</span><br><span class="line">    process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.socket.destroy()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  timeout() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; timeout = <span class="number">10000</span> &#125; = <span class="keyword">this</span>.options || &#123;&#125;</span><br><span class="line">    clearTimeout(<span class="keyword">this</span>.timer)</span><br><span class="line">    <span class="keyword">this</span>.timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.ping()</span><br><span class="line">    &#125;, timeout)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  buildDataFrameList(type, buffer) &#123;</span><br><span class="line">    <span class="keyword">const</span> bufferList = []</span><br><span class="line">    <span class="keyword">let</span> tempBuffer = buffer</span><br><span class="line">    <span class="keyword">while</span> (tempBuffer.length) &#123;</span><br><span class="line">      bufferList.push(tempBuffer.slice(<span class="number">0</span>, <span class="keyword">this</span>.MAX_FRAME_SIZE))</span><br><span class="line">      tempBuffer = tempBuffer.slice(<span class="keyword">this</span>.MAX_FRAME_SIZE)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> len = bufferList.length</span><br><span class="line">    <span class="keyword">return</span> bufferList.map(<span class="function">(<span class="params">buf, index</span>) =&gt;</span></span><br><span class="line">      <span class="keyword">this</span>.buildFrame(index ? <span class="string">'continue'</span> : type, len === index + <span class="number">1</span>, buf),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  buildFrame(dataType, isLast = <span class="literal">true</span>, buffer = <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> firstByte = isLast ? <span class="number">0x80</span> : <span class="number">0x00</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="string">`<span class="subst">$&#123;dataType || <span class="string">''</span>&#125;</span>`</span>.toLowerCase()) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'continue'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x00</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'text'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x01</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'binary'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x02</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'close'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x08</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'ping'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x09</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'pong'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x0a</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'others'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> secondByte = <span class="number">0x00</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buffer &amp;&amp; buffer.length) &#123;</span><br><span class="line">      <span class="keyword">const</span> lenByteList = []</span><br><span class="line">      <span class="keyword">const</span> len = buffer.length</span><br><span class="line">      <span class="keyword">if</span> (len &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">        secondByte = secondByte | len</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt;= <span class="number">126</span> &amp;&amp; len &lt; <span class="number">65536</span>) &#123;</span><br><span class="line">        secondByte = secondByte | <span class="number">0x7e</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">          lenByteList.push(<span class="number">0xff</span> &amp; (len &gt;&gt; (i * <span class="number">8</span>)))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        secondByte = secondByte | <span class="number">0x7f</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">          lenByteList.push(<span class="number">0xff</span> &amp; (len &gt;&gt; (i * <span class="number">8</span>)))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lenByteList.reverse()</span><br><span class="line">      <span class="keyword">const</span> prefixBuffer = Buffer.from([firstByte, secondByte, ...lenByteList])</span><br><span class="line">      <span class="keyword">return</span> Buffer.concat([prefixBuffer, buffer])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Buffer.from([firstByte, secondByte])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://github.com/abbshr/abbshr.github.io/issues/22" target="_blank" rel="noopener">学习 WebSocket 协议—从顶层到底层的实现原理（修订版）</a></li><li><a href="https://segmentfault.com/a/1190000016467409" target="_blank" rel="noopener">Node.js - 200 多行代码实现 Websocket 协议</a></li><li><a href="https://segmentfault.com/a/1190000012709475" target="_blank" rel="noopener">WebSocket：5 分钟从入门到精通</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSockets_API/Writing_WebSocket_servers" target="_blank" rel="noopener">编写 WebSocket 服务器</a></li><li><a href="https://github.com/JackXuyi/web-exercise/blob/master/handwriting/socketServer.js" target="_blank" rel="noopener">本文涉及到的页面源代码</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;建立链接&quot;&gt;&lt;a href=&quot;#建立链接&quot; class=&quot;headerlink&quot; title=&quot;建立链接&quot;&gt;&lt;/a&gt;建立链接&lt;/h3&gt;&lt;p&gt;若要实现 WebSocket 协议，首先需要浏览器主动发起一个 HTTP 请求。&lt;/p&gt;
&lt;p&gt;这个请求头包含“Upgrad
      
    
    </summary>
    
    
      <category term="node" scheme="http://yoursite.com/tags/node/"/>
    
  </entry>
  
  <entry>
    <title>记一次项目打包优化</title>
    <link href="http://yoursite.com/2020/12/23/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E4%BC%98%E5%8C%96/"/>
    <id>http://yoursite.com/2020/12/23/记一次项目打包优化/</id>
    <published>2020-12-22T19:19:21.000Z</published>
    <updated>2020-12-22T12:46:35.011Z</updated>
    
    <content type="html"><![CDATA[<p>由于项目功能越来复杂，打包发布的速度越来越慢，严重影响了开发速度，所以决定优化下打包发布速度</p><h2 id="分析打包流程及耗时"><a href="#分析打包流程及耗时" class="headerlink" title="分析打包流程及耗时"></a>分析打包流程及耗时</h2><h3 id="打包流程"><a href="#打包流程" class="headerlink" title="打包流程"></a>打包流程</h3><ul><li>代码 clone 到打包服务器上</li><li>编译代码，项目采用 nextjs 进行服务端渲染，所以编译编译时分为两个部分，分别为构建服务端 js 和客户端 js，每次编译都要先安装项目依赖，再执行打包构建命令</li><li>构建 docker 容器，项目运行在 docker 容器中，每次打包发布都是构建一个新的容器去替换对应环境的容器</li><li>部署静态资源，把客户端对应的 js 推送到 CDN 上</li><li>替换容器，用之前构建的容器去替换当前环境的容器</li></ul><h3 id="耗时分析"><a href="#耗时分析" class="headerlink" title="耗时分析"></a>耗时分析</h3><ul><li>clone 代码速度由网络和项目大小决定（网络无法控制，源代码不大，优化效果不明显）—— 通常在 10 秒左右</li><li>采用 webpack 进行编译，可以通过插件进行构建优化 —— 通常在 2.5 分钟左右</li><li>构建 docker 容器时会把 node_modules 下的依赖按照生产模式的方式放入容器中 —— 通常在 4.5 分钟左右</li><li>静态资源的上传由上传资源大小及网络决定，上传由基础组控制 —— 2 分钟左右</li><li>替换容器由集群控制，业务方无法控制 —— 通常在 1 分左右</li></ul><h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>通过上面的分析发现，制作 docker 容器和 打包过程最耗费时间，且这两块也在业务方控制之中，所以优化从这两方面着手</p><h3 id="docker-容器优化"><a href="#docker-容器优化" class="headerlink" title="docker 容器优化"></a>docker 容器优化</h3><p>通过查看打包日志发现制作 docker 容器时发现制作容器时发送的上下文达 1G 多，对比其它项目明显偏大</p><h4 id="优化方向分析"><a href="#优化方向分析" class="headerlink" title="优化方向分析"></a>优化方向分析</h4><ul><li>发送的上下文是在生产模式下安装的依赖，即只会安装 <code>dependencies</code> 下的依赖 —— 考虑把所有非服务端必须的依赖安装到 <code>devDependencies</code> 中以减小上下文大小</li><li>由于需要 SEO 优化，优化不能减少服务端渲染时的页面内容 —— 只能优化对页面内容没有影响但是需要客户端交互及样式操作相关的库</li></ul><h4 id="优化操作"><a href="#优化操作" class="headerlink" title="优化操作"></a>优化操作</h4><ul><li>通过 webpack 插件提取项目中使用的依赖，结合 package.json 的配置，筛选出项目中无用的依赖</li><li>筛选出 <code>dependencies</code> 中的依赖是否可以只在客户端渲染时引入，例如 <code>react-copy-to-clipboard</code> 只会在客户端执行复制操作就可以放入 <code>devDependencies</code> 中以便只在客户端引入</li></ul><h4 id="优化效果"><a href="#优化效果" class="headerlink" title="优化效果"></a>优化效果</h4><p>构建 docker 容器的时间从优化前的 4.5 分钟左右下降到 2.5 分钟左右，优化了 50%</p><h3 id="webpack-打包优化"><a href="#webpack-打包优化" class="headerlink" title="webpack 打包优化"></a>webpack 打包优化</h3><p>此项目是基于 webpack 4.x 进行打包的，可以通过插件和 webpack 配置及 loader 的形式进行打包优化</p><h4 id="webpack-4-使用-v8-引擎带来的优化"><a href="#webpack-4-使用-v8-引擎带来的优化" class="headerlink" title="webpack 4 使用 v8 引擎带来的优化"></a>webpack 4 使用 v8 引擎带来的优化</h4><ul><li>for of 替代 forEach</li><li>Map 和 Set 替代 Object</li><li>includes 替代 indexOf()</li><li>默认使用更快的 md4 hash 算法 替代 md5 算法，md4 较 md5 速度更快</li><li>webpack AST 可以直接从 loader 传递给 AST，从而减少解析时间</li><li>使用字符串方法替代正则表达式</li></ul><h4 id="优化方向分析-1"><a href="#优化方向分析-1" class="headerlink" title="优化方向分析"></a>优化方向分析</h4><p>通过 <a href="https://www.npmjs.com/package/speed-measure-webpack-plugin" target="_blank" rel="noopener">speed-measure-webpack-plugin</a> 插件进行打包耗时分析</p><ul><li>通过配置 <code>exclude / include</code> 和忽略第三方包指定目录及通过 externals 缩小打包文件范围</li><li>多进程并行打包和代码压缩</li><li>缓存编译结果</li><li>babel 配置的优化</li></ul><h4 id="优化操作-1"><a href="#优化操作-1" class="headerlink" title="优化操作"></a>优化操作</h4><p>通过研究框架 webpack 配置发现项目已经引入 <code>cache-loader</code>、<code>thread-loader</code> 等 <code>loader</code> 和插件及配置优化代码打包速度，所以未做 <code>webpack</code> 打包优化</p><ul><li>引入 <code>speed-measure-webpack-plugin</code> 查看打包耗时</li></ul><h3 id="相关知识点"><a href="#相关知识点" class="headerlink" title="相关知识点"></a>相关知识点</h3><ul><li><a href="https://www.webpackjs.com/concepts/" target="_blank" rel="noopener">webpack</a></li><li><a href="https://yeasy.gitbook.io/docker_practice/" target="_blank" rel="noopener">docker</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;由于项目功能越来复杂，打包发布的速度越来越慢，严重影响了开发速度，所以决定优化下打包发布速度&lt;/p&gt;
&lt;h2 id=&quot;分析打包流程及耗时&quot;&gt;&lt;a href=&quot;#分析打包流程及耗时&quot; class=&quot;headerlink&quot; title=&quot;分析打包流程及耗时&quot;&gt;&lt;/a&gt;分析打包流
      
    
    </summary>
    
    
      <category term="其它" scheme="http://yoursite.com/tags/other/"/>
    
  </entry>
  
  <entry>
    <title>ts之type、interface和class区别</title>
    <link href="http://yoursite.com/2020/12/14/ts%E4%B9%8Btype%E3%80%81interface%E5%92%8Cclass%E5%8C%BA%E5%88%AB/"/>
    <id>http://yoursite.com/2020/12/14/ts之type、interface和class区别/</id>
    <published>2020-12-13T22:04:08.000Z</published>
    <updated>2020-12-22T11:17:35.580Z</updated>
    
    <content type="html"><![CDATA[<h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p><a href="https://www.typescriptlang.org/docs/handbook/2/everyday-types.html#type-aliases" target="_blank" rel="noopener">任意类型的别名</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">We’ve been using object types and union types by writing them directly in type annotations. This is convenient, but it’s common to want to use the same type more than once and refer to it by a single name.</span><br><span class="line">A type alias is exactly that - a name for any type.</span><br></pre></td></tr></table></figure><h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> test = <span class="built_in">number</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// error: 标识符“test”重复。</span></span><br><span class="line"><span class="comment">// type test = string</span></span><br></pre></td></tr></table></figure><h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul><li>任意类型的别名（包含基本类型）</li><li>只可以定义一次（多次定义报 ’标识符“test”重复‘ 错误）</li></ul><h3 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h3><p><a href="https://www.typescriptlang.org/docs/handbook/interfaces.html" target="_blank" rel="noopener">接口的作用就是为这些类型命名和为你的代码或第三方代码定义契约。</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">One of TypeScript’s core principles is that type checking focuses on the shape that values have. This is sometimes called “duck typing” or “structural subtyping”. In TypeScript, interfaces fill the role of naming these types, and are a powerful way of defining contracts within your code as well as contracts with code outside of your project.</span><br></pre></td></tr></table></figure><h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Shape &#123;</span><br><span class="line">  color: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Shape &#123;</span><br><span class="line">  size?: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> PenStroke &#123;</span><br><span class="line">  penWidth: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Square <span class="keyword">extends</span> Shape, PenStroke &#123;</span><br><span class="line">  sideLength: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> square = &lt;Square&gt;&#123;&#125;</span><br><span class="line">square.color = <span class="string">'blue'</span></span><br><span class="line">square.sideLength = <span class="number">10</span></span><br><span class="line">square.penWidth = <span class="number">5.0</span></span><br><span class="line">square.size = <span class="number">100</span></span><br></pre></td></tr></table></figure><h3 id="class"><a href="#class" class="headerlink" title="class"></a>class</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="noopener">类是“特殊的函数”，就像你能够定义的函数表达式和函数声明一样，类语法有两个组成部分：类表达式和类声明。</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeScript offers full support for the class keyword introduced in ES2015. As with other JavaScript language features, TypeScript adds type annotations and other syntax to allow you to express relationships between classes and other types.</span><br></pre></td></tr></table></figure><h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> passcode = <span class="string">'secret passcode'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Employee &#123;</span><br><span class="line">  <span class="keyword">private</span> _fullName: <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> fullName(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._fullName</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> fullName(newName: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (passcode &amp;&amp; passcode == <span class="string">'secret passcode'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>._fullName = newName</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Error: Unauthorized update of employee!'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> employee = <span class="keyword">new</span> Employee()</span><br><span class="line">employee.fullName = <span class="string">'Bob Smith'</span></span><br><span class="line"><span class="keyword">if</span> (employee.fullName) &#123;</span><br><span class="line">  alert(employee.fullName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="abstract-class"><a href="#abstract-class" class="headerlink" title="abstract class"></a>abstract class</h3><p><a href="https://www.tslang.cn/docs/handbook/classes.html" target="_blank" rel="noopener">抽象类做为其它派生类的基类使用。 它们一般不会直接被实例化。 不同于接口，抽象类可以包含成员的实现细节。 abstract 关键字是用于定义抽象类和在抽象类内部定义抽象方法。</a></p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> Department &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">public</span> name: <span class="built_in">string</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  printName(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Department name: '</span> + <span class="keyword">this</span>.name)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">abstract</span> printMeeting(): <span class="built_in">void</span> <span class="comment">// 必须在派生类中实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> AccountingDepartment <span class="keyword">extends</span> Department &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">'Accounting and Auditing'</span>) <span class="comment">// 在派生类的构造函数中必须调用 super()</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printMeeting(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'The Accounting Department meets each Monday at 10am.'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  generateReports(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Generating accounting reports...'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> department: Department <span class="comment">// 允许创建一个对抽象类型的引用</span></span><br><span class="line">department = <span class="keyword">new</span> Department() <span class="comment">// 错误: 不能创建一个抽象类的实例</span></span><br><span class="line">department = <span class="keyword">new</span> AccountingDepartment() <span class="comment">// 允许对一个抽象子类进行实例化和赋值</span></span><br><span class="line">department.printName()</span><br><span class="line">department.printMeeting()</span><br><span class="line">department.generateReports() <span class="comment">// 错误: 方法在声明的抽象类中不存在</span></span><br></pre></td></tr></table></figure><h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ul><li>接口创建了一个新的名字，可以在其它任何地方使用。 类型别名并不创建新名字—比如，错误信息就不会使用别名。</li><li>类型别名不能被 extends 和 implements（自己也不能 extends 和 implements 其它类型）。</li><li>接口只能用来声明对象，而不能重新命名基本数据类型。</li><li>接口名称将始终以原始形式出现在错误消息中，当按名称使用时才显示。</li><li>接口可以进行声明合并</li><li>抽象类和接口一样不可以被实例化，但是抽象类可以包含部分属性方法的实现</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;type&quot;&gt;&lt;a href=&quot;#type&quot; class=&quot;headerlink&quot; title=&quot;type&quot;&gt;&lt;/a&gt;type&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://www.typescriptlang.org/docs/handbook/2/everyd
      
    
    </summary>
    
    
      <category term="TypeScript" scheme="http://yoursite.com/tags/TypeScript/"/>
    
  </entry>
  
  <entry>
    <title>for...in和for...of的区别</title>
    <link href="http://yoursite.com/2020/11/22/for-in%E5%92%8Cfor-of%E7%9A%84%E5%8C%BA%E5%88%AB/"/>
    <id>http://yoursite.com/2020/11/22/for-in和for-of的区别/</id>
    <published>2020-11-21T17:09:16.000Z</published>
    <updated>2020-11-21T10:25:50.673Z</updated>
    
    <content type="html"><![CDATA[<h3 id="Iterator（遍历器）的概念"><a href="#Iterator（遍历器）的概念" class="headerlink" title="Iterator（遍历器）的概念"></a>Iterator（遍历器）的概念</h3><p>遍历器（Iterator）一种接口，为各种不同的数据结构提供统一的访问机制。任何数据结构只要部署 Iterator 接口，就可以完成遍历操作（即依次处理该数据结构的所有成员）。</p><h4 id="Iterator-的作用"><a href="#Iterator-的作用" class="headerlink" title="Iterator 的作用"></a>Iterator 的作用</h4><ul><li>为各种数据结构，提供一个统一的、简便的访问接口。</li><li>使得数据结构的成员能够按某种次序排列。</li><li>ES6 创造了一种新的遍历命令 for…of 循环，Iterator 接口主要供 for…of 消费。</li></ul><h4 id="Iterator-的遍历"><a href="#Iterator-的遍历" class="headerlink" title="Iterator 的遍历"></a>Iterator 的遍历</h4><ol><li>创建一个指针对象，指向当前数据结构的起始位置。也就是说，遍历器对象本质上，就是一个指针对象。</li><li>第一次调用指针对象的 next 方法，可以将指针指向数据结构的第一个成员。</li><li>第二次调用指针对象的 next 方法，指针就指向数据结构的第二个成员。</li><li>不断调用指针对象的 next 方法，直到它指向数据结构的结束位置。</li></ol><h4 id="Iterator-接口"><a href="#Iterator-接口" class="headerlink" title="Iterator 接口"></a>Iterator 接口</h4><p>一种数据结构只要部署了 Iterator 接口，我们就称这种数据结构是“可遍历的”（iterable）。ES6 规定，默认的 Iterator 接口部署在数据结构的 Symbol.iterator 属性，或者说，一个数据结构只要具有 Symbol.iterator 属性，就可以认为是“可遍历的”（iterable）。Symbol.iterator 属性本身是一个函数，就是当前数据结构默认的遍历器生成函数。执行这个函数，就会返回一个遍历器。</p><h5 id="ES6-原生具备-Iterator-接口的数据结构"><a href="#ES6-原生具备-Iterator-接口的数据结构" class="headerlink" title="ES6 原生具备 Iterator 接口的数据结构"></a>ES6 原生具备 Iterator 接口的数据结构</h5><ul><li>Array</li><li>Map</li><li>Set</li><li>String</li><li>TypedArray</li><li>函数的 arguments 对象</li><li>NodeList 对象</li></ul><h4 id="调用-Iterator-接口的场合"><a href="#调用-Iterator-接口的场合" class="headerlink" title="调用 Iterator 接口的场合"></a>调用 Iterator 接口的场合</h4><ul><li>解构赋值</li><li>扩展运算符</li><li>yield*</li><li>for…of</li><li>Array.from()</li><li>Map(), Set(), WeakMap(), WeakSet()</li><li>Promise.all()</li><li>Promise.race()</li></ul><h4 id="遍历器对象的-return-，throw"><a href="#遍历器对象的-return-，throw" class="headerlink" title="遍历器对象的 return()，throw()"></a>遍历器对象的 return()，throw()</h4><p>遍历器对象除了具有 next()方法，还可以具有 return()方法和 throw()方法。</p><ul><li>如果 for…of 循环提前退出（通常是因为出错，或者有 break 语句），就会调用 return()方法。</li><li>throw()方法主要是配合 Generator 函数使用，一般的遍历器对象用不到这个方法。</li></ul><h3 id="for…in-和-for…of-的区别"><a href="#for…in-和-for…of-的区别" class="headerlink" title="for…in 和 for…of 的区别"></a>for…in 和 for…of 的区别</h3><ul><li>对于普通的对象，for…in 循环可以遍历键名，for…of 循环会报错。</li></ul><h4 id="for…in-遍历数组的缺点"><a href="#for…in-遍历数组的缺点" class="headerlink" title="for…in 遍历数组的缺点"></a>for…in 遍历数组的缺点</h4><ul><li>数组的键名是数字，但是 for…in 循环是以字符串作为键名“0”、“1”、“2”等等。</li><li>for…in 循环不仅遍历数字键名，还会遍历手动添加的其他键，甚至包括原型链上的键。</li><li>某些情况下，for…in 循环会以任意顺序遍历键名。</li></ul><h4 id="for…of-遍历数组的优点"><a href="#for…of-遍历数组的优点" class="headerlink" title="for…of 遍历数组的优点"></a>for…of 遍历数组的优点</h4><ul><li>有着同 for…in 一样的简洁语法，但是没有 for…in 那些缺点</li><li>不同于 forEach 方法，它可以与 break、continue 和 return 配合使用。</li><li>提供了遍历所有数据结构的统一操作接口。</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;Iterator（遍历器）的概念&quot;&gt;&lt;a href=&quot;#Iterator（遍历器）的概念&quot; class=&quot;headerlink&quot; title=&quot;Iterator（遍历器）的概念&quot;&gt;&lt;/a&gt;Iterator（遍历器）的概念&lt;/h3&gt;&lt;p&gt;遍历器（Iterator）一
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>异步任务按顺序分组执行</title>
    <link href="http://yoursite.com/2020/10/19/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E6%8C%89%E9%A1%BA%E5%BA%8F%E5%88%86%E7%BB%84%E6%89%A7%E8%A1%8C/"/>
    <id>http://yoursite.com/2020/10/19/异步任务按顺序分组执行/</id>
    <published>2020-10-18T16:39:31.000Z</published>
    <updated>2020-10-18T08:53:13.181Z</updated>
    
    <content type="html"><![CDATA[<h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>有一个异步请求列表需要按照顺序分多次执行</p><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>任务可以放入一个队列中，每次从队列中获取若干任务异步执行</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>一次执行的任务放在 Promise.all 中执行，但是如果执行任务中有一个任务花费时间比较长，其它任务消耗时间短就浪费了大量时间，所以采用计数的方式判断是否可以把任务加入任务队列</p><h4 id="代码流程"><a href="#代码流程" class="headerlink" title="代码流程"></a>代码流程</h4><ol><li>构建任务队列</li><li>需要执行的任务放入队列</li><li>执行任务，判断是否有任务可以执行，若有任务可以执行，则正在执行的任务队列加一</li><li>任务执行完毕之后，再回到第 3 部，直至待执行任务队列和当前执行的任务为空时退出程序</li></ol><h4 id="具体-js-代码如下"><a href="#具体-js-代码如下" class="headerlink" title="具体 js 代码如下"></a>具体 js 代码如下</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(maxTask) &#123;</span><br><span class="line">    <span class="keyword">this</span>.maxTask = maxTask</span><br><span class="line">    <span class="keyword">this</span>.runningTask = <span class="number">0</span></span><br><span class="line">    <span class="keyword">this</span>.taskQueue = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  push(task) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(task)) &#123;</span><br><span class="line">      task.forEach(<span class="function">(<span class="params">t</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.taskQueue.push(t)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.taskQueue.push(task)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.run()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> runTask(task) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.runningTask++</span><br><span class="line">      <span class="keyword">await</span> task()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(e)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.run()</span><br><span class="line">      <span class="keyword">this</span>.runningTask--</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  run() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.canRunTask()) &#123;</span><br><span class="line">      <span class="keyword">const</span> task = <span class="keyword">this</span>.taskQueue.shift()</span><br><span class="line">      <span class="keyword">this</span>.runTask(task)</span><br><span class="line">      <span class="keyword">this</span>.run()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  canRunTask() &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">this</span>.isEmpty() &amp;&amp; <span class="keyword">this</span>.runningTask &lt; <span class="keyword">this</span>.maxTask</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isEmpty() &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">this</span>.taskQueue.length</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> taskQueue = <span class="keyword">new</span> Queue(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timeList = [<span class="number">100</span>, <span class="number">300</span>, <span class="number">500</span>, <span class="number">900</span>, <span class="number">600</span>]</span><br><span class="line"><span class="keyword">const</span> taskList = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">20</span>).fill(<span class="number">0</span>).map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> time = index % timeList.length</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'task '</span>, index, <span class="string">'time '</span>, timeList[time], <span class="string">'start'</span>)</span><br><span class="line">      <span class="keyword">const</span> timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        clearTimeout(timer)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'task '</span>, index, <span class="string">'time '</span>, timeList[time], <span class="string">'finished'</span>)</span><br><span class="line">        <span class="keyword">if</span> (index % <span class="number">5</span> === <span class="number">0</span>) &#123;</span><br><span class="line">          reject(<span class="string">'error'</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve(<span class="string">'success'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, timeList[time])</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">taskQueue.push(taskList)</span><br></pre></td></tr></table></figure><h3 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h3><ul><li><a href="https://github.com/JackXuyi/web-exercise/blob/master/algorithm/queue.js" target="_blank" rel="noopener">源码参考</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h3&gt;&lt;p&gt;有一个异步请求列表需要按照顺序分多次执行&lt;/p&gt;
&lt;h3 id=&quot;分析&quot;&gt;&lt;a href=&quot;#分析&quot; class=&quot;head
      
    
    </summary>
    
    
      <category term="算法" scheme="http://yoursite.com/tags/solution/"/>
    
  </entry>
  
  <entry>
    <title>三数之和</title>
    <link href="http://yoursite.com/2020/09/23/%E4%B8%89%E6%95%B0%E4%B9%8B%E5%92%8C/"/>
    <id>http://yoursite.com/2020/09/23/三数之和/</id>
    <published>2020-09-22T20:52:19.000Z</published>
    <updated>2020-09-22T13:05:11.776Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://leetcode-cn.com/problems/3sum/" target="_blank" rel="noopener">leetcode 算法题</a></p><h3 id="暴力求解"><a href="#暴力求解" class="headerlink" title="暴力求解"></a>暴力求解</h3><p>三层循环遍历数组把符合条件的数据放入数组之中，然后再去重，时间复杂度 n<em>n</em>n 再加去重时间</p><h3 id="优化暴力求解"><a href="#优化暴力求解" class="headerlink" title="优化暴力求解"></a>优化暴力求解</h3><p>数组排序，然后遍历数组，把数据放入对象中去重，避免最后的去重操作，时间复杂度 n<em>n</em>n</p><h3 id="双指针方法"><a href="#双指针方法" class="headerlink" title="双指针方法"></a>双指针方法</h3><p>数组进行排序，然后外层循环固定一个数，内层使用两个指针分别指向数组的左右两边，如果三数之和小于 0 则把左边指针右移，若果三数之和大于 0 则把右边指针左移，等于 0 时判断数组是否已经存在结果数组中，若存在则跳过，不存在放入数组并在 map 中标记</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> threeSum = <span class="function"><span class="keyword">function</span> (<span class="params">nums</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> sortNums = nums.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b)</span><br><span class="line">  <span class="keyword">const</span> len = sortNums.length</span><br><span class="line">  <span class="keyword">const</span> result = []</span><br><span class="line">  <span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len - <span class="number">2</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> left = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> right = len - <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (left &lt; right) &#123;</span><br><span class="line">      <span class="keyword">if</span> (sortNums[i] + sortNums[left] + sortNums[right] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        right = right - <span class="number">1</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sortNums[i] + sortNums[left] + sortNums[right] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        left = left + <span class="number">1</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sortNums[i] + sortNums[left] + sortNums[right] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!obj[<span class="string">`<span class="subst">$&#123;sortNums[i]&#125;</span>,<span class="subst">$&#123;sortNums[left]&#125;</span>,<span class="subst">$&#123;sortNums[right]&#125;</span>`</span>]) &#123;</span><br><span class="line">          result.push([sortNums[i], sortNums[left], sortNums[right]])</span><br><span class="line">          obj[<span class="string">`<span class="subst">$&#123;sortNums[i]&#125;</span>,<span class="subst">$&#123;sortNums[left]&#125;</span>,<span class="subst">$&#123;sortNums[right]&#125;</span>`</span>] = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        left = left + <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://leetcode-cn.com/problems/3sum/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;leetcode 算法题&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;暴力求解&quot;&gt;&lt;a href=&quot;#暴力求解&quot; class=
      
    
    </summary>
    
    
      <category term="算法" scheme="http://yoursite.com/tags/solution/"/>
    
  </entry>
  
  <entry>
    <title>antd中遇到的问题（一）</title>
    <link href="http://yoursite.com/2020/09/21/antd%E4%B8%AD%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://yoursite.com/2020/09/21/antd中遇到的问题（一）/</id>
    <published>2020-09-20T22:42:42.000Z</published>
    <updated>2020-09-22T12:51:25.922Z</updated>
    
    <content type="html"><![CDATA[<h3 id="antd-v4-版本中-Form-Item-子组件-value-不生效问题"><a href="#antd-v4-版本中-Form-Item-子组件-value-不生效问题" class="headerlink" title="antd v4 版本中 Form.Item 子组件 value 不生效问题"></a>antd v4 版本中 Form.Item 子组件 value 不生效问题</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>在 <code>Form.Item</code> 中使用 <code>Input</code> 输入框设置 <code>value</code> 时发现其不生效，查看使用文档也没有发现问题</p><h4 id="猜测"><a href="#猜测" class="headerlink" title="猜测"></a>猜测</h4><p><code>Form.Item</code> 对子组件的 <code>value</code> 属性做了劫持，导致手动设置的 <code>value</code> 被覆盖</p><h4 id="代码验证"><a href="#代码验证" class="headerlink" title="代码验证"></a>代码验证</h4><ol><li>通过查找 <code>return</code> 语句，发现执行了 <code>renderLayout</code> 这个方法</li><li>查看 <code>renderLayout</code> 的具体实现子组件实际渲染的是方法的实际参数 <code>baseChildren</code></li><li>查看 <code>renderLayout</code> 的调用发现在 <code>!hasName &amp;&amp; !isRenderProps &amp;&amp; !dependencies</code> 才会直接渲染子组件，其它情况会注入 <code>value</code> 等属性</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 先执行</span><br><span class="line">if (!hasName &amp;&amp; !isRenderProps &amp;&amp; !dependencies) &#123;</span><br><span class="line">  return renderLayout(children)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 再执行</span><br><span class="line">if (React.isValidElement(children)) &#123;</span><br><span class="line">  childNode = (</span><br><span class="line">    &lt;MemoInput</span><br><span class="line">      value=&#123;mergedControl[props.valuePropName || &apos;value&apos;]&#125;</span><br><span class="line">      update=&#123;updateRef.current&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &#123;React.cloneElement(children, childProps)&#125;</span><br><span class="line">    &lt;/MemoInput&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h4><p>去除 <code>Form.Item</code> 中的 <code>name</code> 属性，验证 <code>value</code> 属性生效</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;antd-v4-版本中-Form-Item-子组件-value-不生效问题&quot;&gt;&lt;a href=&quot;#antd-v4-版本中-Form-Item-子组件-value-不生效问题&quot; class=&quot;headerlink&quot; title=&quot;antd v4 版本中 Form.I
      
    
    </summary>
    
    
      <category term="react" scheme="http://yoursite.com/tags/react/"/>
    
      <category term="antd" scheme="http://yoursite.com/tags/antd/"/>
    
  </entry>
  
  <entry>
    <title>mysql数据库操作（二）</title>
    <link href="http://yoursite.com/2020/09/14/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    <id>http://yoursite.com/2020/09/14/mysql数据库操作（二）/</id>
    <published>2020-09-13T22:50:06.000Z</published>
    <updated>2020-09-22T12:51:25.923Z</updated>
    
    <content type="html"><![CDATA[<h3 id="express-中使用-TypeORM-连接-mysql-数据库"><a href="#express-中使用-TypeORM-连接-mysql-数据库" class="headerlink" title="express 中使用 TypeORM 连接 mysql 数据库"></a>express 中使用 TypeORM 连接 mysql 数据库</h3><h4 id="TypeORM-介绍"><a href="#TypeORM-介绍" class="headerlink" title="TypeORM 介绍"></a>TypeORM 介绍</h4><p>TypeORM 是一个采用 TypeScript 编写的用于 Node.js 的优秀 ORM 框架，支持使用 TypeScript 或 Javascript(ES5, ES6, ES7)开发。</p><ul><li><a href="https://cloud.tencent.com/developer/article/1012625" target="_blank" rel="noopener">Nodejs 最好的 ORM - TypeORM</a></li><li><a href="https://github.com/typeorm/typeorm" target="_blank" rel="noopener">github 链接</a></li></ul><h4 id="express-中使用"><a href="#express-中使用" class="headerlink" title="express 中使用"></a>express 中使用</h4><h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><p><code>yarn add typeorm mysql</code></p><h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> express, &#123; Request, Response &#125; <span class="keyword">from</span> <span class="string">'express'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createConnection &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> createConnection(config.db)</span><br><span class="line">  .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> app = express()</span><br><span class="line">    app.listen(port, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      info(</span><br><span class="line">        <span class="string">`the server is start at port <span class="subst">$&#123;port&#125;</span>, listening on http://localhost:<span class="subst">$&#123;port&#125;</span>`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'connection mysql error: '</span>, e.message)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; getRepository &#125; <span class="keyword">from</span> <span class="string">'typeorm'</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getList</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [list, total] = <span class="keyword">await</span> getRepository(Entity).findAndCount()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;express-中使用-TypeORM-连接-mysql-数据库&quot;&gt;&lt;a href=&quot;#express-中使用-TypeORM-连接-mysql-数据库&quot; class=&quot;headerlink&quot; title=&quot;express 中使用 TypeORM 连接 mysql
      
    
    </summary>
    
    
      <category term="node" scheme="http://yoursite.com/tags/node/"/>
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
      <category term="express" scheme="http://yoursite.com/tags/express/"/>
    
      <category term="TypeORM" scheme="http://yoursite.com/tags/TypeORM/"/>
    
  </entry>
  
  <entry>
    <title>mysql数据库操作</title>
    <link href="http://yoursite.com/2020/09/14/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>http://yoursite.com/2020/09/14/mysql数据库操作（一）/</id>
    <published>2020-09-13T22:21:24.000Z</published>
    <updated>2020-09-13T14:49:30.815Z</updated>
    
    <content type="html"><![CDATA[<h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><p><code>CREATE USER &#39;username&#39;@&#39;host&#39; IDENTIFIED BY &#39;password&#39;;</code></p><ul><li><code>host</code> 代表可以登录地址，<code>%</code> 表示任意地址</li><li>可选选项 <code>WITH mysql_native_password</code> 语句表示密码的存储方式</li></ul><h3 id="修改用户密码"><a href="#修改用户密码" class="headerlink" title="修改用户密码"></a>修改用户密码</h3><p><code>ALTER USER &#39;username&#39;@&#39;host&#39; IDENTIFIED WITH mysql_native_password BY &#39;password&#39;;</code></p><h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p><code>grant 权限 privileges on dbName.数据表 to &#39;tools&#39;;</code></p><ul><li>权限包括增删查改，<code>all</code> 代表所有权限</li><li>数据库和数据表可以用 <code>*</code> 表示通配</li></ul><h3 id="刷新权限"><a href="#刷新权限" class="headerlink" title="刷新权限"></a>刷新权限</h3><p><code>FLUSH PRIVILEGES;</code></p><ul><li>数据权限并不会自动更新，需要手动执行命令才会刷新</li></ul><h3 id="查看列表数据库"><a href="#查看列表数据库" class="headerlink" title="查看列表数据库"></a>查看列表数据库</h3><p><code>show databases;</code></p><h3 id="查看数据表的结构"><a href="#查看数据表的结构" class="headerlink" title="查看数据表的结构"></a>查看数据表的结构</h3><p><code>desc 数据库.数据表;</code></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;创建用户&quot;&gt;&lt;a href=&quot;#创建用户&quot; class=&quot;headerlink&quot; title=&quot;创建用户&quot;&gt;&lt;/a&gt;创建用户&lt;/h3&gt;&lt;p&gt;&lt;code&gt;CREATE USER &amp;#39;username&amp;#39;@&amp;#39;host&amp;#39; IDENTIFIED
      
    
    </summary>
    
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>浏览器缓存</title>
    <link href="http://yoursite.com/2020/08/31/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98/"/>
    <id>http://yoursite.com/2020/08/31/浏览器缓存/</id>
    <published>2020-08-30T21:35:19.000Z</published>
    <updated>2020-09-13T14:19:41.464Z</updated>
    
    <content type="html"><![CDATA[<h3 id="缓存分类"><a href="#缓存分类" class="headerlink" title="缓存分类"></a>缓存分类</h3><ul><li>共享缓存：存储的响应能够被多个用户使用。</li><li>私有缓存：只能用于单独用户。</li></ul><h3 id="缓存方式"><a href="#缓存方式" class="headerlink" title="缓存方式"></a>缓存方式</h3><ul><li>浏览器与代理缓存</li><li>网关缓存</li><li>CDN</li><li>反向代理缓存和负载均衡器</li></ul><h3 id="操作的目标"><a href="#操作的目标" class="headerlink" title="操作的目标"></a>操作的目标</h3><p>常见的 HTTP 缓存只能存储 GET 响应，对于其他类型的响应则无能为力。缓存的关键主要包括 request method 和目标 URI（一般只有 GET 请求才会被缓存）。</p><h3 id="缓存控制"><a href="#缓存控制" class="headerlink" title="缓存控制"></a>缓存控制</h3><h4 id="没有缓存"><a href="#没有缓存" class="headerlink" title="没有缓存"></a>没有缓存</h4><p>缓存中不得存储任何关于客户端请求和服务端响应的内容。每次由客户端发起的请求都会下载完整的响应内容。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: no-store</span><br></pre></td></tr></table></figure><h4 id="缓存但重新验证"><a href="#缓存但重新验证" class="headerlink" title="缓存但重新验证"></a>缓存但重新验证</h4><p>每次有请求发出时，缓存会将此请求发到服务器，服务器端会验证请求中所描述的缓存是否过期，若未过期，则缓存才使用本地缓存副本。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: no-cache</span><br></pre></td></tr></table></figure><h4 id="私有和公共缓存"><a href="#私有和公共缓存" class="headerlink" title="私有和公共缓存"></a>私有和公共缓存</h4><ul><li>“public” 指令表示该响应可以被任何中间人（译者注：比如中间代理、CDN 等）缓存。</li><li>“private” 则表示该响应是专用于某单个用户的，中间人不能缓存此响应，该响应只能应用于浏览器私有缓存中。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: private</span><br><span class="line">Cache-Control: public</span><br></pre></td></tr></table></figure><h4 id="过期"><a href="#过期" class="headerlink" title="过期"></a>过期</h4><p>过期机制中，最重要的指令是 “max-age=<seconds>“，表示资源能够被缓存（保持新鲜）的最大时间。相对 Expires 而言，max-age 是距离请求发起的时间的秒数。针对应用中那些不会改变的文件，通常可以手动设置一定的时长以保证缓存有效，例如图片、css、js 等静态资源。</seconds></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: max-age=31536000</span><br></pre></td></tr></table></figure><h4 id="验证方式"><a href="#验证方式" class="headerlink" title="验证方式"></a>验证方式</h4><p>当使用了 “must-revalidate” 指令，那就意味着缓存在考虑使用一个陈旧的资源时，必须先验证它的状态，已过期的缓存将不被使用。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: must-revalidate</span><br></pre></td></tr></table></figure><h3 id="Pragma-头"><a href="#Pragma-头" class="headerlink" title="Pragma 头"></a>Pragma 头</h3><p>Pragma 是 HTTP/1.0 标准中定义的一个 header 属性，请求中包含 Pragma 的效果跟在头信息中定义 Cache-Control: no-cache 相同，但是 HTTP 的响应头没有明确定义这个属性，所以它不能拿来完全替代 HTTP/1.1 中定义的 Cache-control 头。通常定义 Pragma 以向后兼容基于 HTTP/1.0 的客户端。</p><h3 id="新鲜度"><a href="#新鲜度" class="headerlink" title="新鲜度"></a>新鲜度</h3><p>理论上来讲，当一个资源被缓存存储后，该资源应该可以被永久存储在缓存中。</p><h4 id="缓存驱逐"><a href="#缓存驱逐" class="headerlink" title="缓存驱逐"></a>缓存驱逐</h4><p>由于缓存只有有限的空间用于存储资源副本，所以缓存会定期地将一些副本删除。当服务器上面的资源进行了更新，那么缓存中的对应资源也应该被更新，由于 HTTP 是 C/S 模式的协议，服务器更新一个资源时，不可能直接通知客户端更新缓存，所以双方必须为该资源约定一个过期时间，在该过期时间之前，该资源（缓存副本）就是新鲜的，当过了过期时间后，该资源（缓存副本）则变为陈旧的。驱逐算法用于将陈旧的资源（缓存副本）替换为新鲜的，注意，一个陈旧的资源（缓存副本）是不会直接被清除或忽略的，当客户端发起一个请求时，缓存检索到已有一个对应的陈旧资源（缓存副本），则缓存会先将此请求附加一个 If-None-Match 头，然后发给目标服务器，以此来检查该资源副本是否是依然还是算新鲜的，若服务器返回了 304 (Not Modified)（该响应不会有带有实体信息），则表示此资源副本是新鲜的，这样一来，可以节省一些带宽。若服务器通过 If-None-Match 或 If-Modified-Since 判断后发现已过期，那么会带有该资源的实体内容返回。<br><img src="/images/js/cache.png" alt="缓存驱逐过程"></p><h5 id="缓存的先后顺序"><a href="#缓存的先后顺序" class="headerlink" title="缓存的先后顺序"></a>缓存的先后顺序</h5><p>对于含有特定头信息的请求，会去计算缓存寿命。</p><ul><li>max-age：Cache-control: max-age=N 的头，相应的缓存的寿命就是 N。</li><li>expires：通过比较 Expires 的值和头里面 Date 属性的值来判断是否缓存还有效。</li><li>Last-Modified： 缓存的寿命就等于头里面 Date 的值减去 Last-Modified 的值除以 10（注：根据 rfc2626 其实也就是乘以 10%）</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">expirationTime = responseTime + freshnessLifetime - currentAge</span><br></pre></td></tr></table></figure><h6 id="注：responseTime-表示浏览器接收到此响应的那个时间点。"><a href="#注：responseTime-表示浏览器接收到此响应的那个时间点。" class="headerlink" title="注：responseTime 表示浏览器接收到此响应的那个时间点。"></a>注：responseTime 表示浏览器接收到此响应的那个时间点。</h6><h3 id="缓存验证"><a href="#缓存验证" class="headerlink" title="缓存验证"></a>缓存验证</h3><p>用户点击刷新按钮时会开始缓存验证。</p><ul><li>如果缓存的响应头信息里含有”Cache-control: must-revalidate”的定义，在浏览的过程中也会触发缓存验证。</li><li>在浏览器偏好设置里设置 Advanced-&gt;Cache 为强制验证缓存也能达到相同的效果。</li></ul><p>当缓存的文档过期后，需要进行缓存验证或者重新获取资源。只有在服务器返回强校验器或者弱校验器时才会进行验证。</p><h4 id="ETags"><a href="#ETags" class="headerlink" title="ETags"></a>ETags</h4><ul><li>作为缓存的一种强校验器，ETag 响应头是一个对用户代理(User Agent, 下面简称 UA)不透明（译者注：UA 无需理解，只需要按规定使用即可）的值。对于像浏览器这样的 HTTP UA，不知道 ETag 代表什么，不能预测它的值是多少。如果资源请求的响应头里含有 ETag, 客户端可以在后续的请求的头中带上 If-None-Match 头来验证缓存。</li><li>Last-Modified 响应头可以作为一种弱校验器。说它弱是因为它只能精确到一秒。如果响应头里含有这个信息，客户端可以在后续的请求中带上 If-Modified-Since 来验证缓存。</li></ul><p>当向服务端发起缓存校验的请求时，服务端会返回 200 ok 表示返回正常的结果或者 304 Not Modified(不返回 body)表示浏览器可以使用本地缓存文件。304 的响应头也可以同时更新缓存文档的过期时间。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;缓存分类&quot;&gt;&lt;a href=&quot;#缓存分类&quot; class=&quot;headerlink&quot; title=&quot;缓存分类&quot;&gt;&lt;/a&gt;缓存分类&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;共享缓存：存储的响应能够被多个用户使用。&lt;/li&gt;
&lt;li&gt;私有缓存：只能用于单独用户。&lt;/li&gt;
&lt;/ul&gt;

      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>babel编译过程</title>
    <link href="http://yoursite.com/2020/08/30/babel%E7%BC%96%E8%AF%91%E8%BF%87%E7%A8%8B/"/>
    <id>http://yoursite.com/2020/08/30/babel编译过程/</id>
    <published>2020-08-30T15:23:25.000Z</published>
    <updated>2020-09-13T14:19:41.460Z</updated>
    
    <content type="html"><![CDATA[<h3 id="编译步骤"><a href="#编译步骤" class="headerlink" title="编译步骤"></a>编译步骤</h3><p>Babel 编译文件的主要处理步骤依次是：解析（parse）、转换（transform）、生成（generate）。</p><ul><li>解析：解析步骤主要是接受源代码并输出抽象语法树（AST）。此步骤主要由@babel/parser（原 Babylon）负责解析和理解 js 代码，输出对应的 AST。</li><li>转换：转换步骤主要是接受 AST，并对其进行遍历，在此过程中会进行分析和修改 AST，这也是 Babel 插件主要工作的地方。此步骤主要用到@babel/traverse 和@babel/types 两个包。</li><li>生成：生成步骤主要是将（经过一系列转换之后的）AST 再转换为正常的字符串代码。此步骤主要由@babel/generator 深度优先遍历整个 AST，然后构建可以表示转换后代码的字符串。</li></ul><h5 id="注：AST-其实是一个每个节点包含特定属性的对象树"><a href="#注：AST-其实是一个每个节点包含特定属性的对象树" class="headerlink" title="注：AST 其实是一个每个节点包含特定属性的对象树"></a>注：AST 其实是一个每个节点包含特定属性的对象树</h5><h3 id="实现-babel-的编译过程"><a href="#实现-babel-的编译过程" class="headerlink" title="实现 babel 的编译过程"></a>实现 babel 的编译过程</h3><ul><li>使用 <code>@babel/parser</code> 把代码格式化为 <code>AST</code> 树</li><li>使用 <code>@babel/traverse</code> 和 <code>@babel/types</code> 实现 <code>AST</code> 树的遍历及对树的特定节点的操作</li><li>使用 <code>@babel/generator</code> 生成目标代码</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parser = <span class="built_in">require</span>(<span class="string">'@babel/parser'</span>)</span><br><span class="line"><span class="keyword">const</span> traverse = <span class="built_in">require</span>(<span class="string">'@babel/traverse'</span>).default</span><br><span class="line"><span class="keyword">const</span> type = <span class="built_in">require</span>(<span class="string">'@babel/types'</span>)</span><br><span class="line"><span class="keyword">const</span> generate = <span class="built_in">require</span>(<span class="string">'@babel/generator'</span>).default</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">function test(n)&#123;</span></span><br><span class="line"><span class="string">    return n + 1</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> ast = parser.parse(code, &#123; <span class="attr">sourceType</span>: <span class="string">'module'</span> &#125;) <span class="comment">// 把代码格式化为 AST 树</span></span><br><span class="line"></span><br><span class="line">traverse(ast, &#123;</span><br><span class="line">  <span class="comment">// 遍历 AST 树并进行操作</span></span><br><span class="line">  enter(path) &#123;</span><br><span class="line">    <span class="comment">// 从根节点到叶子节点遍历过程中</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'enter'</span>, path.node.name)</span><br><span class="line">    <span class="keyword">if</span> (type.isIdentifier(path.node, &#123; <span class="attr">name</span>: <span class="string">'n'</span> &#125;)) &#123;</span><br><span class="line">      <span class="comment">// 把参数 n 转化成 x</span></span><br><span class="line">      path.replaceWith(type.identifier(<span class="string">'x'</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  exit(path) &#123;</span><br><span class="line">    <span class="comment">// 从叶子节点到根节点遍历过程中</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'exit'</span>, path.node.name)</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> target = generate(ast) <span class="comment">// 生成代码</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(target.code)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">function test(x) &#123;</span></span><br><span class="line"><span class="comment">  return x + 1;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/plugin-handbook.md#toc-writing-your-first-babel-plugin" target="_blank" rel="noopener">Babel 插件手册</a></li><li><a href="https://github.com/Liaoct/blog/issues/14" target="_blank" rel="noopener">Babel 7 插件开发指南</a></li><li><a href="https://github.com/JackXuyi/web-exercise/blob/master/babel/test.js" target="_blank" rel="noopener">示例代码</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;编译步骤&quot;&gt;&lt;a href=&quot;#编译步骤&quot; class=&quot;headerlink&quot; title=&quot;编译步骤&quot;&gt;&lt;/a&gt;编译步骤&lt;/h3&gt;&lt;p&gt;Babel 编译文件的主要处理步骤依次是：解析（parse）、转换（transform）、生成（generate）。&lt;/p&gt;
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>ES6模块与CommonJS模块</title>
    <link href="http://yoursite.com/2020/08/27/ES6%E6%A8%A1%E5%9D%97%E4%B8%8ECommonJS%E6%A8%A1%E5%9D%97/"/>
    <id>http://yoursite.com/2020/08/27/ES6模块与CommonJS模块/</id>
    <published>2020-08-26T21:09:40.000Z</published>
    <updated>2021-01-17T14:59:28.314Z</updated>
    
    <content type="html"><![CDATA[<h3 id="ES6-模块与-CommonJS-模块的区别"><a href="#ES6-模块与-CommonJS-模块的区别" class="headerlink" title="ES6 模块与 CommonJS 模块的区别"></a>ES6 模块与 CommonJS 模块的区别</h3><ul><li>CommonJS 模块输出的是一个值的拷贝，ES6 模块输出的是值的引用。</li><li>CommonJS 模块是运行时加载，ES6 模块是编译时输出接口。（因为 CommonJS 加载的是一个对象（即 module.exports 属性），该对象只有在脚本运行完才会生成。而 ES6 模块不是对象，它的对外接口只是一种静态定义，在代码静态解析阶段就会生成。）</li><li>CommonJS 模块的 require()是同步加载模块，ES6 模块的 import 命令是异步加载，有一个独立模块依赖的解析阶段。</li></ul><h4 id="ES6-模块输出的是值的引用"><a href="#ES6-模块输出的是值的引用" class="headerlink" title="ES6 模块输出的是值的引用"></a>ES6 模块输出的是值的引用</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.mjs</span></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  count = count + <span class="number">1</span></span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123; count &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.mjs</span></span><br><span class="line"><span class="keyword">import</span> &#123; count &#125; <span class="keyword">from</span> <span class="string">'./lib.mjs'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'count'</span>, count) <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timeout count'</span>, count) <span class="comment">// 2</span></span><br><span class="line">&#125;, <span class="number">1100</span>)</span><br><span class="line"></span><br><span class="line">count = <span class="number">1000</span> <span class="comment">// TypeError: Assignment to constant variable.</span></span><br></pre></td></tr></table></figure><h4 id="CommonJS-模块输出的是一个值的拷贝"><a href="#CommonJS-模块输出的是一个值的拷贝" class="headerlink" title="CommonJS 模块输出的是一个值的拷贝"></a>CommonJS 模块输出的是一个值的拷贝</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.cjs</span></span><br><span class="line"><span class="keyword">let</span> count = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  count = count + <span class="number">1</span></span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123; count &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.cjs</span></span><br><span class="line"><span class="keyword">let</span> &#123; count &#125; = <span class="built_in">require</span>(<span class="string">'./lib.cjs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'count'</span>, count) <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timeout count'</span>, count) <span class="comment">// 1000</span></span><br><span class="line">&#125;, <span class="number">1100</span>)</span><br><span class="line"></span><br><span class="line">count = <span class="number">1000</span></span><br></pre></td></tr></table></figure><h5 id="注"><a href="#注" class="headerlink" title="注"></a>注</h5><ul><li>从 Node.js v13.2 版本开始，Node.js 已经默认打开了 ES6 模块支持</li><li>Node.js 要求 ES6 模块采用.mjs 后缀文件名</li><li>commonjs 模块采用.cjs 后缀文件名</li></ul><h3 id="循环引用"><a href="#循环引用" class="headerlink" title="循环引用"></a>循环引用</h3><p>“循环加载”（circular dependency）指的是，a 脚本的执行依赖 b 脚本，而 b 脚本的执行又依赖 a 脚本。</p><h4 id="CommonJS-模块的循环加载"><a href="#CommonJS-模块的循环加载" class="headerlink" title="CommonJS 模块的循环加载"></a>CommonJS 模块的循环加载</h4><p>CommonJS 模块的脚本代码在 require 的时候，就会全部执行，一旦出现某个模块被”循环加载”，就只输出已经执行的部分，还未执行的部分不会输出。</p><h4 id="ES6-模块的循环加载"><a href="#ES6-模块的循环加载" class="headerlink" title="ES6 模块的循环加载"></a>ES6 模块的循环加载</h4><p>ES6 模块遇到模块加载命令 import 时，不会去执行模块，而是只生成一个引用。等到真的需要用到时，再到模块里面去取值，不存在缓存值的问题，而且模块里面的变量，绑定其所在的模块。</p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://es6.ruanyifeng.com/#docs/module-loader#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%8A%A0%E8%BD%BD" target="_blank" rel="noopener">ES6 模块与 CommonJS 模块的差异</a></li><li><a href="https://juejin.cn/post/6844903747290660878" target="_blank" rel="noopener">CommonJS 和 ES6 模块循环加载处理的区别</a></li><li><a href="http://www.ruanyifeng.com/blog/2015/11/circular-dependency.html" target="_blank" rel="noopener">JavaScript 模块的循环加载</a></li><li><a href="https://zhuanlan.zhihu.com/p/322529692" target="_blank" rel="noopener">JavaScript 模块加载与循环引用</a></li><li><a href="https://github.com/JackXuyi/web-exercise/tree/master/verification" target="_blank" rel="noopener">测试代码链接</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;ES6-模块与-CommonJS-模块的区别&quot;&gt;&lt;a href=&quot;#ES6-模块与-CommonJS-模块的区别&quot; class=&quot;headerlink&quot; title=&quot;ES6 模块与 CommonJS 模块的区别&quot;&gt;&lt;/a&gt;ES6 模块与 CommonJS 模块的
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>除自身以外数组的乘积</title>
    <link href="http://yoursite.com/2020/08/17/%E9%99%A4%E8%87%AA%E8%BA%AB%E4%BB%A5%E5%A4%96%E6%95%B0%E7%BB%84%E7%9A%84%E4%B9%98%E7%A7%AF/"/>
    <id>http://yoursite.com/2020/08/17/除自身以外数组的乘积/</id>
    <published>2020-08-16T22:02:53.000Z</published>
    <updated>2020-09-22T12:53:36.019Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://leetcode-cn.com/problems/product-of-array-except-self/" target="_blank" rel="noopener">leetcode 算法题</a></p><h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><ul><li>不要用除法：只能使用乘法</li><li>复杂度为 n ：只能遍历一次或者有限次</li><li>结果：分为左右两部分，可以通过左边的积与右边的积相乘的方式得到结果</li></ul><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;number[]&#125;</span> <span class="variable">nums</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;number[]&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> productExceptSelf = <span class="function"><span class="keyword">function</span> (<span class="params">nums</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> len = nums.length</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">new</span> <span class="built_in">Array</span>(len).fill(<span class="number">1</span>) <span class="comment">// 初始化结果数组</span></span><br><span class="line">  <span class="keyword">let</span> left = <span class="number">1</span></span><br><span class="line">  <span class="keyword">let</span> right = <span class="number">1</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">    result[i] *= left <span class="comment">// 除当前元素的左积</span></span><br><span class="line">    left *= nums[i] <span class="comment">// 当前元素的左积</span></span><br><span class="line"></span><br><span class="line">    result[len - <span class="number">1</span> - i] *= right <span class="comment">// 除当前元素的右积</span></span><br><span class="line">    right *= nums[len - i - <span class="number">1</span>] <span class="comment">// 当前元素的右积</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;a href=&quot;https://leetcode-cn.com/problems/product-of-array-except-self/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;leetcode 算法题&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;分析&quot;&gt;
      
    
    </summary>
    
    
      <category term="算法" scheme="http://yoursite.com/tags/solution/"/>
    
  </entry>
  
  <entry>
    <title>检测项目中的包版本变化</title>
    <link href="http://yoursite.com/2020/08/05/%E6%A3%80%E6%B5%8B%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E5%8C%85%E7%89%88%E6%9C%AC%E5%8F%98%E5%8C%96/"/>
    <id>http://yoursite.com/2020/08/05/检测项目中的包版本变化/</id>
    <published>2020-08-04T21:07:56.000Z</published>
    <updated>2020-09-13T14:19:41.463Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>由于项目中的某个依赖版本意外的升级导致项目中的部分功能不可使用</p><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>每次 <code>package.json</code> 有更新时检测依赖版本是否有更新，小版本更新提示，大版本更新直接警告，避免依赖包的意外升级</p><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><ul><li>git 检测指定文件的内容变更</li><li>正则等方式分割变更内容，提取出对应的信息</li><li>在 node 脚本中运行上述命令</li><li>在 commit 之前检测变更并提示</li></ul><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="提取内容变更"><a href="#提取内容变更" class="headerlink" title="提取内容变更"></a>提取内容变更</h4><ul><li><code>git diff</code> 查看尚未暂存的文件更新了哪些部分</li><li><code>git diff filename</code> 查看尚未暂存的某个文件更新了哪些</li><li><code>git diff –cached</code> 查看已经暂存起来的文件和上次提交的版本之间的差异</li><li><code>git diff –cached filename</code> 查看已经暂存起来的某个文件和上次提交的版本之间的差异</li><li><code>git diff commitHash commitHash</code> 查看某两个版本之间的差异</li><li><code>git diff commitHash:filename commitHash:filename</code> 查看某两个版本的某个文件之间的差异</li></ul><h4 id="node-脚本中运行命令"><a href="#node-脚本中运行命令" class="headerlink" title="node 脚本中运行命令"></a>node 脚本中运行命令</h4><ul><li><a href="http://nodejs.cn/api/child_process.html#child_process_child_process_exec_command_options_callback" target="_blank" rel="noopener">child_process.exec</a>异步执行命令</li><li><a href="http://nodejs.cn/api/child_process.html#child_process_child_process_execsync_command_options" target="_blank" rel="noopener">child_process.execSync</a>同步执行命令</li></ul><h4 id="输出内容"><a href="#输出内容" class="headerlink" title="输出内容"></a>输出内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+  <span class="string">"packageA"</span>: <span class="string">"~x.y.z"</span>,</span><br><span class="line">-  <span class="string">"packageB"</span>: <span class="string">"^x.y.z"</span>,</span><br></pre></td></tr></table></figure><p>观察得出变化内容以 <code>+</code> 或 <code>-</code> 开头，依赖包的格式固定，每行变更内容以换行符分割，所以先用换行符分割内容，再检查 <code>+</code> 和 <code>-</code> 筛选出变化内容，最后用正则等方法分离出依赖包的名称和版本，最后通过前后版本的比较获取变化的包及包版本</p><h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /usr/bin/env node</span></span><br><span class="line"><span class="keyword">const</span> childProcess = <span class="built_in">require</span>(<span class="string">'child_process'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; logger, warn, info &#125; = <span class="built_in">require</span>(<span class="string">'./logger'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resolveRootPath</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> path.resolve(process.cwd(), ...args)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取变化</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getDiff</span>(<span class="params">isCached = false</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = childProcess.execSync(</span><br><span class="line">      <span class="string">`git diff <span class="subst">$&#123;isCached ? <span class="string">'--cached'</span> : <span class="string">''</span>&#125;</span> <span class="subst">$&#123;resolveRootPath(</span></span></span><br><span class="line"><span class="string"><span class="subst">        <span class="string">'./package.json'</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      )&#125;</span>`</span>,</span><br><span class="line">      &#123; <span class="attr">encoding</span>: <span class="string">'utf8'</span> &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 序列化版本为对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">serializeDiff</span>(<span class="params">diffStr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> VERSION_REG = <span class="regexp">/\"\S+\"\s*:\s*\"(~|\-|\^)?(\d+)\.(\d+)\.(\d+)/</span></span><br><span class="line">  <span class="keyword">const</span> arr = <span class="string">`<span class="subst">$&#123;diffStr || <span class="string">''</span>&#125;</span>`</span></span><br><span class="line">    .split(<span class="string">'\n'</span>)</span><br><span class="line">    .filter(<span class="function">(<span class="params">str</span>) =&gt;</span> <span class="regexp">/^(\-|\+)\s+/</span>.test(str))</span><br><span class="line">    .filter(<span class="function">(<span class="params">str</span>) =&gt;</span> VERSION_REG.test(str))</span><br><span class="line">  <span class="keyword">const</span> beforeArr = arr</span><br><span class="line">    .filter(<span class="function">(<span class="params">str</span>) =&gt;</span> <span class="regexp">/^\-\s+/</span>.test(str))</span><br><span class="line">    .map(<span class="function">(<span class="params">str</span>) =&gt;</span> str.replace(<span class="regexp">/^\-\s+/</span>, <span class="string">''</span>))</span><br><span class="line">    .map(<span class="function">(<span class="params">str</span>) =&gt;</span> str.replace(<span class="regexp">/\,$/</span>, <span class="string">''</span>))</span><br><span class="line">  <span class="keyword">const</span> afterArr = arr</span><br><span class="line">    .filter(<span class="function">(<span class="params">str</span>) =&gt;</span> <span class="regexp">/^\+\s+/</span>.test(str))</span><br><span class="line">    .map(<span class="function">(<span class="params">str</span>) =&gt;</span> str.replace(<span class="regexp">/^\+\s+/</span>, <span class="string">''</span>))</span><br><span class="line">    .map(<span class="function">(<span class="params">str</span>) =&gt;</span> str.replace(<span class="regexp">/\,$/</span>, <span class="string">''</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> beforeObj = beforeArr.reduce(<span class="function">(<span class="params">prev, curr</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [key, value] = curr.replace(<span class="regexp">/"/g</span>, <span class="string">''</span>).split(<span class="regexp">/\s*:\s*/</span>)</span><br><span class="line">    prev[key] = value</span><br><span class="line">    <span class="keyword">return</span> prev</span><br><span class="line">  &#125;, &#123;&#125;)</span><br><span class="line">  <span class="keyword">const</span> afterObj = afterArr.reduce(<span class="function">(<span class="params">prev, curr</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [key, value] = curr.replace(<span class="regexp">/"/g</span>, <span class="string">''</span>).split(<span class="regexp">/\s*:\s*/</span>)</span><br><span class="line">    prev[key] = value</span><br><span class="line">    <span class="keyword">return</span> prev</span><br><span class="line">  &#125;, &#123;&#125;)</span><br><span class="line">  <span class="keyword">return</span> [beforeObj, afterObj]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getChange</span>(<span class="params">before, after</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> beforeKeys = <span class="built_in">Object</span>.keys(before)</span><br><span class="line">  <span class="keyword">const</span> afterKeys = <span class="built_in">Object</span>.keys(after)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> deletePackage = beforeKeys</span><br><span class="line">    .filter(<span class="function">(<span class="params">key</span>) =&gt;</span> !after[key])</span><br><span class="line">    .map(<span class="function">(<span class="params">key</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;after[key]&#125;</span>`</span>)</span><br><span class="line">  <span class="keyword">const</span> addPackage = afterKeys</span><br><span class="line">    .filter(<span class="function">(<span class="params">key</span>) =&gt;</span> !before[key])</span><br><span class="line">    .map(<span class="function">(<span class="params">key</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;after[key]&#125;</span>`</span>)</span><br><span class="line">  <span class="keyword">const</span> updatePackage = beforeKeys</span><br><span class="line">    .filter(<span class="function">(<span class="params">key</span>) =&gt;</span> after[key])</span><br><span class="line">    .map(<span class="function">(<span class="params">key</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;before[key]&#125;</span> ===&gt; <span class="subst">$&#123;after[key]&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> waringUpdatePackage = beforeKeys</span><br><span class="line">    .filter(<span class="function">(<span class="params">key</span>) =&gt;</span> after[key])</span><br><span class="line">    .filter(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> beforeVision = <span class="built_in">Number</span>(<span class="regexp">/(~|\-|\^)?(\d+)\./</span>.exec(before[key])[<span class="number">2</span>])</span><br><span class="line">      <span class="keyword">const</span> afterVision = <span class="built_in">Number</span>(<span class="regexp">/(~|\-|\^)?(\d+)\./</span>.exec(after[key])[<span class="number">2</span>])</span><br><span class="line">      <span class="keyword">return</span> beforeVision !== afterVision</span><br><span class="line">    &#125;)</span><br><span class="line">    .map(<span class="function">(<span class="params">key</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;before[key]&#125;</span> ===&gt; <span class="subst">$&#123;after[key]&#125;</span>`</span>)</span><br><span class="line">  <span class="keyword">const</span> outList = [</span><br><span class="line">    &#123;</span><br><span class="line">      label: <span class="string">`此次删除的依赖包有: \n <span class="subst">$&#123;deletePackage.join(<span class="string">'\n'</span>)&#125;</span>`</span>,</span><br><span class="line">      show: !!deletePackage.length,</span><br><span class="line">      log: warn,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      label: <span class="string">`此次新增的依赖包有: \n <span class="subst">$&#123;addPackage.join(<span class="string">'\n'</span>)&#125;</span>`</span>,</span><br><span class="line">      show: !!addPackage.length,</span><br><span class="line">      log: info,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      label: <span class="string">`此次更新的依赖包有: \n <span class="subst">$&#123;updatePackage.join(<span class="string">'\n'</span>)&#125;</span>`</span>,</span><br><span class="line">      show: !!updatePackage.length,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      label: <span class="string">`此次大版本更新的依赖包有: \n <span class="subst">$&#123;waringUpdatePackage.join(<span class="string">'\n'</span>)&#125;</span>`</span>,</span><br><span class="line">      show: !!waringUpdatePackage.length,</span><br><span class="line">      log: warn,</span><br><span class="line">    &#125;,</span><br><span class="line">  ].filter(<span class="function">(<span class="params">item</span>) =&gt;</span> item.show)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (outList.length) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'\n'</span>)</span><br><span class="line">    outList.forEach(<span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; log = logger, label &#125; = item</span><br><span class="line">      log(label)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'\n'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> diffStr = getDiff(<span class="literal">true</span>)</span><br><span class="line"><span class="keyword">const</span> [before, after] = serializeDiff(diffStr)</span><br><span class="line">getChange(before, after)</span><br></pre></td></tr></table></figure><h4 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h4><ul><li>放入 <code>package.json</code> 中每次提交确认变化</li><li>配置提示方式和确认方法等</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h3&gt;&lt;p&gt;由于项目中的某个依赖版本意外的升级导致项目中的部分功能不可使用&lt;/p&gt;
&lt;h3 id=&quot;目的&quot;&gt;&lt;a href=&quot;#目的&quot; class=&quot;h
      
    
    </summary>
    
    
      <category term="node" scheme="http://yoursite.com/tags/node/"/>
    
  </entry>
  
  <entry>
    <title>react16中生命周期hooks</title>
    <link href="http://yoursite.com/2020/08/03/react16%E4%B8%AD%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9Fhooks/"/>
    <id>http://yoursite.com/2020/08/03/react16中生命周期hooks/</id>
    <published>2020-08-02T22:14:27.000Z</published>
    <updated>2020-09-13T14:19:41.463Z</updated>
    
    <content type="html"><![CDATA[<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>react hooks 推出有段时间了，函数式组件越来越多，当函数式组件中需要使用声明周期钩子时就需要自己封装出一些生命周期函数</p><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><p>在函数式组件中如类组件中一样使用生命周期钩子</p><h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ul><li><a href="https://zh-hans.reactjs.org/docs/hooks-effect.html" target="_blank" rel="noopener">Effect Hook</a> 在组件挂载、更新、卸载时都会执行的生命周期钩子</li><li><a href="https://zh-hans.reactjs.org/docs/hooks-reference.html#useref" target="_blank" rel="noopener">useRef</a> 返回一个在组件的整个生命周期内保持不变的 ref 对象</li></ul><h4 id="didMount"><a href="#didMount" class="headerlink" title="didMount"></a>didMount</h4><p>利用 <code>Effect Hook</code> 依赖不变不会再次执行的特性，依赖传入空数组即可实现挂载时执行一次的特性</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useMount = <span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">  useEffect(cb, [])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="update"><a href="#update" class="headerlink" title="update"></a>update</h4><p>利用 <code>useRef</code> 对象在组件的整个生命周期内保持不变的特性，在组件初始化时初始化 ref 对象，判断 ref 对象的状态决定是否执行回调</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useUpdate = <span class="function">(<span class="params">cb, deps</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> ref = useRef(<span class="number">0</span>)</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (ref.current) &#123;</span><br><span class="line">      cb()</span><br><span class="line">    &#125;</span><br><span class="line">    ref.current = ref.current + <span class="number">1</span></span><br><span class="line">  &#125;, deps)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Unmout"><a href="#Unmout" class="headerlink" title="Unmout"></a>Unmout</h4><p>利用 <code>Effect Hook</code> 返回值在组件卸载时执行的特性，在组件初始化时把回调作为其返回值，即可实现卸载执行的特性</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useUnmout = <span class="function">(<span class="params">cb</span>) =&gt;</span> &#123;</span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cb</span><br><span class="line">  &#125;, [])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://github.com/JackXuyi/web-exercise/blob/master/react/src/page/hooks.js" target="_blank" rel="noopener">生命周期 hooks 源码参考</a></li><li><a href="https://zh-hans.reactjs.org/docs/hooks-intro.html" target="_blank" rel="noopener">react hooks</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;概述&quot;&gt;&lt;a href=&quot;#概述&quot; class=&quot;headerlink&quot; title=&quot;概述&quot;&gt;&lt;/a&gt;概述&lt;/h3&gt;&lt;p&gt;react hooks 推出有段时间了，函数式组件越来越多，当函数式组件中需要使用声明周期钩子时就需要自己封装出一些生命周期函数&lt;/p&gt;
&lt;
      
    
    </summary>
    
    
      <category term="react" scheme="http://yoursite.com/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>排列</title>
    <link href="http://yoursite.com/2020/07/27/%E6%8E%92%E5%88%97/"/>
    <id>http://yoursite.com/2020/07/27/排列/</id>
    <published>2020-07-26T21:50:29.000Z</published>
    <updated>2020-09-13T14:19:41.463Z</updated>
    
    <content type="html"><![CDATA[<p>排列，一般地，从 n 个不同元素中取出 m（m≤n）个元素，按照一定的顺序排成一列，叫做从 n 个元素中取出 m 个元素的一个排列(permutation)。特别地，当 m=n 时，这个排列被称作全排列(all permutation)。</p><h3 id="算法实现思路"><a href="#算法实现思路" class="headerlink" title="算法实现思路"></a>算法实现思路</h3><p>此问题可以简化为每次从数组中提取出一个元素，再从剩余元素提取所需的 n-1 个元素</p><h3 id="参考代码"><a href="#参考代码" class="headerlink" title="参考代码"></a>参考代码</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 排列问题可以简化为每次从数组中提取出一个元素</span></span><br><span class="line"><span class="comment"> * 边界处理</span></span><br><span class="line"><span class="comment"> *  1. 当只需要一个元素时返回这个元素的二维数组</span></span><br><span class="line"><span class="comment"> *  2. 其它每次提取一个元素放到数组中即可</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params">arr, restLen</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (arr.length &lt; restLen) &#123;</span><br><span class="line">    <span class="keyword">return</span> []</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> result = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> tempArr = arr.filter(<span class="function">(<span class="params">ele, index</span>) =&gt;</span> i !== index)</span><br><span class="line">    <span class="keyword">let</span> list = []</span><br><span class="line">    <span class="keyword">if</span> (restLen &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">      list = [[arr[i]]]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      list = getData(tempArr, restLen - <span class="number">1</span>).map(<span class="function">(<span class="params">item</span>) =&gt;</span> [arr[i], ...item])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    result = [...result, ...list]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line"><span class="keyword">let</span> list = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= arr.length; i++) &#123;</span><br><span class="line">  list = [...list, ...getData(arr, i)]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'list'</span>, list, list.length)</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://github.com/JackXuyi/web-exercise/blob/master/algorithm/rank.js" target="_blank" rel="noopener">源代码</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;排列，一般地，从 n 个不同元素中取出 m（m≤n）个元素，按照一定的顺序排成一列，叫做从 n 个元素中取出 m 个元素的一个排列(permutation)。特别地，当 m=n 时，这个排列被称作全排列(all permutation)。&lt;/p&gt;
&lt;h3 id=&quot;算法实现思
      
    
    </summary>
    
    
      <category term="算法" scheme="http://yoursite.com/tags/solution/"/>
    
  </entry>
  
  <entry>
    <title>项目脚手架</title>
    <link href="http://yoursite.com/2020/07/25/%E9%A1%B9%E7%9B%AE%E8%84%9A%E6%89%8B%E6%9E%B6/"/>
    <id>http://yoursite.com/2020/07/25/项目脚手架/</id>
    <published>2020-07-25T15:30:03.000Z</published>
    <updated>2020-09-13T14:19:41.465Z</updated>
    
    <content type="html"><![CDATA[<h3 id="构建流程"><a href="#构建流程" class="headerlink" title="构建流程"></a>构建流程</h3><ul><li>检查目录文件</li><li>获取初始化参数（包括项目名称、版本等信息）</li><li>获取项目模板（包括本地模板和 github 模板）</li><li>项目中填充参数生成项目</li></ul><h4 id="检查目录"><a href="#检查目录" class="headerlink" title="检查目录"></a>检查目录</h4><p>递归获取对应文件夹下的文件列表</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traverseDirectory</span>(<span class="params">pathname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> realPath = resolveRootPath(pathname)</span><br><span class="line">  <span class="keyword">if</span> (isDirectory(realPath)) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = []</span><br><span class="line">    <span class="keyword">const</span> list = fs.readdirSync(realPath)</span><br><span class="line">    <span class="keyword">const</span> len = list.length</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> tempPath = path.resolve(pathname, list[i])</span><br><span class="line">      <span class="keyword">if</span> (isDirectory(list[i])) &#123;</span><br><span class="line">        <span class="keyword">const</span> tempArr = traverseDirectory(tempPath)</span><br><span class="line">        result.push(...tempArr)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result.push(tempPath)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="初始化参数"><a href="#初始化参数" class="headerlink" title="初始化参数"></a>初始化参数</h4><p>使用 <code>inquirer</code> 通过提问的方式获取对应的参数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getProjectConfig</span>(<span class="params">pathname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> defaultProjectName = (pathname || process.cwd())</span><br><span class="line">    .split(<span class="regexp">/(\/|\\)/</span>)</span><br><span class="line">    .reverse()</span><br><span class="line">    .filter(<span class="built_in">Boolean</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> answers = <span class="keyword">await</span> inquirer.prompt([</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'name'</span>,</span><br><span class="line">      message: <span class="string">'请输入项目名称'</span>,</span><br><span class="line">      <span class="keyword">default</span>: defaultProjectName,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'version'</span>,</span><br><span class="line">      message: <span class="string">'请输入版本'</span>,</span><br><span class="line">      <span class="keyword">default</span>: <span class="string">'1.0.0'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'author'</span>,</span><br><span class="line">      message: <span class="string">'请输入创建人'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      name: <span class="string">'template'</span>,</span><br><span class="line">      message: <span class="string">'请选择模板'</span>,</span><br><span class="line">      type: <span class="string">'list'</span>,</span><br><span class="line">      choices: <span class="built_in">Object</span>.keys(templateMap).map(<span class="function">(<span class="params">key</span>) =&gt;</span> (&#123;</span><br><span class="line">        key,</span><br><span class="line">        value: key,</span><br><span class="line">        name: templateMap[key].label,</span><br><span class="line">      &#125;)),</span><br><span class="line">    &#125;,</span><br><span class="line">  ])</span><br><span class="line">  <span class="keyword">return</span> answers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="获取项目模板"><a href="#获取项目模板" class="headerlink" title="获取项目模板"></a>获取项目模板</h4><p>通过初始化参数判断使用的模板类型，若为本地模板则返回文件路径，若为 git 仓库模板则先下载保存在临时文件夹下，返回文件路径</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getTemplate</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> temp = templateMap[key]</span><br><span class="line">  <span class="keyword">if</span> (temp &amp;&amp; temp.isGit) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      rm(downloadTempRootPath)</span><br><span class="line">      <span class="keyword">const</span> target = <span class="keyword">await</span> downloadTemplate(temp.path, downloadTempRootPath, &#123;</span><br><span class="line">        clone: <span class="literal">true</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">return</span> target</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      error(<span class="string">'\ngit 拉取模板失败，失败原因：'</span>, e)</span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> temp.path</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="项目中填充参数生成项目"><a href="#项目中填充参数生成项目" class="headerlink" title="项目中填充参数生成项目"></a>项目中填充参数生成项目</h4><p>读取模板文件填充模板</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">generateProject</span>(<span class="params">source, destination, config</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    metalsmith(process.cwd())</span><br><span class="line">      .metadata(config)</span><br><span class="line">      .clean(<span class="literal">false</span>)</span><br><span class="line">      .source(source)</span><br><span class="line">      .destination(destination)</span><br><span class="line">      .use(<span class="function">(<span class="params">files, metalsmith, done</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> meta = metalsmith.metadata()</span><br><span class="line">        <span class="built_in">Object</span>.keys(files).forEach(<span class="function">(<span class="params">fileName</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> t = files[fileName].contents.toString()</span><br><span class="line">          files[fileName].contents = Buffer.from(Handlebars.compile(t)(meta))</span><br><span class="line">        &#125;)</span><br><span class="line">        done()</span><br><span class="line">      &#125;)</span><br><span class="line">      .build(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        rm(process.cwd())</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">          reject(err)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="相关库"><a href="#相关库" class="headerlink" title="相关库"></a>相关库</h3><ul><li><a href="https://github.com/SBoudrias/Inquirer.js#readme" target="_blank" rel="noopener">获取用户输入 inquirer</a></li><li><a href="https://gitlab.com/flippidippi/download-git-repo/-/tree/master" target="_blank" rel="noopener">下载 git 仓库 download-git-repo</a></li><li><a href="https://github.com/sindresorhus/ora" target="_blank" rel="noopener">优化加载过程 ora</a></li><li><a href="https://github.com/segmentio/metalsmith" target="_blank" rel="noopener">metalsmith</a></li><li><a href="https://github.com/handlebars-lang/handlebars.js" target="_blank" rel="noopener">模板文件处理</a></li><li><a href="https://gitee.com/xuyi-emb/node-excel/tree/master/template" target="_blank" rel="noopener">源码参考</a></li></ul><h3 id="todo"><a href="#todo" class="headerlink" title="todo"></a>todo</h3><ul><li>更多模板</li><li>优化模板功能</li><li>package.json 字段详解</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;构建流程&quot;&gt;&lt;a href=&quot;#构建流程&quot; class=&quot;headerlink&quot; title=&quot;构建流程&quot;&gt;&lt;/a&gt;构建流程&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;检查目录文件&lt;/li&gt;
&lt;li&gt;获取初始化参数（包括项目名称、版本等信息）&lt;/li&gt;
&lt;li&gt;获取项目模板（包括
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>滚动加载更多</title>
    <link href="http://yoursite.com/2020/07/25/%E6%BB%9A%E5%8A%A8%E5%8A%A0%E8%BD%BD%E6%9B%B4%E5%A4%9A/"/>
    <id>http://yoursite.com/2020/07/25/滚动加载更多/</id>
    <published>2020-07-25T15:29:30.000Z</published>
    <updated>2021-01-18T09:18:36.142Z</updated>
    
    <content type="html"><![CDATA[<p>当页面数据过多为了优化页面加载速度和避免页面的卡顿时使用滚动加载的方式实现数据的分页加载功能</p><h3 id="加载更多方案"><a href="#加载更多方案" class="headerlink" title="加载更多方案"></a>加载更多方案</h3><h4 id="利用-scroll-事件实现"><a href="#利用-scroll-事件实现" class="headerlink" title="利用 scroll 事件实现"></a>利用 scroll 事件实现</h4><p>通过监听对应元素的滚动，不断计算元素相对窗口的位置判断元素是否滚动到底部，若滚动到底部就加载更多</p><h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><ul><li><code>scroll</code> 事件不断触发需要做节流操作实现</li><li>每次触发事件时都要计算元素的位置性能不好</li></ul><h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><ul><li>兼容性好</li><li>易于实现</li></ul><h4 id="利用-IntersectionObserver-实现"><a href="#利用-IntersectionObserver-实现" class="headerlink" title="利用 IntersectionObserver 实现"></a>利用 <code>IntersectionObserver</code> 实现</h4><p><code>IntersectionObserver</code>接口 (从属于<code>Intersection Observer API</code>) 提供了一种异步观察目标元素与其祖先元素或顶级文档视窗(<code>viewport</code>)交叉状态的方法。</p><h5 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h5><ul><li><code>IntersectionObserver</code> 是浏览器内部实现的方法，性能较高</li><li>可以自定义视窗重叠的阈值</li></ul><h5 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h5><ul><li>兼容性较差</li></ul><h3 id="使用-IntersectionObserver-的一般流程"><a href="#使用-IntersectionObserver-的一般流程" class="headerlink" title="使用 IntersectionObserver 的一般流程"></a>使用 <code>IntersectionObserver</code> 的一般流程</h3><h4 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a>第一步</h4><p>初始化 <code>IntersectionObserver</code>，构建 <code>IntersectionObserver</code> 实例，确定视窗窗口和触发阈值及回调函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ob = <span class="keyword">new</span> IntersectionObserver(callback, options)</span><br></pre></td></tr></table></figure><h5 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h5><h6 id="callback"><a href="#callback" class="headerlink" title="callback"></a>callback</h6><p>当元素可见比例超过指定阈值后，会调用一个回调函数，此回调函数接受两个参数</p><ul><li>entries: 一个 IntersectionObserverEntry 对象的数组，每个被触发的阈值，都或多或少与指定阈值有偏差。</li><li>observer: 被调用的 IntersectionObserver 实例。</li></ul><h6 id="options-可选"><a href="#options-可选" class="headerlink" title="options(可选)"></a>options(可选)</h6><p>一个可以用来配置 observer 实例的对象。如果 options 未指定，observer 实例默认使用文档视口作为 root，并且没有 margin，阈值为 0%（意味着即使一像素的改变都会触发回调函数）。你可以指定以下配置：</p><ul><li>root: 监听元素的祖先元素 Element 对象，其边界盒将被视作视口。目标在根的可见区域的的任何不可见部分都会被视为不可见。</li><li>rootMargin: 一个在计算交叉值时添加至根的边界盒(bounding_box)中的一组偏移量，类型为字符串(string) ，可以有效的缩小或扩大根的判定范围从而满足计算需要。语法大致和 CSS 中的 margin 属性等同; 可以参考 The root element and root margin in Intersection Observer API 来深入了解 margin 的工作原理及其语法。默认值是”0px 0px 0px 0px”。</li><li>threshold: 规定了一个监听目标与边界盒交叉区域的比例值，可以是一个具体的数值或是一组 0.0 到 1.0 之间的数组。若指定值为 0.0，则意味着监听元素即使与根有 1 像素交叉，此元素也会被视为可见. 若指定值为 1.0，则意味着整个元素都是可见的。阈值的默认值为 0.0。</li></ul><h4 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a>第二步</h4><p>调用 <code>observe</code> 观测元素，<code>targetElement</code> 即为观测的元素</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ob.observe(targetElement)</span><br></pre></td></tr></table></figure><h4 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h4><p>调用 <code>unobserve</code> 取消对元素的观测，<code>target</code> 即为取消观测的对象</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ob.unobserve(target)</span><br></pre></td></tr></table></figure><h4 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h4><p>调用 <code>disconnect</code> 终止对所有目标元素可见性变化的观察</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ob.disconnect()</span><br></pre></td></tr></table></figure><h3 id="在-React-中的实现"><a href="#在-React-中的实现" class="headerlink" title="在 React 中的实现"></a>在 <code>React</code> 中的实现</h3><ul><li>初始化 <code>IntersectionObserver</code>，确定视窗窗口和触发阈值及回调函数</li><li>通过 <code>children</code> 属性获取子组件中的最后一个元素</li><li>监听列表中的最后一个组件，当最后的组件触发事件时加载更多</li><li>引入 <code>intersection-observer</code> 组件做兼容性处理</li></ul><h4 id="完整代码参考"><a href="#完整代码参考" class="headerlink" title="完整代码参考"></a>完整代码参考</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">import React from &apos;react&apos;</span><br><span class="line">import &apos;intersection-observer&apos;</span><br><span class="line"></span><br><span class="line">interface IProps extends React.DOMAttributes&lt;HTMLDivElement&gt; &#123;</span><br><span class="line">  children: any</span><br><span class="line">  getRootElement?: (parent: Element) =&gt; Element</span><br><span class="line">  rootMargin?: string</span><br><span class="line">  observerCallback?: IntersectionObserverCallback</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class LoadMore extends React.PureComponent&lt;IProps&gt; &#123;</span><br><span class="line">  private ele: Element | null = null</span><br><span class="line">  private observer: IntersectionObserver | undefined</span><br><span class="line">  private observerElement: Element | null = null</span><br><span class="line">  private lastThreshold: number = 0</span><br><span class="line"></span><br><span class="line">  public componentDidMount() &#123;</span><br><span class="line">    const &#123; rootMargin &#125; = this.props</span><br><span class="line">    this.observer = new IntersectionObserver(this.observerCallback, &#123;</span><br><span class="line">      root: this.getRootElement(),</span><br><span class="line">      rootMargin,</span><br><span class="line">      threshold: [0, 0.01],</span><br><span class="line">    &#125;)</span><br><span class="line">    this.listenLastDom()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public componentDidUpdate(prevProps: IProps) &#123;</span><br><span class="line">    const &#123; children: oldChildren &#125; = prevProps</span><br><span class="line">    const &#123; children &#125; = this.props</span><br><span class="line">    const len = React.Children.toArray(children).length</span><br><span class="line">    if (len !== React.Children.toArray(oldChildren).length &amp;&amp; len) &#123;</span><br><span class="line">      this.listenLastDom()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public componentWillUnmount() &#123;</span><br><span class="line">    this.unobserve()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public render() &#123;</span><br><span class="line">    const &#123;</span><br><span class="line">      children,</span><br><span class="line">      getRootElement,</span><br><span class="line">      observerCallback,</span><br><span class="line">      rootMargin,</span><br><span class="line">      ...otherProps</span><br><span class="line">    &#125; = this.props</span><br><span class="line">    return (</span><br><span class="line">      &lt;div ref=&#123;this.getElement&#125; &#123;...otherProps&#125;&gt;</span><br><span class="line">        &#123;children&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private getRootElement = () =&gt; &#123;</span><br><span class="line">    const &#123; getRootElement &#125; = this.props</span><br><span class="line">    const ele = this.ele as Element</span><br><span class="line">    let parent = null</span><br><span class="line">    if (getRootElement) &#123;</span><br><span class="line">      parent = getRootElement(</span><br><span class="line">        ele &amp;&amp; ele.parentElement</span><br><span class="line">          ? ele.parentElement</span><br><span class="line">          : (document.body as Element),</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    if (!parent &amp;&amp; ele &amp;&amp; ele.parentElement) &#123;</span><br><span class="line">      parent = ele.parentElement</span><br><span class="line">    &#125;</span><br><span class="line">    return parent</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private getElement = (ele: Element | null) =&gt; &#123;</span><br><span class="line">    this.ele = ele</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 监听回调</span><br><span class="line">  private observerCallback = (</span><br><span class="line">    entries: IntersectionObserverEntry[],</span><br><span class="line">    observer: IntersectionObserver,</span><br><span class="line">  ) =&gt; &#123;</span><br><span class="line">    const [&#123; intersectionRatio = 0 &#125;] = entries</span><br><span class="line"></span><br><span class="line">    const &#123; observerCallback &#125; = this.props</span><br><span class="line">    if (intersectionRatio &gt; this.lastThreshold) &#123;</span><br><span class="line">      if (observerCallback) &#123;</span><br><span class="line">        observerCallback(entries, observer)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    this.lastThreshold = intersectionRatio</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 停止监听元素</span><br><span class="line">  private unobserve = () =&gt; &#123;</span><br><span class="line">    if (this.observerElement &amp;&amp; this.observer) &#123;</span><br><span class="line">      this.observer.unobserve(this.observerElement)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // 监听元素</span><br><span class="line">  private listenLastDom = () =&gt; &#123;</span><br><span class="line">    if (this.ele &amp;&amp; this.ele.lastChild) &#123;</span><br><span class="line">      const dom: Element = this.ele.lastChild as Element</span><br><span class="line">      this.lastThreshold = 0</span><br><span class="line">      const observer = this.observer as IntersectionObserver</span><br><span class="line">      if (dom &amp;&amp; observer) &#123;</span><br><span class="line">        this.unobserve()</span><br><span class="line">        this.observerElement = dom</span><br><span class="line">        observer.observe(this.observerElement)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default LoadMore</span><br></pre></td></tr></table></figure><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserver" target="_blank" rel="noopener">IntersectionObserver MDN 参考</a></li><li><a href="https://www.npmjs.com/package/intersection-observer" target="_blank" rel="noopener">intersection-observer polyfill</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;当页面数据过多为了优化页面加载速度和避免页面的卡顿时使用滚动加载的方式实现数据的分页加载功能&lt;/p&gt;
&lt;h3 id=&quot;加载更多方案&quot;&gt;&lt;a href=&quot;#加载更多方案&quot; class=&quot;headerlink&quot; title=&quot;加载更多方案&quot;&gt;&lt;/a&gt;加载更多方案&lt;/h3&gt;&lt;h4
      
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://yoursite.com/tags/JavaScript/"/>
    
  </entry>
  
</feed>
