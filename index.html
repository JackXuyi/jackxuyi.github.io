<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  <title>奔跑的蜗牛</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前端开发工程师">
<meta name="keywords" content="React、node、webpack">
<meta property="og:type" content="website">
<meta property="og:title" content="奔跑的蜗牛">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="奔跑的蜗牛">
<meta property="og:description" content="前端开发工程师">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="奔跑的蜗牛">
<meta name="twitter:description" content="前端开发工程师">
  
  
    <link rel="icon" href="0001.jpg#/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">奔跑的蜗牛</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">奔跑的蜗牛</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">分类</a>
        
      </nav>
      <nav id="sub-nav">
        
        
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-浏览器渲染过程详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/07/12/浏览器渲染过程详解/" class="article-date">
  <time datetime="2021-07-11T16:03:29.000Z" itemprop="datePublished">2021-07-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/12/浏览器渲染过程详解/">浏览器渲染过程详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="渲染流程"><a href="#渲染流程" class="headerlink" title="渲染流程"></a>渲染流程</h3><ol>
<li>浏览器通过网络请求后获取 <code>html</code> 数据，通过 <code>tcp</code> 传给浏览器进程，然后浏览器进程再传递给渲染器进程</li>
<li><code>DOM</code> - <code>DOM</code> 结构： 主线程将 <code>html</code> 解析构造 <code>DOM</code> 树</li>
<li><code>style</code> - 样式： 主线程解析页面的 <code>CSS</code> 从而确定每个 <code>DOM</code> 节点的计算样式（<code>computed style</code>）。</li>
<li><code>layoutTree</code> - 布局树： <code>dom</code>+<code>style</code> 根据 <code>dom</code> 树和样式生成 <code>layoutTree</code></li>
<li><code>paint</code> - 绘制： 通过遍历 <code>Layout Tree</code> 生成绘制顺序表</li>
<li><code>laryer</code> - 布局： 主线程将 <code>layoutTree</code> 和绘制信息表传给合成器线程</li>
<li>合成器线程： 将得到的信息分图层分成更小的图块</li>
<li>栅格线程： 将更小的图块进行栅格化 <code>raster</code>，返还给合成器线程 <code>draw quads</code> 图块信息，存储在 <code>GPU</code> 中</li>
<li>合成线程会收集图块上面叫做绘画四边形（<code>draw quads</code>）的信息来构建一个合成帧（<code>compositor frame</code>）。</li>
<li>合成线程就会通过 <code>IPC</code> 向浏览器进程（<code>browser process</code>）提交（<code>commit</code>）一个渲染帧。</li>
<li>浏览器进程收到一帧的图像后传给 <code>GPU</code> 进行渲染</li>
</ol>
<h4 id="非快速滚动区域-non-fast-scrollable-region"><a href="#非快速滚动区域-non-fast-scrollable-region" class="headerlink" title="非快速滚动区域 - non-fast scrollable region"></a>非快速滚动区域 - non-fast scrollable region</h4><p>当一个页面被合成的时候，合成线程会将页面那些注册了事件监听器的区域标记为“非快速滚动区域”（<code>Non-fast Scrollable Region</code>）。当用户事件发生在这些区域时，合成线程会将输入事件发送给主线程来处理。如果输入事件不是发生在非快速滚动区域，合成线程就无须主线程的参与来合成一个新的帧。</p>
<h5 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h5><p><code>body</code> 元素绑定了事件监听器后其实是将整个页面都标记为一个非快速滚动区域，这就意味着即使你页面的某些区域压根就不在乎是不是有用户输入，当用户输入事件发生时，合成线程每次都会告知主线程并且会等待主线程处理完它才干活。因此这种情况下合成线程就丧失提供流畅用户体验的能力了（<code>smooth scrolling ability</code>）。</p>
<h5 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h5><p>可以为事件监听器传递 <code>passive：true</code> 选项。 这个选项会告诉浏览器您仍要在主线程中侦听事件，可是合成线程也可以继续合成新的帧。</p>
<h4 id="查找事件的目标对象（event-target）"><a href="#查找事件的目标对象（event-target）" class="headerlink" title="查找事件的目标对象（event target）"></a>查找事件的目标对象（event target）</h4><p>当合成线程向主线程发送输入事件时，主线程要做的第一件事是通过命中测试（<code>hit test</code>）去找到事件的目标对象（<code>target</code>）。具体的命中测试流程是遍历在渲染流水线中生成的绘画记录（<code>paint records</code>）来找到输入事件出现的 <code>x</code>, <code>y</code> 坐标上面描绘的对象是哪个。</p>
<h4 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h4><h5 id="DOM-对象"><a href="#DOM-对象" class="headerlink" title="DOM 对象"></a>DOM 对象</h5><p>既是浏览器对当前页面的内部表示，也是 <code>Web</code> 开发人员通过 <code>JavaScript</code> 与网页进行交互的数据结构以及 <code>API</code>。</p>
<h5 id="光栅化（rasterizing）"><a href="#光栅化（rasterizing）" class="headerlink" title="光栅化（rasterizing）"></a>光栅化（rasterizing）</h5><p>将以上文档结构，元素的样式，元素的几何信息以及它们的绘画顺序转化为显示器的像素的过程</p>
<h5 id="绘画四边形"><a href="#绘画四边形" class="headerlink" title="绘画四边形"></a>绘画四边形</h5><p>包含图块在内存的位置以及图层合成后图块在页面的位置之类的信息。</p>
<h5 id="合成帧"><a href="#合成帧" class="headerlink" title="合成帧"></a>合成帧</h5><p>代表页面一个帧的内容的绘制四边形集合。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://zhuanlan.zhihu.com/p/102149546" target="_blank" rel="noopener">一文看懂 Chrome 浏览器运行机制</a></li>
<li><a href="https://www.html5rocks.com/zh/tutorials/internals/howbrowserswork/#Resources" target="_blank" rel="noopener">浏览器的工作原理：新式网络浏览器幕后揭秘</a></li>
<li><a href="https://www.html5rocks.com/zh/tutorials/speed/high-performance-animations/" target="_blank" rel="noopener">High Performance Animations</a></li>
<li><a href="https://www.bilibili.com/video/BV1x54y1B7RE" target="_blank" rel="noopener">【干货】浏览器是如何运作的？</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/07/12/浏览器渲染过程详解/" data-id="ckqza38k5004eyys6oq4ws6wd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-js执行流程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/07/11/js执行流程/" class="article-date">
  <time datetime="2021-07-10T21:58:37.000Z" itemprop="datePublished">2021-07-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/11/js执行流程/">js执行流程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="js-引擎"><a href="#js-引擎" class="headerlink" title="js 引擎"></a><code>js</code> 引擎</h3><table>
<thead>
<tr>
<th style="text-align:left">浏览器</th>
<th style="text-align:left"><code>JavaScript</code> 引擎</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">chrome</td>
<td style="text-align:left"><code>V8</code></td>
</tr>
<tr>
<td style="text-align:left">safari</td>
<td style="text-align:left"><code>JavaScriptCore</code></td>
</tr>
<tr>
<td style="text-align:left">Firefox</td>
<td style="text-align:left"><code>SpiderMonkey</code></td>
</tr>
<tr>
<td style="text-align:left">Edge</td>
<td style="text-align:left"><code>Chakra</code></td>
</tr>
</tbody>
</table>
<h3 id="js-执行过程"><a href="#js-执行过程" class="headerlink" title="js 执行过程"></a><code>js</code> 执行过程</h3><ol>
<li>对源码进行词法分析</li>
<li>进行语法分析</li>
<li>生成抽象语法树</li>
<li>生成可执行代码（可能有优化过程，此处代码可能是字节码或者机器码）</li>
<li>执行</li>
</ol>
<h4 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h4><p>将程序源代码分解成对编程语言来说有意义的代码块，这些代码块被称为词法单元（<code>token</code>）。</p>
<h4 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h4><p>根据生成的 <code>Token</code> 进行语法分析。</p>
<h3 id="V8-引擎"><a href="#V8-引擎" class="headerlink" title="V8 引擎"></a><code>V8</code> 引擎</h3><h4 id="主要模块"><a href="#主要模块" class="headerlink" title="主要模块"></a>主要模块</h4><h5 id="Parser"><a href="#Parser" class="headerlink" title="Parser"></a><code>Parser</code></h5><p>负责将 <code>JavaScript</code> 源码转换为 <code>Abstract Syntax Tree</code> (<code>AST</code>)。在 <code>V8</code> 中有两个解析器用于解析 <code>JavaScript</code> 代码，分别是 <code>Parser</code> 和 <code>Pre-Parser</code> 。</p>
<ul>
<li><code>Parser</code> 解析器又称为 <code>full parser</code>（全量解析） 或者 <code>eager parser</code>（饥饿解析）。它会解析所有立即执行的代码，包括语法检查，生成 <code>AST</code>，以及确定词法作用域。</li>
<li><code>Pre-Parser</code> 又称为惰性解析，它只解析未被立即执行的代码（如函数），不生成 <code>AST</code> ，只确定作用域，以此来提高性能。当预解析后的代码开始执行时，才进行 <code>Parser</code> 解析。</li>
</ul>
<h5 id="Ignition"><a href="#Ignition" class="headerlink" title="Ignition"></a><code>Ignition</code></h5><p><code>interpreter</code>，即解释器，负责将 <code>AST</code> 转换为 <code>Bytecode</code>，解释执行 <code>Bytecode</code>；同时收集 <code>TurboFan</code> 优化编译所需的信息，比如函数参数的类型</p>
<h5 id="TurboFan"><a href="#TurboFan" class="headerlink" title="TurboFan"></a><code>TurboFan</code></h5><p><code>compiler</code>，即编译器，利用 <code>Ignitio</code> 所收集的类型信息，将 <code>Bytecode</code> 转换为优化的机器代码</p>
<h5 id="Orinoco"><a href="#Orinoco" class="headerlink" title="Orinoco"></a><code>Orinoco</code></h5><p><code>garbage collector</code>，垃圾回收模块，负责将程序不再需要的内存空间回收；</p>
<h4 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h4><ol>
<li>扫描所有的源代码，进行词法分析，生成 <code>Tokens</code></li>
<li><code>Parser</code> 解析器根据 <code>Tokens</code> 生成 <code>AST</code>，存在预编译和编译</li>
<li><code>Ignition</code> 解释器将 <code>AST</code> 转换为字节码，并解释执行</li>
<li><code>TurboFan</code> 编译器负责将热点函数优化编译为机器指令执行</li>
</ol>
<p><img src="/images/brower/js_v8.jpg" alt="执行过程"></p>
<h5 id="优化及优化导致的问题修复"><a href="#优化及优化导致的问题修复" class="headerlink" title="优化及优化导致的问题修复"></a>优化及优化导致的问题修复</h5><p>当 <code>Ignition</code> 开始执行 <code>JavaScript</code> 代码后，<code>V8</code> 会一直观察 <code>JavaScript</code> 代码的执行情况，并记录执行信息，如每个函数的执行次数、每次调用函数时，传递的参数类型等。</p>
<p>如果一个函数被调用的次数超过了内设的阈值，监视器就会将当前函数标记为热点函数（<code>Hot Function</code>），并将该函数的字节码以及执行的相关信息发送给 <code>TurboFan</code>。<code>TurboFan</code> 会根据执行信息做出一些进一步优化此代码的假设，在假设的基础上将字节码编译为优化的机器代码。如果假设成立，那么当下一次调用该函数时，就会执行优化编译后的机器代码，以提高代码的执行性能；如果假设不成立，不知道你们有没有注意到上图中有一条由 <code>optimized code</code> 指向 <code>bytecode</code> 的红色指向线。此过程叫做 <code>deoptimize</code>（优化回退），将优化编译后的机器代码还原为字节码。</p>
<p><img src="/images/brower/js_v8_optimize.jpg" alt="优化过程"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.bilibili.com/video/BV1zV411z7RX" target="_blank" rel="noopener">8 分钟带你了解 V8 引擎是如何运行 JS</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/73768338" target="_blank" rel="noopener">JavaScript 深入浅出第 4 课：V8 引擎是如何工作的？</a></li>
<li><a href="https://v8.dev/blog/launching-ignition-and-turbofan" target="_blank" rel="noopener">Launching Ignition and TurboFan</a></li>
<li><a href="https://segmentfault.com/a/1190000022062181" target="_blank" rel="noopener">JavaScript 引擎（V8）是如何工作的</a></li>
<li><a href="https://mlib.wang/2020/02/08/v8-parser-compiler-javascript/" target="_blank" rel="noopener">V8 是如何怎么处理 JavaScript 的</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/07/11/js执行流程/" data-id="ckqza38io001uyys6ccw748yb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react中hooks实现原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/28/react中hooks实现原理/" class="article-date">
  <time datetime="2021-06-27T22:34:04.000Z" itemprop="datePublished">2021-06-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/28/react中hooks实现原理/">react中hooks实现原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="fiber-对象"><a href="#fiber-对象" class="headerlink" title="fiber 对象"></a><code>fiber</code> 对象</h3><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.jianshu.com/p/b9ac8fa849f1" target="_blank" rel="noopener">React Hooks 原理</a></li>
<li><a href="https://www.cnblogs.com/cczlovexw/p/13565085.html" target="_blank" rel="noopener">React Hook 的底层实现原理</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/48584310" target="_blank" rel="noopener">阅读源码后，来讲讲 React Hooks 是怎么实现的</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/75146261" target="_blank" rel="noopener">React Hook 的实现原理和最佳实践</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/06/28/react中hooks实现原理/" data-id="ckqza38j1002myys63mzzpcfw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react从dom-render到初次组件渲染完成" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/20/react从dom-render到初次组件渲染完成/" class="article-date">
  <time datetime="2021-06-19T22:12:44.000Z" itemprop="datePublished">2021-06-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/20/react从dom-render到初次组件渲染完成/">react从dom.render到初次组件渲染完成</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="从-dom-render-到初次组件渲染完成"><a href="#从-dom-render-到初次组件渲染完成" class="headerlink" title="从 dom.render 到初次组件渲染完成"></a>从 <code>dom.render</code> 到初次组件渲染完成</h2><ol>
<li><code>render(element,container,callback)</code> 调用 <code>legacyRenderSubtreeIntoContainer(null,element,container,false,callback)</code></li>
<li><code>legacyRenderSubtreeIntoContainer(parentComponent,children,container,forceHydrate,callback)</code> 调用<code>legacyCreateRootFromDOMContainer(container,false)</code> 创建容器并赋值给 <code>container._reactRootContainer</code></li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMLegacy.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">legacyRenderSubtreeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  children: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  forceHydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?Function</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> root = container._reactRootContainer</span><br><span class="line">  <span class="keyword">let</span> fiberRoot: FiberRoot</span><br><span class="line">  <span class="keyword">if</span> (!root) &#123;</span><br><span class="line">    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate</span><br><span class="line">    )</span><br><span class="line">    fiberRoot = root._internalRoot</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> originalCallback = callback</span><br><span class="line">      callback = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> instance = getPublicRootInstance(fiberRoot)</span><br><span class="line">        originalCallback.call(instance)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化同步更新</span></span><br><span class="line">    unbatchedUpdates(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      updateContainer(children, fiberRoot, parentComponent, callback)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> getPublicRootInstance(fiberRoot)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>通过 <code>unbatchedUpdates</code> 同步更新容器元素并调用回调函数</li>
</ol>
<h3 id="构建容器"><a href="#构建容器" class="headerlink" title="构建容器"></a>构建容器</h3><ol>
<li><code>legacyCreateRootFromDOMContainer</code> 调用 <code>createLegacyRoot(container)</code> 构建容器</li>
<li>调用 <code>new ReactDOMLegacyRoot(container)</code> 构建实例</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMRoot.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createLegacyRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  options?: RootOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">RootType</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReactDOMLegacyRoot(container, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>构造函数中调用 <code>createRootImpl(container, ConcurrentRoot)</code> 创建根容器并赋值给 <code>_internalRoot</code> 属性</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMRoot.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ReactDOMLegacyRoot</span>(<span class="params">container: Container, options: void | RootOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._internalRoot = createRootImpl(container, LegacyRoot, options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOMLegacyRoot.prototype.render = <span class="function"><span class="keyword">function</span> (<span class="params">children: ReactNodeList</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="keyword">this</span>._internalRoot</span><br><span class="line">  updateContainer(children, root, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactDOMLegacyRoot.prototype.unmount = <span class="function"><span class="keyword">function</span> (<span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = <span class="keyword">this</span>._internalRoot</span><br><span class="line">  <span class="keyword">const</span> container = root.containerInfo</span><br><span class="line">  updateContainer(<span class="literal">null</span>, root, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">    unmarkContainerAsRoot(container)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRootImpl</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  container: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  options: void | RootOptions</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root = createContainer(container, tag)</span><br><span class="line">  markContainerAsRoot(root.current, container)</span><br><span class="line">  <span class="keyword">const</span> rootContainerElement =</span><br><span class="line">    container.nodeType === COMMENT_NODE ? container.parentNode : container</span><br><span class="line">  listenToAllSupportedEvents(rootContainerElement)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>调用 <code>createContainer(container, ConcurrentRoot)</code> 构建根元素</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberRoot.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: Container,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span></span></span><br><span class="line"><span class="function"><span class="params">  isStrictMode: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  concurrentUpdatesByDefaultOverride: null | boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">OpaqueRoot</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> createFiberRoot(</span><br><span class="line">    containerInfo,</span><br><span class="line">    tag,</span><br><span class="line">    hydrate,</span><br><span class="line">    hydrationCallbacks,</span><br><span class="line">    isStrictMode,</span><br><span class="line">    concurrentUpdatesByDefaultOverride</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.  调用 `new FiberRootNode(container, ConcurrentRoot)` 构建根元素</span></span><br><span class="line"><span class="comment">// 2.  调用 `createHostRootFiber` 构建 `Fiber`</span></span><br><span class="line"><span class="comment">// 3.  初始化更新队列</span></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberRoot.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFiberRoot</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  containerInfo: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrate: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrationCallbacks: null | SuspenseHydrationCallbacks,</span></span></span><br><span class="line"><span class="function"><span class="params">  isStrictMode: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  concurrentUpdatesByDefaultOverride: null | boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> root: FiberRoot = <span class="keyword">new</span> FiberRootNode(containerInfo, tag, hydrate)</span><br><span class="line">  <span class="keyword">const</span> uninitializedFiber = createHostRootFiber(</span><br><span class="line">    tag,</span><br><span class="line">    isStrictMode,</span><br><span class="line">    concurrentUpdatesByDefaultOverride</span><br><span class="line">  )</span><br><span class="line">  root.current = uninitializedFiber</span><br><span class="line">  uninitializedFiber.stateNode = root</span><br><span class="line">  <span class="keyword">const</span> initialState = &#123; <span class="attr">element</span>: <span class="literal">null</span> &#125;</span><br><span class="line">  uninitializedFiber.memoizedState = initialState</span><br><span class="line">  initializeUpdateQueue(uninitializedFiber)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberRootNode</span>(<span class="params">containerInfo, tag, hydrate</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.tag = tag</span><br><span class="line">  <span class="keyword">this</span>.containerInfo = containerInfo</span><br><span class="line">  <span class="keyword">this</span>.pendingChildren = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.current = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.pingCache = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.finishedWork = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.timeoutHandle = noTimeout</span><br><span class="line">  <span class="keyword">this</span>.context = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.pendingContext = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.hydrate = hydrate</span><br><span class="line">  <span class="keyword">this</span>.callbackNode = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.callbackPriority = NoLane</span><br><span class="line">  <span class="keyword">this</span>.eventTimes = createLaneMap(NoLanes)</span><br><span class="line">  <span class="keyword">this</span>.expirationTimes = createLaneMap(NoTimestamp)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.pendingLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.suspendedLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.pingedLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.expiredLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.mutableReadLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.finishedLanes = NoLanes</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.entangledLanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.entanglements = createLaneMap(NoLanes)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiber.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createHostRootFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: RootTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  isStrictMode: boolean,</span></span></span><br><span class="line"><span class="function"><span class="params">  concurrentUpdatesByDefaultOverride: null | boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> mode</span><br><span class="line">  <span class="keyword">if</span> (tag === ConcurrentRoot) &#123;</span><br><span class="line">    mode = ConcurrentMode</span><br><span class="line">    <span class="keyword">if</span> (isStrictMode === <span class="literal">true</span>) &#123;</span><br><span class="line">      mode |= StrictLegacyMode</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (enableStrictEffects) &#123;</span><br><span class="line">        mode |= StrictEffectsMode</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (enableStrictEffects &amp;&amp; createRootStrictEffectsByDefault) &#123;</span><br><span class="line">      mode |= StrictLegacyMode | StrictEffectsMode</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      !enableSyncDefaultUpdates ||</span><br><span class="line">      (allowConcurrentByDefault &amp;&amp; concurrentUpdatesByDefaultOverride)</span><br><span class="line">    ) &#123;</span><br><span class="line">      mode |= ConcurrentUpdatesByDefaultMode</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mode = NoMode</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; isDevToolsPresent) &#123;</span><br><span class="line">    mode |= ProfileMode</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> createFiber(HostRoot, <span class="literal">null</span>, <span class="literal">null</span>, mode)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FiberNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: null | string,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Instance</span></span><br><span class="line">  <span class="keyword">this</span>.tag = tag</span><br><span class="line">  <span class="keyword">this</span>.key = key</span><br><span class="line">  <span class="keyword">this</span>.elementType = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.type = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.stateNode = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fiber</span></span><br><span class="line">  <span class="keyword">this</span>.return = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.child = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.sibling = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.ref = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.pendingProps = pendingProps</span><br><span class="line">  <span class="keyword">this</span>.memoizedProps = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.updateQueue = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.memoizedState = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.dependencies = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.mode = mode</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Effects</span></span><br><span class="line">  <span class="keyword">this</span>.flags = NoFlags</span><br><span class="line">  <span class="keyword">this</span>.subtreeFlags = NoFlags</span><br><span class="line">  <span class="keyword">this</span>.deletions = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.lanes = NoLanes</span><br><span class="line">  <span class="keyword">this</span>.childLanes = NoLanes</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.alternate = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  tag: WorkTag,</span></span></span><br><span class="line"><span class="function"><span class="params">  pendingProps: mixed,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: null | string,</span></span></span><br><span class="line"><span class="function"><span class="params">  mode: TypeOfMode</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FiberNode(tag, pendingProps, key, mode)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>调用<code>markContainerAsRoot(root.current, container)</code>标记根元素</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-dom/src/client/ReactDOMComponentTree.js</span></span><br><span class="line"><span class="keyword">const</span> randomKey = <span class="built_in">Math</span>.random().toString(<span class="number">36</span>).slice(<span class="number">2</span>)</span><br><span class="line"><span class="keyword">const</span> internalContainerInstanceKey = <span class="string">'__reactContainer$'</span> + randomKey</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">markContainerAsRoot</span>(<span class="params">hostRoot: Fiber, node: Container</span>) </span>&#123;</span><br><span class="line">  node[internalContainerInstanceKey] = hostRoot</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>调用<code>listenToAllSupportedEvents(rootContainerElement)</code> 向根元素上注册所有原生监听事件，但 <code>selectionchange</code> 事件注册在 <code>document</code> 上</li>
</ol>
<h4 id="构建的容器"><a href="#构建的容器" class="headerlink" title="构建的容器"></a>构建的容器</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> container =<span class="built_in">document</span>.getElementById(<span class="string">"root"</span>)</span><br><span class="line"><span class="keyword">const</span> root = container._reactRootContainer = &#123;</span><br><span class="line">  _internalRoot: &#123;</span><br><span class="line">    tag: RootTag,</span><br><span class="line">    containerInfo: container,</span><br><span class="line">    pendingChildren: <span class="literal">null</span>,</span><br><span class="line">    current: <span class="literal">null</span>,</span><br><span class="line">    pingCache: <span class="literal">null</span>,</span><br><span class="line">    finishedWork: <span class="literal">null</span>,</span><br><span class="line">    timeoutHandle: noTimeout</span><br><span class="line">    context: <span class="literal">null</span>,</span><br><span class="line">    pendingContext: <span class="literal">null</span>,</span><br><span class="line">    hydrate: hydrate,</span><br><span class="line">    callbackNode: <span class="literal">null</span>,</span><br><span class="line">    callbackPriority: NoLane,</span><br><span class="line">    eventTimes: [NoLanes],</span><br><span class="line">    expirationTimes: [NoTimestamp],</span><br><span class="line">    pendingLanes: NoLanes,</span><br><span class="line">    suspendedLanes: NoLanes,</span><br><span class="line">    pingedLanes: NoLanes,</span><br><span class="line">    expiredLanes: NoLanes,</span><br><span class="line">    mutableReadLanes: NoLanes,</span><br><span class="line">    finishedLanes: NoLanes,</span><br><span class="line">    entangledLanes: NoLanes,</span><br><span class="line">    entanglements: [NoLanes],</span><br><span class="line">  &#125;,</span><br><span class="line">  current: &#123;</span><br><span class="line">    tag: tag,</span><br><span class="line">    key: key,</span><br><span class="line">    elementType: <span class="literal">null</span>,</span><br><span class="line">    type: <span class="literal">null</span>,</span><br><span class="line">    stateNode: root,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fiber</span></span><br><span class="line">    <span class="keyword">return</span>: <span class="literal">null</span>,</span><br><span class="line">    child: <span class="literal">null</span>,</span><br><span class="line">    sibling: <span class="literal">null</span>,</span><br><span class="line">    index: <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    ref: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    pendingProps: pendingProps,</span><br><span class="line">    memoizedProps: <span class="literal">null</span>,</span><br><span class="line">    updateQueue: <span class="literal">null</span>,</span><br><span class="line">    memoizedState: &#123; <span class="attr">element</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">    dependencies: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    mode: NoMode,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Effects</span></span><br><span class="line">    flags: NoFlags,</span><br><span class="line">    subtreeFlags: NoFlags,</span><br><span class="line">    deletions: <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">    lanes: NoLanes,</span><br><span class="line">    childLanes: NoLanes,</span><br><span class="line"></span><br><span class="line">    alternate: <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> fiberRoot = root._internalRoot</span><br><span class="line">container[<span class="string">'__reactContainer$'</span> + randomKey] = root.current</span><br></pre></td></tr></table></figure>
<h3 id="更新容器"><a href="#更新容器" class="headerlink" title="更新容器"></a>更新容器</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberReconciler.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  element: ReactNodeList,</span></span></span><br><span class="line"><span class="function"><span class="params">  container: OpaqueRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentComponent: ?React$Component&lt;any, any&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback: ?Function</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Lane</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = container.current</span><br><span class="line">  <span class="keyword">const</span> eventTime = requestEventTime() <span class="comment">// 获取更新时间</span></span><br><span class="line">  <span class="keyword">const</span> lane = requestUpdateLane(current) <span class="comment">// 获取更新任务的优先级</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> context = getContextForSubtree(parentComponent) <span class="comment">// 获取 context</span></span><br><span class="line">  <span class="keyword">if</span> (container.context === <span class="literal">null</span>) &#123;</span><br><span class="line">    container.context = context</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.pendingContext = context</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> update = createUpdate(eventTime, lane) <span class="comment">// 构建一次更新</span></span><br><span class="line">  update.payload = &#123; element &#125;</span><br><span class="line"></span><br><span class="line">  callback = callback === <span class="literal">undefined</span> ? <span class="literal">null</span> : callback</span><br><span class="line">  <span class="keyword">if</span> (callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    update.callback = callback</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  enqueueUpdate(current, update, lane)</span><br><span class="line">  <span class="keyword">const</span> root = scheduleUpdateOnFiber(current, lane, eventTime)</span><br><span class="line">  <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">    entangleTransitions(root, current, lane)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> lane</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>获取更新优先级，位数越底，优先级越高</li>
<li>获取 <code>context</code></li>
<li>通过 <code>createUpdate</code> 创建更新</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createUpdate</span>(<span class="params">eventTime: number, lane: Lane</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> update = &#123;</span><br><span class="line">    eventTime,</span><br><span class="line">    lane,</span><br><span class="line">    tag: UpdateState,</span><br><span class="line">    payload: <span class="literal">null</span>,</span><br><span class="line">    callback: <span class="literal">null</span>,</span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> update</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>通过 <code>enqueueUpdate</code> 把更新放入更新队列</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: Update&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.updateQueue</span><br><span class="line">  <span class="keyword">if</span> (updateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 卸载时执行</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> sharedQueue = updateQueue.shared</span><br><span class="line">  <span class="comment">// 正在更新</span></span><br><span class="line">  <span class="keyword">if</span> (isInterleavedUpdate(fiber, lane)) &#123;</span><br><span class="line">    <span class="keyword">const</span> interleaved = sharedQueue.interleaved</span><br><span class="line">    <span class="keyword">if</span> (interleaved === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 构建更新环，并放入更新队列</span></span><br><span class="line">      update.next = update</span><br><span class="line">      pushInterleavedQueue(sharedQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = interleaved.next</span><br><span class="line">      interleaved.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.interleaved = update</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pending = sharedQueue.pending</span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 构建更新环，并放入更新队列</span></span><br><span class="line">      update.next = update</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = pending.next</span><br><span class="line">      pending.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.pending = update</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>通过 <code>scheduleUpdateOnFiber</code> 调度更新</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/06/20/react从dom-render到初次组件渲染完成/" data-id="ckqza38j6002wyys6b38l3m0w" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-webpack源码阅读（二）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/17/webpack源码阅读（二）/" class="article-date">
  <time datetime="2021-06-16T19:22:20.000Z" itemprop="datePublished">2021-06-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/17/webpack源码阅读（二）/">webpack源码阅读（二）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="webpack-Compilation-执行过程"><a href="#webpack-Compilation-执行过程" class="headerlink" title="webpack Compilation 执行过程"></a>webpack Compilation 执行过程</h3><ol>
<li>构建 <code>Compilation</code> 实例</li>
<li>调用 <code>compilation.finish</code> 执行构建</li>
<li>异步调用 <code>finishModules</code> 钩子函数</li>
<li>调用 <code>compilation.seal</code> 完成构建</li>
<li>构建 <code>ChunkGraph</code> 实例，并调用 <code>ChunkGraph.setChunkGraphForModule(module, chunkGraph)</code></li>
<li>同步调用 <code>seal</code> 钩子函数</li>
<li>同步调用 <code>optimizeDependencies</code> 钩子函数，等待钩子函数执行完毕</li>
<li>同步调用 <code>afterOptimizeDependencies</code> 钩子函数</li>
<li>同步调用 <code>beforeChunks</code> 钩子函数</li>
<li>构建 <code>chunk</code></li>
<li>同步调用 <code>afterChunks</code> 钩子函数</li>
<li>同步调用 <code>optimize</code> 钩子函数</li>
<li>同步调用 <code>optimizeModules</code> 钩子函数，等待钩子函数执行完毕</li>
<li>同步调用 <code>afterOptimizeModules</code> 钩子函数</li>
<li>同步调用 <code>optimizeChunks</code> 钩子函数，等待钩子函数执行完毕</li>
<li>同步调用 <code>afterOptimizeChunks</code> 钩子函数</li>
<li>异步调用 <code>optimizeTree</code> 钩子函数</li>
<li>同步调用 <code>afterOptimizeTree</code> 钩子函数</li>
<li>异步调用 <code>optimizeChunkModules</code> 钩子函数</li>
<li>同步调用 <code>afterOptimizeChunkModules</code> 钩子函数</li>
<li>同步调用 <code>shouldRecord</code> 钩子函数</li>
<li>同步调用 <code>reviveModules</code> 钩子函数</li>
<li>同步调用 <code>beforeModuleIds</code> 钩子函数</li>
<li>同步调用 <code>moduleIds</code> 钩子函数</li>
<li>同步调用 <code>optimizeModuleIds</code> 钩子函数</li>
<li>同步调用 <code>afterOptimizeModuleIds</code> 钩子函数</li>
<li>同步调用 <code>reviveChunks</code> 钩子函数</li>
<li>同步调用 <code>beforeChunkIds</code> 钩子函数</li>
<li>同步调用 <code>chunkIds</code> 钩子函数</li>
<li>同步调用 <code>optimizeChunkIds</code> 钩子函数</li>
<li>同步调用 <code>afterOptimizeChunkIds</code> 钩子函数</li>
<li>若 <code>shouldRecord</code> 钩子函数为正，则同步调用 <code>recordModules</code> 钩子函数</li>
<li>若 <code>shouldRecord</code> 钩子函数为正，则同步调用 <code>recordChunks</code> 钩子函数</li>
<li>同步调用 <code>optimizeCodeGeneration</code> 钩子函数</li>
<li>同步调用 <code>beforeModuleHash</code> 钩子函数</li>
<li>同步调用 <code>afterModuleHash</code> 钩子函数</li>
<li>同步调用 <code>beforeCodeGeneration</code> 钩子函数</li>
<li>调用 <code>codeGeneration</code> 生成代码</li>
<li>同步调用 <code>afterCodeGeneration</code> 钩子函数</li>
<li>同步调用 <code>beforeRuntimeRequirements</code> 钩子函数</li>
<li>提取 <code>modules</code> 中的 <code>runtime</code>，对于每个 <code>module</code> 的 <code>runtime</code> 都同步调用 <code>additionalModuleRuntimeRequirements</code> 钩子函数</li>
<li>若存在对应的 <code>runtimeRequirementInModule</code> 钩子函数，则同步调用该钩子函数</li>
<li>对每个 <code>chunk</code> 同步调用 <code>additionalChunkRuntimeRequirements</code> 钩子函数</li>
<li>对每个 <code>chunk</code> 中依赖的 <code>runtime</code> 调用 <code>runtimeRequirementInChunk</code> 钩子函数</li>
<li>构建含有重复依赖的依赖树</li>
<li>每个入口文件的依赖进行扁平化处理，去掉重复依赖，然后同步调用 <code>additionalTreeRuntimeRequirements</code> 钩子函数</li>
<li>每个入口文件的依赖一次调用 <code>runtimeRequirementInTree</code> 钩子函数</li>
<li>同步调用 <code>afterRuntimeRequirements</code> 钩子函数</li>
<li>同步调用 <code>beforeHash</code> 钩子函数</li>
<li>同步调用 <code>updateHash</code> 钩子函数</li>
<li>若为非 <code>fullHashModules</code> 是同步调用 <code>contentHash</code> 钩子函数</li>
<li>同步调用 <code>fullHash</code> 钩子函数</li>
<li>对每个 <code>chunk</code> 同步调用 <code>fullHash</code> 钩子函数</li>
<li>同步调用 <code>afterHash</code> 钩子函数</li>
<li>若需要记录则同步调用 <code>shouldRecord</code> 钩子函数</li>
<li>清理 <code>chunk</code> 记录的文件</li>
<li>同步调用 <code>beforeModuleAssets</code> 钩子函数</li>
<li>针对 <code>module</code> 的每一个需要输出的资源同步调用 <code>moduleAsset</code> 钩子函数</li>
<li>同步调用 <code>shouldGenerateChunkAssets</code> 判断是否需要输出资源</li>
<li>输出资源前同步调用 <code>beforeChunkAssets</code> 钩子函数</li>
<li>针对每个 <code>chunk</code> 构建一个 <code>manifest</code> 文件</li>
<li>为每个 <code>chunk</code> 写入包含的资源</li>
<li>同步调用 <code>chunkAsset</code> 钩子函数</li>
<li>异步调用 <code>processAssets</code> 钩子函数</li>
<li>同步调用 <code>afterProcessAssets</code> 钩子函数</li>
<li>构建依赖</li>
<li>若需要记录则同步调用 <code>record</code> 钩子函数</li>
<li>同步调用 <code>needAdditionalSeal</code> 钩子函数，判读是否需要新增</li>
<li>异步调用 <code>afterSeal</code> 钩子函数</li>
<li>回调</li>
</ol>
<h4 id="Module"><a href="#Module" class="headerlink" title="Module"></a><code>Module</code></h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string&#125;</span> </span>*/</span></span><br><span class="line">		type: type,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;string&#125;</span> </span>*/</span></span><br><span class="line">		context: context,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">		needId: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Unique Id</span></span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;number&#125;</span> </span>*/</span></span><br><span class="line">		debugId:  debugId++,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Info from Factory</span></span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;ResolveOptions&#125;</span> </span>*/</span></span><br><span class="line">		resolveOptions: EMPTY_RESOLVE_OPTIONS,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;object | undefined&#125;</span> </span>*/</span></span><br><span class="line">		factoryMeta: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="comment">// TODO refactor this -&gt; options object filled from Factory</span></span><br><span class="line">		<span class="comment">// TODO webpack 6: use an enum</span></span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">		useSourceMap: <span class="literal">false</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">		useSimpleSourceMap: <span class="literal">false</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Info from Build</span></span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;WebpackError[] | undefined&#125;</span> </span>*/</span></span><br><span class="line">		_warnings: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;WebpackError[] | undefined&#125;</span> </span>*/</span></span><br><span class="line">		_errors: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;BuildMeta&#125;</span> </span>*/</span></span><br><span class="line">		buildMeta: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;object&#125;</span> </span>*/</span></span><br><span class="line">		buildInfo: <span class="literal">undefined</span>,</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;Dependency[] | undefined&#125;</span> </span>*/</span></span><br><span class="line">		presentationalDependencies: <span class="literal">undefined</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="chunk-具有的属性"><a href="#chunk-具有的属性" class="headerlink" title="chunk 具有的属性"></a><code>chunk</code> 具有的属性</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;number | string | null&#125;</span> </span>*/</span></span><br><span class="line">  id: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;(number|string)[] | null&#125;</span> </span>*/</span></span><br><span class="line">  ids: <span class="literal">null</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;number&#125;</span> </span>*/</span></span><br><span class="line">  debugId: debugId++,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string&#125;</span> </span>*/</span></span><br><span class="line">  name: name,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;SortableSet&lt;string&gt;&#125;</span> </span>*/</span></span><br><span class="line">  idNameHints: <span class="keyword">new</span> SortableSet(),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">  preventIntegration: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;(string | function(PathData, AssetInfo=): string)?&#125;</span> </span>*/</span></span><br><span class="line">  filenameTemplate: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@private </span><span class="doctag">@type <span class="type">&#123;SortableSet&lt;ChunkGroup&gt;&#125;</span> </span>*/</span></span><br><span class="line">  _groups: <span class="keyword">new</span> SortableSet(<span class="literal">undefined</span>, compareChunkGroupsByIndex),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;RuntimeSpec&#125;</span> </span>*/</span></span><br><span class="line">  runtime: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;Set&lt;string&gt;&#125;</span> </span>*/</span></span><br><span class="line">  files: <span class="keyword">new</span> ChunkFilesSet(),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;Set&lt;string&gt;&#125;</span> </span>*/</span></span><br><span class="line">  auxiliaryFiles: <span class="keyword">new</span> <span class="built_in">Set</span>(),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">  rendered: <span class="literal">false</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string=&#125;</span> </span>*/</span></span><br><span class="line">  hash: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;Record&lt;string, string&gt;&#125;</span> </span>*/</span></span><br><span class="line">  contentHash: <span class="built_in">Object</span>.create(<span class="literal">null</span>),</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string=&#125;</span> </span>*/</span></span><br><span class="line">  renderedHash: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string=&#125;</span> </span>*/</span></span><br><span class="line">  chunkReason: <span class="literal">undefined</span>,</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;boolean&#125;</span> </span>*/</span></span><br><span class="line">  extraAsync: <span class="literal">false</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ChunkGraph-具有的属性"><a href="#ChunkGraph-具有的属性" class="headerlink" title="ChunkGraph 具有的属性"></a><code>ChunkGraph</code> 具有的属性</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="comment">/** <span class="doctag">@private </span><span class="doctag">@type <span class="type">&#123;WeakMap&lt;Module, ChunkGraphModule&gt;&#125;</span> </span>*/</span></span><br><span class="line">		_modules: <span class="keyword">new</span> <span class="built_in">WeakMap</span>(),</span><br><span class="line">		<span class="comment">/** <span class="doctag">@private </span><span class="doctag">@type <span class="type">&#123;WeakMap&lt;Chunk, ChunkGraphChunk&gt;&#125;</span> </span>*/</span></span><br><span class="line">		_chunks:  <span class="keyword">new</span> <span class="built_in">WeakMap</span>(),</span><br><span class="line">		<span class="comment">/** <span class="doctag">@private </span><span class="doctag">@type <span class="type">&#123;WeakMap&lt;AsyncDependenciesBlock, ChunkGroup&gt;&#125;</span> </span>*/</span></span><br><span class="line">		_blockChunkGroups: <span class="keyword">new</span> <span class="built_in">WeakMap</span>(),</span><br><span class="line">		<span class="comment">/** <span class="doctag">@private </span><span class="doctag">@type <span class="type">&#123;Map&lt;string, string | number&gt;&#125;</span> </span>*/</span></span><br><span class="line">		_runtimeIds: <span class="keyword">new</span> <span class="built_in">Map</span>(),</span><br><span class="line">		<span class="comment">/** <span class="doctag">@type <span class="type">&#123;ModuleGraph&#125;</span> </span>*/</span></span><br><span class="line">		moduleGraph: moduleGraph;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h4><ol>
<li>对于一份同逻辑的代码，当我们手写下一个一个的文件，它们无论是 <code>ESM</code> 还是 <code>commonJS</code> 或是 <code>AMD</code>，他们都是 <code>module</code></li>
<li>当我们写的 <code>module</code> 源文件传到 <code>webpack</code> 进行打包时，<code>webpack</code> 会根据文件引用关系生成 <code>chunk</code> 文件，<code>webpack</code> 会对这个 <code>chunk</code> 文件进行一些操作；</li>
<li><code>webpack</code> 处理好 <code>chunk</code> 文件后，最后会输出 <code>bundle</code> 文件，这个 <code>bundle</code> 文件包含了经过加载和编译的最终源文件，所以它可以直接在浏览器中运行。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/06/17/webpack源码阅读（二）/" data-id="ckqza38jw0041yys6qovlgcad" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/">webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-webpack源码阅读（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/15/webpack源码阅读（一）/" class="article-date">
  <time datetime="2021-06-15T12:52:53.000Z" itemprop="datePublished">2021-06-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/15/webpack源码阅读（一）/">webpack源码阅读（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="webpack-compile-执行过程"><a href="#webpack-compile-执行过程" class="headerlink" title="webpack compile 执行过程"></a>webpack compile 执行过程</h3><ol>
<li>获取默认基础参数</li>
<li>构建 <code>Compiler</code> 实例</li>
<li>通过插件 <code>NodeEnvironmentPlugin</code> 插入日志输出，构建缓存，监听文件变化，监听 <code>NodeEnvironmentPlugin</code> 事件</li>
<li>注入自定义的插件</li>
<li>设置默认配置</li>
<li>同步执行 <code>environment</code> 钩子函数</li>
<li>同步执行 <code>afterEnvironment</code> 钩子函数</li>
<li>注入预设的插件系统</li>
<li>同步执行 <code>initialize</code> 钩子函数</li>
<li>执行 <code>run</code> ，开始构建</li>
</ol>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: lib/webpack.js</span></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="comment">/** @type &#123;WebpackFunctionSingle &amp; WebpackFunctionMulti&#125; */</span> (</span><br><span class="line">  options,</span><br><span class="line">  callback,</span><br><span class="line">) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> create = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> compiler</span><br><span class="line">    <span class="keyword">let</span> watch = <span class="literal">false</span></span><br><span class="line">    <span class="comment">/** @type &#123;WatchOptions|WatchOptions[]&#125; */</span></span><br><span class="line">    <span class="keyword">let</span> watchOptions</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(options)) &#123;</span><br><span class="line">      <span class="comment">// 多个 compiler</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">/** @type &#123;Compiler&#125; */</span></span><br><span class="line">      compiler = createCompiler(options)</span><br><span class="line">      <span class="comment">// watch 配置</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123; compiler, watch, watchOptions &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; compiler, watch, watchOptions &#125; = create()</span><br><span class="line">  <span class="comment">// 执行 run ，开始构建</span></span><br><span class="line">  compiler.run(<span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">    compiler.close(<span class="function">(<span class="params">err2</span>) =&gt;</span> &#123;</span><br><span class="line">      callback(err || err2, stats)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> compiler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createCompiler = <span class="function">(<span class="params">rawOptions</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> options = getNormalizedWebpackOptions(rawOptions)</span><br><span class="line">  applyWebpackOptionsBaseDefaults(options) <span class="comment">// 构建默认基础选项</span></span><br><span class="line">  <span class="keyword">const</span> compiler = <span class="keyword">new</span> Compiler(options.context) <span class="comment">// 构建 compiler 实例</span></span><br><span class="line">  compiler.options = options</span><br><span class="line">  <span class="keyword">new</span> NodeEnvironmentPlugin(&#123;</span><br><span class="line">    infrastructureLogging: options.infrastructureLogging,</span><br><span class="line">  &#125;).apply(compiler) <span class="comment">// 插入日志输出，构建缓存系统，监听文件变化，监听 NodeEnvironmentPlugin 事件</span></span><br><span class="line">  <span class="comment">// 注入插件</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(options.plugins)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> plugin of options.plugins) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> plugin === <span class="string">'function'</span>) &#123;</span><br><span class="line">        plugin.call(compiler, compiler)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        plugin.apply(compiler)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  applyWebpackOptionsDefaults(options) <span class="comment">// 设置默认配置</span></span><br><span class="line">  compiler.hooks.environment.call() <span class="comment">// 执行 environment 绑定的事件</span></span><br><span class="line">  compiler.hooks.afterEnvironment.call() <span class="comment">// 执行 afterEnvironment 绑定的事件</span></span><br><span class="line">  <span class="keyword">new</span> WebpackOptionsApply().process(options, compiler) <span class="comment">// 注入预设的插件系统</span></span><br><span class="line">  compiler.hooks.initialize.call() <span class="comment">// 执行 initialize 绑定的事件</span></span><br><span class="line">  <span class="keyword">return</span> compiler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="run-执行过程"><a href="#run-执行过程" class="headerlink" title="run 执行过程"></a><code>run</code> 执行过程</h4><ol>
<li>异步调用 <code>beforeRun</code> 钩子函数</li>
<li>异步调用 <code>run</code> 钩子函数</li>
<li>异步读取构建记录</li>
<li>实例化 <code>NormalModuleFactory</code> 对象，同步调用 <code>NormalModuleFactory</code> 钩子函数</li>
<li>实例化 <code>ContextModuleFactory</code> 对象，同步调用 <code>ContextModuleFactory</code> 钩子函数</li>
<li>构建 <code>Compilation</code> 需要的实例参数</li>
<li>异步调用 <code>beforeCompile</code> 钩子函数</li>
<li>同步调用 <code>compile</code> 钩子函数</li>
<li>构建 <code>Compilation</code> 实例</li>
<li>注入 <code>name</code> 和 <code>records</code> 属性</li>
<li>同步调用 <code>thisCompilation</code> 钩子函数</li>
<li>同步调用 <code>compilation</code> 钩子函数</li>
<li>异步调用 <code>make</code> 钩子函数</li>
<li>异步调用 <code>finishMake</code> 钩子函数</li>
<li>在 <code>nextTick</code> 中依次调用 <code>compilation.finish</code> 和 <code>compilation.seal</code></li>
<li>异步调用 <code>afterCompile</code> 钩子函数</li>
<li>同步调用 <code>shouldEmit</code> 钩子判断是否需要输出资源</li>
<li>输出资源文件，异步调用 <code>emit</code> 钩子函数</li>
<li>同步调用 <code>needAdditionalPass</code> 钩子函数</li>
<li>把构建记录 <code>records</code> 写入文件</li>
<li>异步调用 <code>done</code> 钩子函数</li>
<li>回调 <code>callback</code> 完成构建</li>
<li>同步调用 <code>afterDone</code> 钩子函数</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: lib/Compiler.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Compiler</span> </span>&#123;</span><br><span class="line">  run(callback) &#123;</span><br><span class="line">    <span class="keyword">const</span> finalCallback = <span class="function">(<span class="params">err, stats</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.idle = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">this</span>.cache.beginIdle()</span><br><span class="line">      <span class="keyword">this</span>.idle = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">this</span>.running = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// 回调，然后调用 afterDone 钩子函数，结束构建</span></span><br><span class="line">      <span class="keyword">if</span> (callback !== <span class="literal">undefined</span>) callback(err, stats)</span><br><span class="line">      <span class="keyword">this</span>.hooks.afterDone.call(stats)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> startTime = <span class="built_in">Date</span>.now()</span><br><span class="line">    <span class="keyword">this</span>.running = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> onCompiled = <span class="function">(<span class="params">err, compilation</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 不需要输出资源直接结束此次构建</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.hooks.shouldEmit.call(compilation) === <span class="literal">false</span>) &#123;</span><br><span class="line">        compilation.startTime = startTime</span><br><span class="line">        compilation.endTime = <span class="built_in">Date</span>.now()</span><br><span class="line">        <span class="keyword">const</span> stats = <span class="keyword">new</span> Stats(compilation)</span><br><span class="line">        <span class="keyword">this</span>.hooks.done.callAsync(stats, (err) =&gt; &#123;</span><br><span class="line">          <span class="keyword">return</span> finalCallback(<span class="literal">null</span>, stats)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.emitAssets(compilation, (err) =&gt; &#123;</span><br><span class="line">          <span class="comment">// 判断是否需要新增资源，如果需要新增则结束此次编译流程，然后重新启动一个新的编译流程</span></span><br><span class="line">          <span class="keyword">if</span> (compilation.hooks.needAdditionalPass.call()) &#123;</span><br><span class="line">            compilation.needAdditionalPass = <span class="literal">true</span></span><br><span class="line">            compilation.startTime = startTime</span><br><span class="line">            compilation.endTime = <span class="built_in">Date</span>.now()</span><br><span class="line">            <span class="keyword">const</span> stats = <span class="keyword">new</span> Stats(compilation)</span><br><span class="line">            <span class="keyword">this</span>.hooks.done.callAsync(stats, (err) =&gt; &#123;</span><br><span class="line">              <span class="keyword">this</span>.hooks.additionalPass.callAsync(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.compile(onCompiled)</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 输出构建的记录，结束编译流程</span></span><br><span class="line">          <span class="keyword">this</span>.emitRecords(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            compilation.startTime = startTime</span><br><span class="line">            compilation.endTime = <span class="built_in">Date</span>.now()</span><br><span class="line">            <span class="keyword">const</span> stats = <span class="keyword">new</span> Stats(compilation)</span><br><span class="line">            <span class="keyword">this</span>.hooks.done.callAsync(stats, (err) =&gt; &#123;</span><br><span class="line">              <span class="keyword">this</span>.cache.storeBuildDependencies(</span><br><span class="line">                compilation.buildDependencies,</span><br><span class="line">                (err) =&gt; &#123;</span><br><span class="line">                  <span class="keyword">return</span> finalCallback(<span class="literal">null</span>, stats)</span><br><span class="line">                &#125;,</span><br><span class="line">              )</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> run = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.hooks.beforeRun.callAsync(<span class="keyword">this</span>, (err) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.hooks.run.callAsync(<span class="keyword">this</span>, (err) =&gt; &#123;</span><br><span class="line">          <span class="comment">// 读取编译记录</span></span><br><span class="line">          <span class="keyword">this</span>.readRecords(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 开始执行编译</span></span><br><span class="line">            <span class="keyword">this</span>.compile(onCompiled)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    run() <span class="comment">// 开始执行编译进程</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  compile(callback) &#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="keyword">this</span>.newCompilationParams() <span class="comment">// 构建 Compilation 参数</span></span><br><span class="line">    <span class="keyword">this</span>.hooks.beforeCompile.callAsync(params, (err) =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.hooks.compile.call(params)</span><br><span class="line">      <span class="keyword">const</span> compilation = <span class="keyword">this</span>.newCompilation(params) <span class="comment">// 构建 Compilation 实例，开始一次编译</span></span><br><span class="line">      <span class="keyword">this</span>.hooks.make.callAsync(compilation, (err) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.hooks.finishMake.callAsync(compilation, (err) =&gt; &#123;</span><br><span class="line">          process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 执行 Compilation 内的钩子</span></span><br><span class="line">            compilation.finish(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">              compilation.seal(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="comment">// 一次编译完成</span></span><br><span class="line">                <span class="keyword">this</span>.hooks.afterCompile.callAsync(compilation, (err) =&gt; &#123;</span><br><span class="line">                  <span class="keyword">return</span> callback(<span class="literal">null</span>, compilation)</span><br><span class="line">                &#125;)</span><br><span class="line">              &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="代码执行流程图"><a href="#代码执行流程图" class="headerlink" title="代码执行流程图"></a>代码执行流程图</h4><p><img src="/images/webpack-compile.png" alt="webpack compile 代码执行流程"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/06/15/webpack源码阅读（一）/" data-id="ckqza38kv005ryys646txdfry" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webpack/">webpack</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Performance" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/15/Performance/" class="article-date">
  <time datetime="2021-06-14T22:48:44.000Z" itemprop="datePublished">2021-06-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/15/Performance/">Performance</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Performance"><a href="#Performance" class="headerlink" title="Performance"></a>Performance</h3><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><h5 id="navigation"><a href="#navigation" class="headerlink" title="navigation"></a><code>navigation</code></h5><p>只读属性 Performance.navigation 会返回一个 PerformanceNavigation 对象。</p>
<ul>
<li>type: 一个无符号短整型，表示是如何导航到这个页面的。<ul>
<li>TYPE_NAVIGATE (0): 当前页面是通过点击链接，书签和表单提交，或者脚本操作，或者在 url 中直接输入地址;</li>
<li>TYPE_RELOAD (1): 点击刷新页面按钮或者通过 Location.reload()方法显示的页面;</li>
<li>TYPE_BACK_FORWARD (2): 页面通过历史记录和前进后退访问时;</li>
<li>TYPE_RESERVED (255): 任何其他方式。</li>
</ul>
</li>
<li>redirectCount: 无符号短整型，表示在到达这个页面之前重定向了多少次。</li>
</ul>
<h5 id="timing"><a href="#timing" class="headerlink" title="timing"></a><code>timing</code></h5><p>只读属性返回一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/PerformanceTiming" target="_blank" rel="noopener">PerformanceTiming</a> 对象，这个对象包括了页面相关的性能信息。</p>
<h5 id="timeOrigin"><a href="#timeOrigin" class="headerlink" title="timeOrigin"></a><code>timeOrigin</code></h5><p>只读属性 timeOrigin 返回一个表示 the performance measurement 开始时间的高精度 timestamp</p>
<h5 id="onresourcetimingbufferfull"><a href="#onresourcetimingbufferfull" class="headerlink" title="onresourcetimingbufferfull"></a><code>onresourcetimingbufferfull</code></h5><p>在 resourcetimingbufferfull 事件触发时会被调用的事件处理器，参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/onresourcetimingbufferfull" target="_blank" rel="noopener">Performance.onresourcetimingbufferfull</a></p>
<h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><h5 id="Performance-now"><a href="#Performance-now" class="headerlink" title="Performance.now()"></a><code>Performance.now()</code></h5><p>方法返回一个精确到毫秒的事件戳 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DOMHighResTimeStamp" target="_blank" rel="noopener">DOMHighResTimeStamp</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">performance.now() <span class="comment">// 38544.5</span></span><br><span class="line"><span class="built_in">Date</span>.now() <span class="comment">// 1623685111685</span></span><br></pre></td></tr></table></figure>
<h6 id="tips：-测量程序性能时可以使用"><a href="#tips：-测量程序性能时可以使用" class="headerlink" title="tips： 测量程序性能时可以使用"></a>tips： 测量程序性能时可以使用</h6><h5 id="performance-setResourceTimingBufferSize"><a href="#performance-setResourceTimingBufferSize" class="headerlink" title="performance.setResourceTimingBufferSize()"></a><a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance/setResourceTimingBufferSize" target="_blank" rel="noopener"><code>performance.setResourceTimingBufferSize()</code></a></h5><p>设置浏览器记录资源加载情况的缓冲区大小，单位是对象个数，最小为 150</p>
<h5 id="Performance-mark"><a href="#Performance-mark" class="headerlink" title="Performance.mark()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/mark" target="_blank" rel="noopener"><code>Performance.mark()</code></a></h5><p>在浏览器的性能缓冲区中使用给定名称添加一个 timestamp</p>
<h5 id="Performance-measure"><a href="#Performance-measure" class="headerlink" title="Performance.measure()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/measure" target="_blank" rel="noopener"><code>Performance.measure()</code></a></h5><p>在浏览器性能记录缓存中创建了一个名为时间戳的记录来记录两个特殊标志位（通常称为开始标志和结束标志）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">performance.mark(<span class="string">'test1'</span>)</span><br><span class="line">performance.mark(<span class="string">'test2'</span>)</span><br><span class="line">performance.measure(<span class="string">'test'</span>, <span class="string">'test1'</span>, <span class="string">'test2'</span>) <span class="comment">// &#123; detail: null, duration: 0.09999999403953552, entryType: "measure", name: "test", startTime: 33062.60000000894 &#125;</span></span><br></pre></td></tr></table></figure>
<h6 id="tips：-与-Performance-mark-结合可以测量指定项目的时间"><a href="#tips：-与-Performance-mark-结合可以测量指定项目的时间" class="headerlink" title="tips： 与 Performance.mark() 结合可以测量指定项目的时间"></a>tips： 与 <code>Performance.mark()</code> 结合可以测量指定项目的时间</h6><h5 id="Performance-clearResourceTimings"><a href="#Performance-clearResourceTimings" class="headerlink" title="Performance.clearResourceTimings()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearResourceTimings" target="_blank" rel="noopener"><code>Performance.clearResourceTimings()</code></a></h5><p>移除所有的记录</p>
<h5 id="Performance-clearMarks"><a href="#Performance-clearMarks" class="headerlink" title="Performance.clearMarks()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearMarks" target="_blank" rel="noopener"><code>Performance.clearMarks()</code></a></h5><p>从浏览器的 performance entry 缓存中移除声明的标记。</p>
<h5 id="Performance-clearMeasures"><a href="#Performance-clearMeasures" class="headerlink" title="Performance.clearMeasures()"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Performance/clearMeasures" target="_blank" rel="noopener"><code>Performance.clearMeasures()</code></a></h5><p>从浏览器的性能入口缓存区中移除声明的度量衡。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/06/15/Performance/" data-id="ckqza38hi0004yys66ru1d2f1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react的同步更新" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/14/react的同步更新/" class="article-date">
  <time datetime="2021-06-13T18:10:34.000Z" itemprop="datePublished">2021-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/14/react的同步更新/">react的同步更新</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="react-同步更新"><a href="#react-同步更新" class="headerlink" title="react 同步更新"></a>react 同步更新</h3><h4 id="class-组件"><a href="#class-组件" class="headerlink" title="class 组件"></a>class 组件</h4><p>每个 <code>class</code> 组件初始化时都会注入 <code>updater</code> 的属性</p>
<h5 id="更新过程"><a href="#更新过程" class="headerlink" title="更新过程"></a>更新过程</h5><ol>
<li>构建更新节点</li>
<li>把节点放入更新队列</li>
<li>调度更新节点</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">const</span> classComponentUpdater = &#123;</span><br><span class="line">  isMounted,</span><br><span class="line">  enqueueSetState(inst, payload, callback) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = getInstance(inst)</span><br><span class="line">    <span class="keyword">const</span> eventTime = requestEventTime()</span><br><span class="line">    <span class="keyword">const</span> lane = requestUpdateLane(fiber) <span class="comment">// 获取更新方式，包括同步更新</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> update = createUpdate(eventTime, lane) <span class="comment">// 构建更新</span></span><br><span class="line">    update.payload = payload</span><br><span class="line">    <span class="keyword">if</span> (callback !== <span class="literal">undefined</span> &amp;&amp; callback !== <span class="literal">null</span>) &#123;</span><br><span class="line">      update.callback = callback</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enqueueUpdate(fiber, update, lane) <span class="comment">// 更新放入队列</span></span><br><span class="line">    <span class="keyword">const</span> root = scheduleUpdateOnFiber(fiber, lane, eventTime) <span class="comment">// 调度更新节点</span></span><br><span class="line">    <span class="keyword">if</span> (root !== <span class="literal">null</span>) &#123;</span><br><span class="line">      entangleTransitions(root, fiber, lane)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">      markStateUpdateScheduled(fiber, lane)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  enqueueReplaceState(inst, payload, callback) &#123;</span><br><span class="line">    <span class="comment">// 类似与 enqueueSetState</span></span><br><span class="line">  &#125;,</span><br><span class="line">  enqueueForceUpdate(inst, callback) &#123;</span><br><span class="line">    <span class="comment">// 类似与 enqueueSetState</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="把节点放入更新队列"><a href="#把节点放入更新队列" class="headerlink" title="把节点放入更新队列"></a>把节点放入更新队列</h6><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactUpdateQueue.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">enqueueUpdate</span>&lt;<span class="title">State</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  update: Update&lt;State&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue = fiber.updateQueue</span><br><span class="line">  <span class="keyword">if</span> (updateQueue === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 组件卸载</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sharedQueue = updateQueue.shared</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isInterleavedUpdate(fiber, lane)) &#123;</span><br><span class="line">    <span class="keyword">const</span> interleaved = sharedQueue.interleaved</span><br><span class="line">    <span class="keyword">if</span> (interleaved === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载时构成一个循环链表</span></span><br><span class="line">      update.next = update</span><br><span class="line">      <span class="comment">// At the end of the current render, this queue's interleaved updates will</span></span><br><span class="line">      <span class="comment">// be transfered to the pending queue.</span></span><br><span class="line">      pushInterleavedQueue(sharedQueue)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = interleaved.next</span><br><span class="line">      interleaved.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.interleaved = update</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> pending = sharedQueue.pending</span><br><span class="line">    <span class="keyword">if</span> (pending === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 挂载时构成一个循环链表</span></span><br><span class="line">      update.next = update</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      update.next = pending.next</span><br><span class="line">      pending.next = update</span><br><span class="line">    &#125;</span><br><span class="line">    sharedQueue.pending = update</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="调度更新节点"><a href="#调度更新节点" class="headerlink" title="调度更新节点"></a>调度更新节点</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">scheduleUpdateOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  fiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  lane: Lane,</span></span></span><br><span class="line"><span class="function"><span class="params">  eventTime: number</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">FiberRoot</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  checkForNestedUpdates()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = markUpdateLaneFromFiberToRoot(fiber, lane) <span class="comment">// 更新从当前 fiber 标记到根节点并返回根节点</span></span><br><span class="line">  <span class="keyword">if</span> (root === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标记当前节点进入更新队列</span></span><br><span class="line">  markRootUpdated(root, lane, eventTime)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (executionContext &amp; CommitContext) !== NoContext &amp;&amp;</span><br><span class="line">      root === rootCommittingMutationOrLayoutEffects</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (fiber.mode &amp; ProfileMode) &#123;</span><br><span class="line">        <span class="keyword">let</span> current = fiber</span><br><span class="line">        <span class="keyword">while</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (current.tag === Profiler) &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; id, onNestedUpdateScheduled &#125; = current.memoizedProps</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> onNestedUpdateScheduled === <span class="string">'function'</span>) &#123;</span><br><span class="line">              onNestedUpdateScheduled(id)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          current = current.return</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Consolidate with `isInterleavedUpdate` check</span></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// Received an update to a tree that's in the middle of rendering. Mark</span></span><br><span class="line">    <span class="comment">// that there was an interleaved update work on this root. Unless the</span></span><br><span class="line">    <span class="comment">// `deferRenderPhaseUpdateToNextBatch` flag is off and this is a render</span></span><br><span class="line">    <span class="comment">// phase update. In that case, we don't treat render phase updates as if</span></span><br><span class="line">    <span class="comment">// they were interleaved, for backwards compat reasons.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      deferRenderPhaseUpdateToNextBatch ||</span><br><span class="line">      (executionContext &amp; RenderContext) === NoContext</span><br><span class="line">    ) &#123;</span><br><span class="line">      workInProgressRootUpdatedLanes = mergeLanes(</span><br><span class="line">        workInProgressRootUpdatedLanes,</span><br><span class="line">        lane</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (workInProgressRootExitStatus === RootSuspendedWithDelay) &#123;</span><br><span class="line">      <span class="comment">// The root already suspended with a delay, which means this render</span></span><br><span class="line">      <span class="comment">// definitely won't finish. Since we have a new update, let's mark it as</span></span><br><span class="line">      <span class="comment">// suspended now, right before marking the incoming update. This has the</span></span><br><span class="line">      <span class="comment">// effect of interrupting the current render and switching to the update.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Make sure this doesn't override pings that happen while we've</span></span><br><span class="line">      <span class="comment">// already started rendering.</span></span><br><span class="line">      markRootSuspended(root, workInProgressRootRenderLanes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (lane === SyncLane) &#123;</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="comment">// Check if we're inside unbatchedUpdates</span></span><br><span class="line">      (executionContext &amp; LegacyUnbatchedContext) !== NoContext &amp;&amp;</span><br><span class="line">      <span class="comment">// Check if we're not already rendering</span></span><br><span class="line">      (executionContext &amp; (RenderContext | CommitContext)) === NoContext</span><br><span class="line">    ) &#123;</span><br><span class="line">      performSyncWorkOnRoot(root) <span class="comment">// 开始同步更新</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ensureRootIsScheduled(root, eventTime)</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        executionContext === NoContext &amp;&amp;</span><br><span class="line">        (fiber.mode &amp; ConcurrentMode) === NoMode</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// Flush the synchronous work now, unless we're already working or inside</span></span><br><span class="line">        <span class="comment">// a batch. This is intentionally inside scheduleUpdateOnFiber instead of</span></span><br><span class="line">        <span class="comment">// scheduleCallbackForFiber to preserve the ability to schedule a callback</span></span><br><span class="line">        <span class="comment">// without immediately flushing it. We only do this for user-initiated</span></span><br><span class="line">        <span class="comment">// updates, to preserve historical behavior of legacy mode.</span></span><br><span class="line">        resetRenderTimer()</span><br><span class="line">        flushSyncCallbacksOnlyInLegacyMode()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Schedule other updates after in case the callback is sync.</span></span><br><span class="line">    ensureRootIsScheduled(root, eventTime)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="performSyncWorkOnRoot"><a href="#performSyncWorkOnRoot" class="headerlink" title="performSyncWorkOnRoot"></a><code>performSyncWorkOnRoot</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="comment">// This is the entry point for synchronous tasks that don't go</span></span><br><span class="line"><span class="comment">// through Scheduler</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performSyncWorkOnRoot</span>(<span class="params">root</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdatePhase) &#123;</span><br><span class="line">    syncNestedUpdateFlag()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  flushPassiveEffects()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> lanes = getNextLanes(root, NoLanes)</span><br><span class="line">  <span class="keyword">if</span> (!includesSomeLane(lanes, SyncLane)) &#123;</span><br><span class="line">    <span class="comment">// 同步任务执行完毕</span></span><br><span class="line">    ensureRootIsScheduled(root, now())</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> exitStatus = renderRootSync(root, lanes)</span><br><span class="line">  <span class="comment">// 错误补偿逻辑</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We now have a consistent tree. Because this is a sync render, we</span></span><br><span class="line">  <span class="comment">// will commit it even if something suspended.</span></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.current.alternate</span><br><span class="line">  root.finishedWork = finishedWork</span><br><span class="line">  root.finishedLanes = lanes</span><br><span class="line">  commitRoot(root)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Before exiting, make sure there's a callback scheduled for the next</span></span><br><span class="line">  <span class="comment">// pending level.</span></span><br><span class="line">  ensureRootIsScheduled(root, now())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="renderRootSync"><a href="#renderRootSync" class="headerlink" title="renderRootSync"></a><code>renderRootSync</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// workInProgressRoot 全局变量</span></span><br><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">renderRootSync</span>(<span class="params">root: FiberRoot, lanes: Lanes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext</span><br><span class="line">  executionContext |= RenderContext</span><br><span class="line">  <span class="keyword">const</span> prevDispatcher = pushDispatcher()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the root or lanes have changed, throw out the existing stack</span></span><br><span class="line">  <span class="comment">// and prepare a fresh one. Otherwise we'll continue where we left off.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRoot !== root || workInProgressRootRenderLanes !== lanes) &#123;</span><br><span class="line">    prepareFreshStack(root, lanes) <span class="comment">// 更新 context</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    markRenderStarted(lanes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      workLoopSync()</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (thrownValue) &#123;</span><br><span class="line">      handleError(root, thrownValue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">  resetContextDependencies()</span><br><span class="line">  executionContext = prevExecutionContext</span><br><span class="line">  popDispatcher(prevDispatcher)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    markRenderStopped()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set this to null to indicate there's no in-progress render.</span></span><br><span class="line">  workInProgressRoot = <span class="literal">null</span></span><br><span class="line">  workInProgressRootRenderLanes = NoLanes</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgressRootExitStatus</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="workLoopSync"><a href="#workLoopSync" class="headerlink" title="workLoopSync"></a><code>workLoopSync</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="comment">// workInProgress 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoopSync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Already timed out, so perform work without checking if we need to yield.</span></span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    performUnitOfWork(workInProgress)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="performUnitOfWork"><a href="#performUnitOfWork" class="headerlink" title="performUnitOfWork"></a><code>performUnitOfWork</code></h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 执行更新任务</span></span><br><span class="line">  <span class="keyword">const</span> current = unitOfWork.alternate</span><br><span class="line">  <span class="keyword">let</span> next = beginWork(current, unitOfWork, subtreeRenderLanes) <span class="comment">// child</span></span><br><span class="line">  unitOfWork.memoizedProps = unitOfWork.pendingProps</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 没有下一个任务时表示任务已经做完</span></span><br><span class="line">    completeUnitOfWork(unitOfWork)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    workInProgress = next</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ReactCurrentOwner.current = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="beginWork"><a href="#beginWork" class="headerlink" title="beginWork"></a><code>beginWork</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberBeginWork.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> updateLanes = workInProgress.lanes</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> oldProps = current.memoizedProps</span><br><span class="line">    <span class="keyword">const</span> newProps = workInProgress.pendingProps</span><br><span class="line">    <span class="keyword">if</span> (oldProps !== newProps || hasLegacyContextChanged()) &#123;</span><br><span class="line">      <span class="comment">// props 更新或 context 更新</span></span><br><span class="line">      didReceiveUpdate = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!includesSomeLane(renderLanes, updateLanes)) &#123;</span><br><span class="line">      didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// 此次渲染的更新和等待的更新没有任何交集，新增等待的更新等待下次执行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 其它更新逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    didReceiveUpdate = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空</span></span><br><span class="line">  workInProgress.lanes = NoLanes</span><br><span class="line">  <span class="keyword">switch</span> (workInProgress.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> Component = workInProgress.type</span><br><span class="line">      <span class="keyword">const</span> unresolvedProps = workInProgress.pendingProps</span><br><span class="line">      <span class="keyword">const</span> resolvedProps =</span><br><span class="line">        workInProgress.elementType === Component</span><br><span class="line">          ? unresolvedProps</span><br><span class="line">          : resolveDefaultProps(Component, unresolvedProps)</span><br><span class="line">      <span class="keyword">return</span> updateClassComponent(</span><br><span class="line">        current,</span><br><span class="line">        workInProgress,</span><br><span class="line">        Component,</span><br><span class="line">        resolvedProps,</span><br><span class="line">        renderLanes</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其它类型组件更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="updateClassComponent"><a href="#updateClassComponent" class="headerlink" title="updateClassComponent"></a>updateClassComponent</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberBeginWork.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | null,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextProps: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 提取 context</span></span><br><span class="line">  <span class="keyword">let</span> hasContext</span><br><span class="line">  <span class="keyword">if</span> (isLegacyContextProvider(Component)) &#123;</span><br><span class="line">    hasContext = <span class="literal">true</span></span><br><span class="line">    pushLegacyContextProvider(workInProgress)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    hasContext = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  prepareToReadContext(workInProgress, renderLanes)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.stateNode</span><br><span class="line">  <span class="keyword">let</span> shouldUpdate</span><br><span class="line">  <span class="keyword">if</span> (instance === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 挂载</span></span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// A class component without an instance only mounts if it suspended</span></span><br><span class="line">      <span class="comment">// inside a non-concurrent tree, in an inconsistent state. We want to</span></span><br><span class="line">      <span class="comment">// treat it like a new mount, even though an empty version of it already</span></span><br><span class="line">      <span class="comment">// committed. Disconnect the alternate pointers.</span></span><br><span class="line">      current.alternate = <span class="literal">null</span></span><br><span class="line">      workInProgress.alternate = <span class="literal">null</span></span><br><span class="line">      <span class="comment">// Since this is conceptually a new fiber, schedule a Placement effect</span></span><br><span class="line">      workInProgress.flags |= Placement</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// In the initial pass we might need to construct the instance.</span></span><br><span class="line">    constructClassInstance(workInProgress, Component, nextProps)</span><br><span class="line">    mountClassInstance(workInProgress, Component, nextProps, renderLanes)</span><br><span class="line">    shouldUpdate = <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// In a resume, we'll already have an instance we can reuse.</span></span><br><span class="line">    shouldUpdate = resumeMountClassInstance(</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//   更新</span></span><br><span class="line">    shouldUpdate = updateClassInstance(</span><br><span class="line">      current,</span><br><span class="line">      workInProgress,</span><br><span class="line">      Component,</span><br><span class="line">      nextProps,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> nextUnitOfWork = finishClassComponent(</span><br><span class="line">    current,</span><br><span class="line">    workInProgress,</span><br><span class="line">    Component,</span><br><span class="line">    shouldUpdate,</span><br><span class="line">    hasContext,</span><br><span class="line">    renderLanes</span><br><span class="line">  ) <span class="comment">// child</span></span><br><span class="line">  <span class="keyword">return</span> nextUnitOfWork</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="constructClassInstance"><a href="#constructClassInstance" class="headerlink" title="constructClassInstance"></a><code>constructClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">constructClassInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  ctor: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  props: <span class="built_in">any</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> isLegacyContextConsumer = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> unmaskedContext = emptyContextObject</span><br><span class="line">  <span class="keyword">let</span> context = emptyContextObject</span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.contextType</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取 context</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">'object'</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    context = readContext(contextType)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!disableLegacyContext) &#123;</span><br><span class="line">    unmaskedContext = getUnmaskedContext(workInProgress, ctor, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">const</span> contextTypes = ctor.contextTypes</span><br><span class="line">    isLegacyContextConsumer =</span><br><span class="line">      contextTypes !== <span class="literal">null</span> &amp;&amp; contextTypes !== <span class="literal">undefined</span></span><br><span class="line">    context = isLegacyContextConsumer</span><br><span class="line">      ? getMaskedContext(workInProgress, unmaskedContext)</span><br><span class="line">      : emptyContextObject</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建组件实例</span></span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">new</span> ctor(props, context)</span><br><span class="line">  <span class="keyword">const</span> state = (workInProgress.memoizedState =</span><br><span class="line">    instance.state !== <span class="literal">null</span> &amp;&amp; instance.state !== <span class="literal">undefined</span></span><br><span class="line">      ? instance.state</span><br><span class="line">      : <span class="literal">null</span>)</span><br><span class="line">  <span class="comment">// fiber 注入更新队列和实例信息，存储实例和 fiber 映射</span></span><br><span class="line">  adoptClassInstance(workInProgress, instance)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 缓存 context</span></span><br><span class="line">  <span class="keyword">if</span> (isLegacyContextConsumer) &#123;</span><br><span class="line">    cacheContext(workInProgress, unmaskedContext, context)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> instance</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="adoptClassInstance"><a href="#adoptClassInstance" class="headerlink" title="adoptClassInstance"></a><code>adoptClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">adoptClassInstance</span>(<span class="params">workInProgress: Fiber, instance: <span class="built_in">any</span></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  instance.updater = classComponentUpdater <span class="comment">// 更新队列</span></span><br><span class="line">  workInProgress.stateNode = instance <span class="comment">// 存储组件实例</span></span><br><span class="line">  <span class="comment">//构建 fiber 和组件实例的映射</span></span><br><span class="line">  setInstance(instance, workInProgress)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="mountClassInstance"><a href="#mountClassInstance" class="headerlink" title="mountClassInstance"></a><code>mountClassInstance</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mountClassInstance</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  ctor: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  newProps: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.stateNode</span><br><span class="line">  instance.props = newProps</span><br><span class="line">  instance.state = workInProgress.memoizedState</span><br><span class="line">  instance.refs = emptyRefsObject</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化队列</span></span><br><span class="line">  initializeUpdateQueue(workInProgress)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 context</span></span><br><span class="line">  <span class="keyword">const</span> contextType = ctor.contextType</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> contextType === <span class="string">'object'</span> &amp;&amp; contextType !== <span class="literal">null</span>) &#123;</span><br><span class="line">    instance.context = readContext(contextType)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (disableLegacyContext) &#123;</span><br><span class="line">    instance.context = emptyContextObject</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> unmaskedContext = getUnmaskedContext(workInProgress, ctor, <span class="literal">true</span>)</span><br><span class="line">    instance.context = getMaskedContext(workInProgress, unmaskedContext)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 更新 state</span></span><br><span class="line">  instance.state = workInProgress.memoizedState</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 getDerivedStateFromProps 更新 state</span></span><br><span class="line">  <span class="keyword">const</span> getDerivedStateFromProps = ctor.getDerivedStateFromProps</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> getDerivedStateFromProps === <span class="string">'function'</span>) &#123;</span><br><span class="line">    applyDerivedStateFromProps(</span><br><span class="line">      workInProgress,</span><br><span class="line">      ctor,</span><br><span class="line">      getDerivedStateFromProps,</span><br><span class="line">      newProps</span><br><span class="line">    )</span><br><span class="line">    instance.state = workInProgress.memoizedState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行 componentWillMount 生命周期</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> ctor.getDerivedStateFromProps !== <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> instance.getSnapshotBeforeUpdate !== <span class="string">'function'</span> &amp;&amp;</span><br><span class="line">    (<span class="keyword">typeof</span> instance.UNSAFE_componentWillMount === <span class="string">'function'</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> instance.componentWillMount === <span class="string">'function'</span>)</span><br><span class="line">  ) &#123;</span><br><span class="line">    callComponentWillMount(workInProgress, instance)</span><br><span class="line">    <span class="comment">// componentWillMount 执行 setState 时立即更新 state</span></span><br><span class="line">    processUpdateQueue(workInProgress, newProps, instance, renderLanes)</span><br><span class="line">    instance.state = workInProgress.memoizedState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.componentDidMount === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> fiberFlags: Flags = Update</span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics) &#123;</span><br><span class="line">      fiberFlags |= LayoutStatic</span><br><span class="line">    &#125;</span><br><span class="line">    workInProgress.flags |= fiberFlags</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="finishClassComponent"><a href="#finishClassComponent" class="headerlink" title="finishClassComponent"></a><code>finishClassComponent</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finishClassComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  Component: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  shouldUpdate: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  hasContext: <span class="built_in">boolean</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Refs should update even if shouldComponentUpdate returns false</span></span><br><span class="line">  markRef(current, workInProgress)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> didCaptureError = (workInProgress.flags &amp; DidCapture) !== NoFlags</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shouldUpdate &amp;&amp; !didCaptureError) &#123;</span><br><span class="line">    <span class="keyword">return</span> bailoutOnAlreadyFinishedWork(current, workInProgress, renderLanes)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> instance = workInProgress.stateNode</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Rerender</span></span><br><span class="line">  ReactCurrentOwner.current = workInProgress</span><br><span class="line">  <span class="keyword">let</span> nextChildren</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    didCaptureError &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> Component.getDerivedStateFromError !== <span class="string">'function'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// 错误处理</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nextChildren = instance.render()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reconcileChildren(current, workInProgress, nextChildren, renderLanes)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 记录 state</span></span><br><span class="line">  workInProgress.memoizedState = instance.state</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> workInProgress.child</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="reconcileChildren"><a href="#reconcileChildren" class="headerlink" title="reconcileChildren"></a><code>reconcileChildren</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberClassComponent.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reconcileChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  workInProgress: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nextChildren: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (current === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 挂载</span></span><br><span class="line">    workInProgress.child = mountChildFibers(</span><br><span class="line">      workInProgress,</span><br><span class="line">      <span class="literal">null</span>,</span><br><span class="line">      nextChildren,</span><br><span class="line">      renderLanes</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="ChildReconciler"><a href="#ChildReconciler" class="headerlink" title="ChildReconciler"></a><code>ChildReconciler</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactChildFiber.old.js</span></span><br><span class="line"><span class="keyword">const</span> mountChildFibers = ChildReconciler(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ChildReconciler</span>(<span class="params">shouldTrackSideEffects</span>) </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">deleteChild</span>(<span class="params">returnFiber: Fiber, childToDelete: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">deleteRemainingChildren</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">useFiber</span>(<span class="params">fiber: Fiber, pendingProps: mixed</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> clone = createWorkInProgress(fiber, pendingProps) <span class="comment">// 构建一个新的 fiber 节点</span></span><br><span class="line">    clone.index = <span class="number">0</span></span><br><span class="line">    clone.sibling = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">return</span> clone</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">placeChild</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    newFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    lastPlacedIndex: <span class="built_in">number</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    newIndex: <span class="built_in">number</span></span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">    newFiber.index = newIndex</span><br><span class="line">    <span class="keyword">if</span> (!shouldTrackSideEffects) &#123;</span><br><span class="line">      <span class="keyword">return</span> lastPlacedIndex</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 更新逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回 fiber</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">placeSingleChild</span>(<span class="params">newFiber: Fiber</span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> newFiber</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleTextNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    textContent: <span class="built_in">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    lanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="comment">// There's no need to check for keys on text nodes since we don't have a</span></span><br><span class="line">    <span class="comment">// way to define them.</span></span><br><span class="line">    <span class="keyword">if</span> (currentFirstChild !== <span class="literal">null</span> &amp;&amp; currentFirstChild.tag === HostText) &#123;</span><br><span class="line">      <span class="comment">// We already have an existing node so let's just update it and delete</span></span><br><span class="line">      <span class="comment">// the rest.</span></span><br><span class="line">      deleteRemainingChildren(returnFiber, currentFirstChild.sibling)</span><br><span class="line">      <span class="keyword">const</span> existing = useFiber(currentFirstChild, textContent)</span><br><span class="line">      existing.return = returnFiber</span><br><span class="line">      <span class="keyword">return</span> existing</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// The existing first child is not a text node so we need to create one</span></span><br><span class="line">    <span class="comment">// and delete the existing ones.</span></span><br><span class="line">    deleteRemainingChildren(returnFiber, currentFirstChild)</span><br><span class="line">    <span class="keyword">const</span> created = createFiberFromText(textContent, returnFiber.mode, lanes)</span><br><span class="line">    created.return = returnFiber</span><br><span class="line">    <span class="keyword">return</span> created</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 fiber</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileSingleElement</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    element: ReactElement,</span></span></span><br><span class="line"><span class="function"><span class="params">    lanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> key = element.key</span><br><span class="line">    <span class="keyword">let</span> child = currentFirstChild</span><br><span class="line">    <span class="keyword">while</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> If key === null and child.key === null, then this only applies to</span></span><br><span class="line">      <span class="comment">// the first item in the list.</span></span><br><span class="line">      <span class="keyword">if</span> (child.key === key) &#123;</span><br><span class="line">        <span class="keyword">const</span> elementType = element.type</span><br><span class="line">        <span class="keyword">if</span> (elementType === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">          <span class="keyword">if</span> (child.tag === Fragment) &#123;</span><br><span class="line">            deleteRemainingChildren(returnFiber, child.sibling)</span><br><span class="line">            <span class="keyword">const</span> existing = useFiber(child, element.props.children)</span><br><span class="line">            existing.return = returnFiber</span><br><span class="line">            <span class="keyword">return</span> existing</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (</span><br><span class="line">            child.elementType === elementType ||</span><br><span class="line">            (enableLazyElements &amp;&amp;</span><br><span class="line">              <span class="keyword">typeof</span> elementType === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">              elementType !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">              elementType.$$<span class="keyword">typeof</span> === REACT_LAZY_TYPE &amp;&amp;</span><br><span class="line">              resolveLazy(elementType) === child.type)</span><br><span class="line">          ) &#123;</span><br><span class="line">            deleteRemainingChildren(returnFiber, child.sibling)</span><br><span class="line">            <span class="keyword">const</span> existing = useFiber(child, element.props)</span><br><span class="line">            existing.ref = coerceRef(returnFiber, child, element)</span><br><span class="line">            existing.return = returnFiber</span><br><span class="line">            <span class="keyword">return</span> existing</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Didn't match.</span></span><br><span class="line">        deleteRemainingChildren(returnFiber, child)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        deleteChild(returnFiber, child)</span><br><span class="line">      &#125;</span><br><span class="line">      child = child.sibling</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element.type === REACT_FRAGMENT_TYPE) &#123;</span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromFragment(</span><br><span class="line">        element.props.children,</span><br><span class="line">        returnFiber.mode,</span><br><span class="line">        lanes,</span><br><span class="line">        element.key</span><br><span class="line">      )</span><br><span class="line">      created.return = returnFiber</span><br><span class="line">      <span class="keyword">return</span> created</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> created = createFiberFromElement(element, returnFiber.mode, lanes)</span><br><span class="line">      created.ref = coerceRef(returnFiber, currentFirstChild, element)</span><br><span class="line">      created.return = returnFiber</span><br><span class="line">      <span class="keyword">return</span> created</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建 children fiber</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reconcileChildFibers</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    returnFiber: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">    currentFirstChild: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    newChild: <span class="built_in">any</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    lanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Fiber</span> | <span class="title">null</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 处理 &lt;&gt;&#123;[...]&#125;&lt;/&gt; 和 &lt;&gt;...&lt;/&gt; 组件，从其中提取 children</span></span><br><span class="line">    <span class="keyword">const</span> isUnkeyedTopLevelFragment =</span><br><span class="line">      <span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">      newChild !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      newChild.type === REACT_FRAGMENT_TYPE &amp;&amp;</span><br><span class="line">      newChild.key === <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (isUnkeyedTopLevelFragment) &#123;</span><br><span class="line">      newChild = newChild.props.children</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对象类型，为 react 组件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'object'</span> &amp;&amp; newChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (newChild.$$<span class="keyword">typeof</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> REACT_ELEMENT_TYPE:</span><br><span class="line">          <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">            reconcileSingleElement(</span><br><span class="line">              returnFiber,</span><br><span class="line">              currentFirstChild,</span><br><span class="line">              newChild,</span><br><span class="line">              lanes</span><br><span class="line">            )</span><br><span class="line">          )</span><br><span class="line">        <span class="comment">// 其它 react 组件类型</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 数组、迭代器，支持 promise 或者 generate</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> newChild === <span class="string">'string'</span> || <span class="keyword">typeof</span> newChild === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="comment">// 处理字符串或数字类型</span></span><br><span class="line">      <span class="keyword">return</span> placeSingleChild(</span><br><span class="line">        reconcileSingleTextNode(</span><br><span class="line">          returnFiber,</span><br><span class="line">          currentFirstChild,</span><br><span class="line">          <span class="string">''</span> + newChild,</span><br><span class="line">          lanes</span><br><span class="line">        )</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remaining cases are all treated as empty.</span></span><br><span class="line">    <span class="keyword">return</span> deleteRemainingChildren(returnFiber, currentFirstChild)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> reconcileChildFibers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="completeUnitOfWork"><a href="#completeUnitOfWork" class="headerlink" title="completeUnitOfWork"></a><code>completeUnitOfWork</code></h5><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberWorkLoop.old.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">unitOfWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> completedWork = unitOfWork</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> current = completedWork.alternate <span class="comment">// 更新后的 fiber</span></span><br><span class="line">    <span class="keyword">const</span> returnFiber = completedWork.return <span class="comment">// 父节点 fiber</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((completedWork.flags &amp; Incomplete) === NoFlags) &#123;</span><br><span class="line">      <span class="comment">// 任务未完成</span></span><br><span class="line">      <span class="keyword">let</span> next = completeWork(current, completedWork, subtreeRenderLanes)</span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Completing this fiber spawned new work. Work on that next.</span></span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This fiber did not complete because something threw. Pop values off</span></span><br><span class="line">      <span class="comment">// the stack without entering the complete phase. If this is a boundary,</span></span><br><span class="line">      <span class="comment">// capture values if possible.</span></span><br><span class="line">      <span class="keyword">const</span> next = unwindWork(completedWork, subtreeRenderLanes)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Because this fiber did not complete, don't reset its expiration time.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// If completing this work spawned new work, do that next. We'll come</span></span><br><span class="line">        <span class="comment">// back here again.</span></span><br><span class="line">        <span class="comment">// Since we're restarting, remove anything that is not a host effect</span></span><br><span class="line">        <span class="comment">// from the effect tag.</span></span><br><span class="line">        next.flags &amp;= HostEffectMask</span><br><span class="line">        workInProgress = next</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Mark the parent fiber as incomplete and clear its subtree flags.</span></span><br><span class="line">        returnFiber.flags |= Incomplete</span><br><span class="line">        returnFiber.subtreeFlags = NoFlags</span><br><span class="line">        returnFiber.deletions = <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> siblingFiber = completedWork.sibling</span><br><span class="line">    <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">      workInProgress = siblingFiber</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise, return to the parent</span></span><br><span class="line">    completedWork = returnFiber</span><br><span class="line">    <span class="comment">// Update the next thing we're working on in case something throws.</span></span><br><span class="line">    workInProgress = completedWork</span><br><span class="line">  &#125; <span class="keyword">while</span> (completedWork !== <span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We've reached the root.</span></span><br><span class="line">  <span class="keyword">if</span> (workInProgressRootExitStatus === RootIncomplete) &#123;</span><br><span class="line">    workInProgressRootExitStatus = RootCompleted</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="commitRoot"><a href="#commitRoot" class="headerlink" title="commitRoot"></a><code>commitRoot</code></h5><p>调用 <code>commitRootImpl</code> 提交更新</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitRootImpl</span>(<span class="params">root, renderPriorityLevel</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// `flushPassiveEffects` will call `flushSyncUpdateQueue` at the end, which</span></span><br><span class="line">    <span class="comment">// means `flushPassiveEffects` will sometimes result in additional</span></span><br><span class="line">    <span class="comment">// passive effects. So we need to keep flushing in a loop until there are</span></span><br><span class="line">    <span class="comment">// no more pending effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Might be better if `flushPassiveEffects` did not automatically</span></span><br><span class="line">    <span class="comment">// flush synchronous work at the end, to avoid factoring hazards like this.</span></span><br><span class="line">    flushPassiveEffects();</span><br><span class="line">  &#125; <span class="keyword">while</span> (rootWithPendingPassiveEffects !== <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> finishedWork = root.finishedWork;</span><br><span class="line">  <span class="keyword">const</span> lanes = root.finishedLanes;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (finishedWork === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  root.finishedWork = <span class="literal">null</span>;</span><br><span class="line">  root.finishedLanes = NoLanes;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// commitRoot never returns a continuation; it always finishes synchronously.</span></span><br><span class="line">  <span class="comment">// So we can clear these now to allow a new callback to be scheduled.</span></span><br><span class="line">  root.callbackNode = <span class="literal">null</span>;</span><br><span class="line">  root.callbackPriority = NoLane;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update the first and last pending times on this root. The new first</span></span><br><span class="line">  <span class="comment">// pending time is whatever is left on the root fiber.</span></span><br><span class="line">  <span class="keyword">let</span> remainingLanes = mergeLanes(finishedWork.lanes, finishedWork.childLanes);</span><br><span class="line">  markRootFinished(root, remainingLanes);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (root === workInProgressRoot) &#123;</span><br><span class="line">    <span class="comment">// We can reset these now that they are finished.</span></span><br><span class="line">    workInProgressRoot = <span class="literal">null</span>;</span><br><span class="line">    workInProgress = <span class="literal">null</span>;</span><br><span class="line">    workInProgressRootRenderLanes = NoLanes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If there are pending passive effects, schedule a callback to process them.</span></span><br><span class="line">  <span class="comment">// Do this as early as possible, so it is queued before anything else that</span></span><br><span class="line">  <span class="comment">// might get scheduled in the commit phase. (See #16714.)</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Delete all other places that schedule the passive effect callback</span></span><br><span class="line">  <span class="comment">// They're redundant.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (finishedWork.subtreeFlags &amp; PassiveMask) !== NoFlags ||</span><br><span class="line">    (finishedWork.flags &amp; PassiveMask) !== NoFlags</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rootDoesHavePassiveEffects) &#123;</span><br><span class="line">      rootDoesHavePassiveEffects = <span class="literal">true</span>;</span><br><span class="line">      scheduleCallback(NormalSchedulerPriority, <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        flushPassiveEffects();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there are any effects in the whole tree.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This is left over from the effect list implementation, where we had</span></span><br><span class="line">  <span class="comment">// to check for the existence of `firstEffect` to satsify Flow. I think the</span></span><br><span class="line">  <span class="comment">// only other reason this optimization exists is because it affects profiling.</span></span><br><span class="line">  <span class="comment">// Reconsider whether this is necessary.</span></span><br><span class="line">  <span class="keyword">const</span> subtreeHasEffects =</span><br><span class="line">    (finishedWork.subtreeFlags &amp;</span><br><span class="line">      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==</span><br><span class="line">    NoFlags;</span><br><span class="line">  <span class="keyword">const</span> rootHasEffect =</span><br><span class="line">    (finishedWork.flags &amp;</span><br><span class="line">      (BeforeMutationMask | MutationMask | LayoutMask | PassiveMask)) !==</span><br><span class="line">    NoFlags;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (subtreeHasEffects || rootHasEffect) &#123;</span><br><span class="line">    <span class="keyword">const</span> prevTransition = ReactCurrentBatchConfig.transition;</span><br><span class="line">    ReactCurrentBatchConfig.transition = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">const</span> previousPriority = getCurrentUpdatePriority();</span><br><span class="line">    setCurrentUpdatePriority(DiscreteEventPriority);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">    executionContext |= CommitContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset this to null before calling lifecycles</span></span><br><span class="line">    ReactCurrentOwner.current = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The commit phase is broken into several sub-phases. We do a separate pass</span></span><br><span class="line">    <span class="comment">// of the effect list for each phase: all mutation effects come before all</span></span><br><span class="line">    <span class="comment">// layout effects, and so on.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The first phase a "before mutation" phase. We use this phase to read the</span></span><br><span class="line">    <span class="comment">// state of the host tree right before we mutate it. This is where</span></span><br><span class="line">    <span class="comment">// getSnapshotBeforeUpdate is called.</span></span><br><span class="line">    <span class="keyword">const</span> shouldFireAfterActiveInstanceBlur = commitBeforeMutationEffects(</span><br><span class="line">      root,</span><br><span class="line">      finishedWork,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      <span class="comment">// Mark the current commit time to be shared by all Profilers in this</span></span><br><span class="line">      <span class="comment">// batch. This enables them to be grouped later.</span></span><br><span class="line">      recordCommitTime();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">      <span class="comment">// Track the root here, rather than in commitLayoutEffects(), because of ref setters.</span></span><br><span class="line">      <span class="comment">// Updates scheduled during ref detachment should also be flagged.</span></span><br><span class="line">      rootCommittingMutationOrLayoutEffects = root;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The next phase is the mutation phase, where we mutate the host tree.</span></span><br><span class="line">    commitMutationEffects(root, finishedWork, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldFireAfterActiveInstanceBlur) &#123;</span><br><span class="line">      afterActiveInstanceBlur();</span><br><span class="line">    &#125;</span><br><span class="line">    resetAfterCommit(root.containerInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The work-in-progress tree is now the current tree. This must come after</span></span><br><span class="line">    <span class="comment">// the mutation phase, so that the previous tree is still current during</span></span><br><span class="line">    <span class="comment">// componentWillUnmount, but before the layout phase, so that the finished</span></span><br><span class="line">    <span class="comment">// work is current during componentDidMount/Update.</span></span><br><span class="line">    root.current = finishedWork;</span><br><span class="line">    commitLayoutEffects(finishedWork, root, lanes);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdateScheduledHook) &#123;</span><br><span class="line">      rootCommittingMutationOrLayoutEffects = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Tell Scheduler to yield at the end of the frame, so the browser has an</span></span><br><span class="line">    <span class="comment">// opportunity to paint.</span></span><br><span class="line">    requestPaint();</span><br><span class="line"></span><br><span class="line">    executionContext = prevExecutionContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the priority to the previous non-sync value.</span></span><br><span class="line">    setCurrentUpdatePriority(previousPriority);</span><br><span class="line">    ReactCurrentBatchConfig.transition = prevTransition;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No effects.</span></span><br><span class="line">    root.current = finishedWork;</span><br><span class="line">    <span class="comment">// Measure these anyway so the flamegraph explicitly shows that there were</span></span><br><span class="line">    <span class="comment">// no effects.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Maybe there's a better way to report this.</span></span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer) &#123;</span><br><span class="line">      recordCommitTime();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rootDidHavePassiveEffects = rootDoesHavePassiveEffects;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rootDoesHavePassiveEffects) &#123;</span><br><span class="line">    <span class="comment">// This commit has passive effects. Stash a reference to them. But don't</span></span><br><span class="line">    <span class="comment">// schedule a callback until after flushing layout work.</span></span><br><span class="line">    rootDoesHavePassiveEffects = <span class="literal">false</span>;</span><br><span class="line">    rootWithPendingPassiveEffects = root;</span><br><span class="line">    pendingPassiveEffectsLanes = lanes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read this again, since an effect might have updated it</span></span><br><span class="line">  remainingLanes = root.pendingLanes;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check if there's remaining work on this root</span></span><br><span class="line">  <span class="keyword">if</span> (remainingLanes === NoLanes) &#123;</span><br><span class="line">    <span class="comment">// If there's no remaining work, we can clear the set of already failed</span></span><br><span class="line">    <span class="comment">// error boundaries.</span></span><br><span class="line">    legacyErrorBoundariesThatAlreadyFailed = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (includesSomeLane(remainingLanes, (SyncLane: Lane))) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerNestedUpdatePhase) &#123;</span><br><span class="line">      markNestedUpdateScheduled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Count the number of times the root synchronously re-renders without</span></span><br><span class="line">    <span class="comment">// finishing. If there are too many, it indicates an infinite update loop.</span></span><br><span class="line">    <span class="keyword">if</span> (root === rootWithNestedUpdates) &#123;</span><br><span class="line">      nestedUpdateCount++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">      rootWithNestedUpdates = root;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nestedUpdateCount = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Always call this before exiting `commitRoot`, to ensure that any</span></span><br><span class="line">  <span class="comment">// additional work on this root is scheduled.</span></span><br><span class="line">  ensureRootIsScheduled(root, now());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasUncaughtError) &#123;</span><br><span class="line">    hasUncaughtError = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> error = firstUncaughtError;</span><br><span class="line">    firstUncaughtError = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">throw</span> error;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((executionContext &amp; LegacyUnbatchedContext) !== NoContext) &#123;</span><br><span class="line">    <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">      markCommitStopped();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This is a legacy edge case. We just committed the initial mount of</span></span><br><span class="line">    <span class="comment">// a ReactDOM.render-ed root inside of batchedUpdates. The commit fired</span></span><br><span class="line">    <span class="comment">// synchronously, but layout updates should be deferred until the end</span></span><br><span class="line">    <span class="comment">// of the batch.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If the passive effects are the result of a discrete render, flush them</span></span><br><span class="line">  <span class="comment">// synchronously at the end of the current task so that the result is</span></span><br><span class="line">  <span class="comment">// immediately observable. Otherwise, we assume that they are not</span></span><br><span class="line">  <span class="comment">// order-dependent and do not need to be observed by external systems, so we</span></span><br><span class="line">  <span class="comment">// can wait until after paint.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> We can optimize this by not scheduling the callback earlier. Since we</span></span><br><span class="line">  <span class="comment">// currently schedule the callback in multiple places, will wait until those</span></span><br><span class="line">  <span class="comment">// are consolidated.</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    includesSomeLane(pendingPassiveEffectsLanes, SyncLane) &amp;&amp;</span><br><span class="line">    root.tag !== LegacyRoot</span><br><span class="line">  ) &#123;</span><br><span class="line">    flushPassiveEffects();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If layout work was scheduled, flush it now.</span></span><br><span class="line">  flushSyncCallbacks();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulingProfiler) &#123;</span><br><span class="line">    markCommitStopped();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="flushPassiveEffects"><a href="#flushPassiveEffects" class="headerlink" title="flushPassiveEffects"></a><code>flushPassiveEffects</code></h5><p>调用 <code>flushPassiveEffectsImpl</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushPassiveEffectsImpl</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (rootWithPendingPassiveEffects === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = rootWithPendingPassiveEffects;</span><br><span class="line">  <span class="keyword">const</span> lanes = pendingPassiveEffectsLanes;</span><br><span class="line">  rootWithPendingPassiveEffects = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This is sometimes out of sync with rootWithPendingPassiveEffects.</span></span><br><span class="line">  <span class="comment">// Figure out why and fix it. It's not causing any known issues (probably</span></span><br><span class="line">  <span class="comment">// because it's only used for profiling), but it's a refactor hazard.</span></span><br><span class="line">  pendingPassiveEffectsLanes = NoLanes;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prevExecutionContext = executionContext;</span><br><span class="line">  executionContext |= CommitContext;</span><br><span class="line"></span><br><span class="line">  commitPassiveUnmountEffects(root.current);</span><br><span class="line">  commitPassiveMountEffects(root, root.current);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Move to commitPassiveMountEffects</span></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> profilerEffects = pendingPassiveProfilerEffects;</span><br><span class="line">    pendingPassiveProfilerEffects = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; profilerEffects.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> fiber = ((profilerEffects[i]: <span class="built_in">any</span>): Fiber);</span><br><span class="line">      commitPassiveEffectDurations(root, fiber);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  executionContext = prevExecutionContext;</span><br><span class="line">  flushSyncCallbacks();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If additional passive effects were scheduled, increment a counter. If this</span></span><br><span class="line">  <span class="comment">// exceeds the limit, we'll fire a warning.</span></span><br><span class="line">  nestedPassiveUpdateCount =</span><br><span class="line">    rootWithPendingPassiveEffects === <span class="literal">null</span> ? <span class="number">0</span> : nestedPassiveUpdateCount + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableProfilerTimer &amp;&amp; enableProfilerCommitHooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = root.current.stateNode;</span><br><span class="line">    stateNode.effectDuration = <span class="number">0</span>;</span><br><span class="line">    stateNode.passiveEffectDuration = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="commitPassiveUnmountEffects"><a href="#commitPassiveUnmountEffects" class="headerlink" title="commitPassiveUnmountEffects"></a><code>commitPassiveUnmountEffects</code></h5><p>执行生命周期钩子，当进入节点时立即执行生命周期函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<p>调用 <code>commitPassiveUnmountEffects_begin</code> 开启操作，<code>commitPassiveUnmountEffects_complete</code> 完成操作</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffects_begin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// curr -&gt; child -&gt; child</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((nextEffect.flags &amp; ChildDeletion) !== NoFlags) &#123;</span><br><span class="line">      <span class="keyword">const</span> deletions = fiber.deletions</span><br><span class="line">      <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.length; i++) &#123;</span><br><span class="line">          <span class="keyword">const</span> fiberToDelete = deletions[i]</span><br><span class="line">          nextEffect = fiberToDelete</span><br><span class="line">          commitPassiveUnmountEffectsInsideOfDeletedTree_begin(</span><br><span class="line">            fiberToDelete,</span><br><span class="line">            fiber</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="comment">// A fiber was deleted from this parent fiber, but it's still part of</span></span><br><span class="line">          <span class="comment">// the previous (alternate) parent fiber's list of children. Because</span></span><br><span class="line">          <span class="comment">// children are a linked list, an earlier sibling that's still alive</span></span><br><span class="line">          <span class="comment">// will be connected to the deleted fiber via its `alternate`:</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">//   live fiber</span></span><br><span class="line">          <span class="comment">//   --alternate--&gt; previous live fiber</span></span><br><span class="line">          <span class="comment">//   --sibling--&gt; deleted fiber</span></span><br><span class="line">          <span class="comment">//</span></span><br><span class="line">          <span class="comment">// We can't disconnect `alternate` on nodes that haven't been deleted</span></span><br><span class="line">          <span class="comment">// yet, but we can disconnect the `sibling` and `child` pointers.</span></span><br><span class="line">          <span class="keyword">const</span> previousFiber = fiber.alternate</span><br><span class="line">          <span class="keyword">if</span> (previousFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> detachedChild = previousFiber.child</span><br><span class="line">            <span class="keyword">if</span> (detachedChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">              previousFiber.child = <span class="literal">null</span></span><br><span class="line">              <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> detachedSibling = detachedChild.sibling</span><br><span class="line">                detachedChild.sibling = <span class="literal">null</span></span><br><span class="line">                detachedChild = detachedSibling</span><br><span class="line">              &#125; <span class="keyword">while</span> (detachedChild !== <span class="literal">null</span>)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        nextEffect = fiber</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.subtreeFlags &amp; PassiveMask) !== NoFlags &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber) <span class="comment">// 确保父节点指向 fiber</span></span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitPassiveUnmountEffects_complete()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffects_complete</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 若存在兄弟节点则遍历下一个兄弟节点，否则返回父节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">if</span> ((fiber.flags &amp; Passive) !== NoFlags) &#123;</span><br><span class="line">      commitPassiveUnmountOnFiber(fiber)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountOnFiber</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        commitHookEffectListUnmount(</span><br><span class="line">          HookPassive | HookHasEffect,</span><br><span class="line">          finishedWork,</span><br><span class="line">          finishedWork.return,</span><br><span class="line">        );</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  deletedSubtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nearestMountedAncestor: Fiber | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// p-&gt; child -&gt; child</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="comment">// Deletion effects fire in parent -&gt; child order</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Check if fiber has a PassiveStatic flag</span></span><br><span class="line">    commitPassiveUnmountInsideDeletedTreeOnFiber(fiber, nearestMountedAncestor)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Only traverse subtree if it has a PassiveStatic flag. (But, if we</span></span><br><span class="line">    <span class="comment">// do this, still need to handle `deletedTreeCleanUpLevel` correctly.)</span></span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitPassiveUnmountEffectsInsideOfDeletedTree_complete(</span><br><span class="line">        deletedSubtreeRoot</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountInsideDeletedTreeOnFiber</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  current: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nearestMountedAncestor: Fiber | <span class="literal">null</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (current.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      commitHookEffectListUnmount(HookPassive, current, nearestMountedAncestor)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁组件，要销毁的组件存在 updateQueue 中</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitHookEffectListUnmount</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  flags: HookFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  nearestMountedAncestor: Fiber | <span class="literal">null</span>,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> updateQueue: FunctionComponentUpdateQueue | <span class="literal">null</span> = (finishedWork.updateQueue: <span class="built_in">any</span>);</span><br><span class="line">  <span class="keyword">const</span> lastEffect = updateQueue !== <span class="literal">null</span> ? updateQueue.lastEffect : <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (lastEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> firstEffect = lastEffect.next;</span><br><span class="line">    <span class="keyword">let</span> effect = firstEffect;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ((effect.tag &amp; flags) === flags) &#123;</span><br><span class="line">        <span class="comment">// Unmount</span></span><br><span class="line">        <span class="keyword">const</span> destroy = effect.destroy;</span><br><span class="line">        effect.destroy = <span class="literal">undefined</span>;</span><br><span class="line">        <span class="keyword">if</span> (destroy !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">          safelyCallDestroy(finishedWork, nearestMountedAncestor, destroy); <span class="comment">// 调用 destroy 销毁组件</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      effect = effect.next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (effect !== firstEffect);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPassiveUnmountEffectsInsideOfDeletedTree_complete</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  deletedSubtreeRoot: Fiber</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">const</span> returnFiber = fiber.return</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="comment">// Recursively traverse the entire deleted tree and clean up fiber fields.</span></span><br><span class="line">      <span class="comment">// This is more aggressive than ideal, and the long term goal is to only</span></span><br><span class="line">      <span class="comment">// have to detach the deleted tree at the root.</span></span><br><span class="line">      detachFiberAfterEffects(fiber)</span><br><span class="line">      <span class="keyword">if</span> (fiber === deletedSubtreeRoot) &#123;</span><br><span class="line">        nextEffect = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// This is the default branch (level 0). We do not recursively clear all</span></span><br><span class="line">      <span class="comment">// the fiber fields. Only the root of the deleted subtree.</span></span><br><span class="line">      <span class="keyword">if</span> (fiber === deletedSubtreeRoot) &#123;</span><br><span class="line">        detachFiberAfterEffects(fiber)</span><br><span class="line">        nextEffect = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, returnFiber)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = returnFiber</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">detachFiberAfterEffects</span>(<span class="params">fiber: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> alternate = fiber.alternate</span><br><span class="line">  <span class="keyword">if</span> (alternate !== <span class="literal">null</span>) &#123;</span><br><span class="line">    fiber.alternate = <span class="literal">null</span></span><br><span class="line">    detachFiberAfterEffects(alternate)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: Defensively using negation instead of &lt; in case</span></span><br><span class="line">  <span class="comment">// `deletedTreeCleanUpLevel` is undefined.</span></span><br><span class="line">  <span class="keyword">if</span> (!(deletedTreeCleanUpLevel &gt;= <span class="number">2</span>)) &#123;</span><br><span class="line">    <span class="comment">// This is the default branch (level 0).</span></span><br><span class="line">    fiber.child = <span class="literal">null</span></span><br><span class="line">    fiber.deletions = <span class="literal">null</span></span><br><span class="line">    fiber.dependencies = <span class="literal">null</span></span><br><span class="line">    fiber.memoizedProps = <span class="literal">null</span></span><br><span class="line">    fiber.memoizedState = <span class="literal">null</span></span><br><span class="line">    fiber.pendingProps = <span class="literal">null</span></span><br><span class="line">    fiber.sibling = <span class="literal">null</span></span><br><span class="line">    fiber.stateNode = <span class="literal">null</span></span><br><span class="line">    fiber.updateQueue = <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Clear cyclical Fiber fields. This level alone is designed to roughly</span></span><br><span class="line">    <span class="comment">// approximate the planned Fiber refactor. In that world, `setState` will be</span></span><br><span class="line">    <span class="comment">// bound to a special "instance" object instead of a Fiber. The Instance</span></span><br><span class="line">    <span class="comment">// object will not have any of these fields. It will only be connected to</span></span><br><span class="line">    <span class="comment">// the fiber tree via a single link at the root. So if this level alone is</span></span><br><span class="line">    <span class="comment">// sufficient to fix memory issues, that bodes well for our plans.</span></span><br><span class="line">    fiber.child = <span class="literal">null</span></span><br><span class="line">    fiber.deletions = <span class="literal">null</span></span><br><span class="line">    fiber.sibling = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The `stateNode` is cyclical because on host nodes it points to the host</span></span><br><span class="line">    <span class="comment">// tree, which has its own pointers to children, parents, and siblings.</span></span><br><span class="line">    <span class="comment">// The other host nodes also point back to fibers, so we should detach that</span></span><br><span class="line">    <span class="comment">// one, too.</span></span><br><span class="line">    <span class="keyword">if</span> (fiber.tag === HostComponent) &#123;</span><br><span class="line">      <span class="keyword">const</span> hostInstance: Instance = fiber.stateNode</span><br><span class="line">      <span class="keyword">if</span> (hostInstance !== <span class="literal">null</span>) &#123;</span><br><span class="line">        detachDeletedInstance(hostInstance) <span class="comment">// 删除 react 相关属性，包括事件、容器等</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fiber.stateNode = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (deletedTreeCleanUpLevel &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="comment">// Theoretically, nothing in here should be necessary, because we already</span></span><br><span class="line">      <span class="comment">// disconnected the fiber from the tree. So even if something leaks this</span></span><br><span class="line">      <span class="comment">// particular fiber, it won't leak anything else</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// The purpose of this branch is to be super aggressive so we can measure</span></span><br><span class="line">      <span class="comment">// if there's any difference in memory impact. If there is, that could</span></span><br><span class="line">      <span class="comment">// indicate a React leak we don't know about.</span></span><br><span class="line">      fiber.return = <span class="literal">null</span></span><br><span class="line">      fiber.dependencies = <span class="literal">null</span></span><br><span class="line">      fiber.memoizedProps = <span class="literal">null</span></span><br><span class="line">      fiber.memoizedState = <span class="literal">null</span></span><br><span class="line">      fiber.pendingProps = <span class="literal">null</span></span><br><span class="line">      fiber.stateNode = <span class="literal">null</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Move to `commitPassiveUnmountInsideDeletedTreeOnFiber` instead.</span></span><br><span class="line">      fiber.updateQueue = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="commitBeforeMutationEffects"><a href="#commitBeforeMutationEffects" class="headerlink" title="commitBeforeMutationEffects"></a><code>commitBeforeMutationEffects</code></h5><p>执行生命周期钩子，当进入节点时立即执行生命周期函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle 全局变量</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  firstChild: Fiber</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  focusedInstanceHandle = prepareForCommit(root.containerInfo) <span class="comment">// 查找活跃的的节点</span></span><br><span class="line"></span><br><span class="line">  nextEffect = firstChild</span><br><span class="line">  commitBeforeMutationEffects_begin()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We no longer need to track the active instance fiber</span></span><br><span class="line">  <span class="keyword">const</span> shouldFire = shouldFireAfterActiveInstanceBlur</span><br><span class="line">  shouldFireAfterActiveInstanceBlur = <span class="literal">false</span></span><br><span class="line">  focusedInstanceHandle = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> shouldFire</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects_begin</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should wrap this in flags check, too, as optimization</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.deletions</span><br><span class="line">    <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> deletion = deletions[i]</span><br><span class="line">        commitBeforeMutationEffectsDeletion(deletion)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (fiber.subtreeFlags &amp; BeforeMutationMask) !== NoFlags &amp;&amp;</span><br><span class="line">      child !== <span class="literal">null</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitBeforeMutationEffects_complete()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffects_complete</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 先兄弟节点再父节点</span></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    commitBeforeMutationEffectsOnFiber(fiber)</span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffectsOnFiber</span>(<span class="params">finishedWork: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.flags</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!shouldFireAfterActiveInstanceBlur &amp;&amp; focusedInstanceHandle !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Check to see if the focused element was inside of a hidden (Suspense) subtree.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move this out of the hot path using a dedicated effect tag.</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      finishedWork.tag === SuspenseComponent &amp;&amp;</span><br><span class="line">      isSuspenseBoundaryBeingHidden(current, finishedWork) &amp;&amp;</span><br><span class="line">      doesFiberContain(finishedWork, focusedInstanceHandle)</span><br><span class="line">    ) &#123;</span><br><span class="line">      shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">      beforeActiveInstanceBlur(finishedWork)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((flags &amp; Snapshot) !== NoFlags) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">      <span class="keyword">case</span> ForwardRef:</span><br><span class="line">      <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">        <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevProps = current.memoizedProps</span><br><span class="line">          <span class="keyword">const</span> prevState = current.memoizedState</span><br><span class="line">          <span class="keyword">const</span> instance = finishedWork.stateNode</span><br><span class="line">          <span class="keyword">const</span> snapshot = instance.getSnapshotBeforeUpdate(</span><br><span class="line">            finishedWork.elementType === finishedWork.type</span><br><span class="line">              ? prevProps</span><br><span class="line">              : resolveDefaultProps(finishedWork.type, prevProps),</span><br><span class="line">            prevState</span><br><span class="line">          )</span><br><span class="line">          instance.__reactInternalSnapshotBeforeUpdate = snapshot</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsMutation) &#123;</span><br><span class="line">          <span class="keyword">const</span> root = finishedWork.stateNode</span><br><span class="line">          clearContainer(root.containerInfo)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostComponent:</span><br><span class="line">      <span class="keyword">case</span> HostText:</span><br><span class="line">      <span class="keyword">case</span> HostPortal:</span><br><span class="line">      <span class="keyword">case</span> IncompleteClassComponent:</span><br><span class="line">        <span class="comment">// Nothing to do for these component types</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitBeforeMutationEffectsDeletion</span>(<span class="params">deletion: Fiber</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// TODO (effects) It would be nice to avoid calling doesFiberContain()</span></span><br><span class="line">  <span class="comment">// Maybe we can repurpose one of the subtreeFlags positions for this instead?</span></span><br><span class="line">  <span class="comment">// Use it to store which part of the tree the focused instance is in?</span></span><br><span class="line">  <span class="comment">// This assumes we can safely determine that instance during the "render" phase.</span></span><br><span class="line">  <span class="keyword">if</span> (doesFiberContain(deletion, focusedInstanceHandle)) &#123;</span><br><span class="line">    shouldFireAfterActiveInstanceBlur = <span class="literal">true</span></span><br><span class="line">    beforeActiveInstanceBlur(deletion)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="commitMutationEffects"><a href="#commitMutationEffects" class="headerlink" title="commitMutationEffects"></a><code>commitMutationEffects</code></h5><p>构建 dom 节点，在离开节点时开始 dom 构建<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle,inProgressLanes,inProgressRoot 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  firstChild: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  inProgressLanes = committedLanes</span><br><span class="line">  inProgressRoot = root</span><br><span class="line">  nextEffect = firstChild</span><br><span class="line"></span><br><span class="line">  commitMutationEffects_begin(root)</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span></span><br><span class="line">  inProgressRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects_begin</span>(<span class="params">root: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Should wrap this in flags check, too, as optimization</span></span><br><span class="line">    <span class="keyword">const</span> deletions = fiber.deletions</span><br><span class="line">    <span class="keyword">if</span> (deletions !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; deletions.length; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> childToDelete = deletions[i]</span><br><span class="line">        commitDeletion(root, childToDelete, fiber)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = fiber.child</span><br><span class="line">    <span class="keyword">if</span> ((fiber.subtreeFlags &amp; MutationMask) !== NoFlags &amp;&amp; child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(child, fiber)</span><br><span class="line">      nextEffect = child</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      commitMutationEffects_complete(root)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffects_complete</span>(<span class="params">root: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    commitMutationEffectsOnFiber(fiber, root)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitMutationEffectsOnFiber</span>(<span class="params">finishedWork: Fiber, root: FiberRoot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> flags = finishedWork.flags</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; ContentReset) &#123;</span><br><span class="line">    commitResetTextContent(finishedWork)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (flags &amp; Ref) &#123;</span><br><span class="line">    <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">    <span class="keyword">if</span> (current !== <span class="literal">null</span>) &#123;</span><br><span class="line">      commitDetachRef(current)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> This is a temporary solution that allowed us to transition away</span></span><br><span class="line">      <span class="comment">// from React Flare on www.</span></span><br><span class="line">      <span class="keyword">if</span> (finishedWork.tag === ScopeComponent) &#123;</span><br><span class="line">        commitAttachRef(finishedWork)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The following switch statement is only concerned about placement,</span></span><br><span class="line">  <span class="comment">// updates, and deletions. To avoid needing to add a case for every possible</span></span><br><span class="line">  <span class="comment">// bitmap value, we remove the secondary effects from the effect tag and</span></span><br><span class="line">  <span class="comment">// switch on that value.</span></span><br><span class="line">  <span class="keyword">const</span> primaryFlags = flags &amp; (Placement | Update | Hydrating)</span><br><span class="line">  <span class="keyword">switch</span> (primaryFlags) &#123;</span><br><span class="line">    <span class="keyword">case</span> Placement: &#123;</span><br><span class="line">      commitPlacement(finishedWork)</span><br><span class="line">      <span class="comment">// Clear the "placement" from effect tag so that we know that this is</span></span><br><span class="line">      <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> findDOMNode doesn't rely on this any more but isMounted does</span></span><br><span class="line">      <span class="comment">// and isMounted is deprecated anyway so we should be able to kill this.</span></span><br><span class="line">      finishedWork.flags &amp;= ~Placement</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> PlacementAndUpdate: &#123;</span><br><span class="line">      <span class="comment">// Placement</span></span><br><span class="line">      commitPlacement(finishedWork)</span><br><span class="line">      <span class="comment">// Clear the "placement" from effect tag so that we know that this is</span></span><br><span class="line">      <span class="comment">// inserted, before any life-cycles like componentDidMount gets called.</span></span><br><span class="line">      finishedWork.flags &amp;= ~Placement</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">      commitWork(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Hydrating: &#123;</span><br><span class="line">      finishedWork.flags &amp;= ~Hydrating</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HydratingAndUpdate: &#123;</span><br><span class="line">      finishedWork.flags &amp;= ~Hydrating</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Update</span></span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">      commitWork(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Update: &#123;</span><br><span class="line">      <span class="keyword">const</span> current = finishedWork.alternate</span><br><span class="line">      commitWork(current, finishedWork)</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitWork</span>(<span class="params">current: Fiber | <span class="literal">null</span>, finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">      <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">      <span class="keyword">case</span> ForwardRef:</span><br><span class="line">      <span class="keyword">case</span> MemoComponent:</span><br><span class="line">      <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">        <span class="comment">// Layout effects are destroyed during the mutation phase so that all</span></span><br><span class="line">        <span class="comment">// destroy functions for all fibers are called before any create functions.</span></span><br><span class="line">        <span class="comment">// This prevents sibling component effects from interfering with each other,</span></span><br><span class="line">        <span class="comment">// e.g. a destroy function in one component should never override a ref set</span></span><br><span class="line">        <span class="comment">// by a create function in another component during the same commit.</span></span><br><span class="line"></span><br><span class="line">          commitHookEffectListUnmount(</span><br><span class="line">            HookLayout | HookHasEffect,</span><br><span class="line">            finishedWork,</span><br><span class="line">            finishedWork.return,</span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> Profiler: &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">        commitSuspenseComponent(finishedWork);</span><br><span class="line">        attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">        attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">        <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">          <span class="keyword">const</span> root: FiberRoot = finishedWork.stateNode;</span><br><span class="line">          <span class="keyword">if</span> (root.hydrate) &#123;</span><br><span class="line">            <span class="comment">// We've just hydrated. No need to hydrate again.</span></span><br><span class="line">            root.hydrate = <span class="literal">false</span>;</span><br><span class="line">            commitHydratedContainer(root.containerInfo);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> OffscreenComponent:</span><br><span class="line">      <span class="keyword">case</span> LegacyHiddenComponent: &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    commitContainer(finishedWork);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (finishedWork.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">    <span class="keyword">case</span> ForwardRef:</span><br><span class="line">    <span class="keyword">case</span> MemoComponent:</span><br><span class="line">    <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">      <span class="comment">// Layout effects are destroyed during the mutation phase so that all</span></span><br><span class="line">      <span class="comment">// destroy functions for all fibers are called before any create functions.</span></span><br><span class="line">      <span class="comment">// This prevents sibling component effects from interfering with each other,</span></span><br><span class="line">      <span class="comment">// e.g. a destroy function in one component should never override a ref set</span></span><br><span class="line">      <span class="comment">// by a create function in another component during the same commit.</span></span><br><span class="line"></span><br><span class="line">        commitHookEffectListUnmount(</span><br><span class="line">          HookLayout | HookHasEffect,</span><br><span class="line">          finishedWork,</span><br><span class="line">          finishedWork.return,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> instance: Instance = finishedWork.stateNode;</span><br><span class="line">      <span class="keyword">if</span> (instance != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Commit the work prepared earlier.</span></span><br><span class="line">        <span class="keyword">const</span> newProps = finishedWork.memoizedProps;</span><br><span class="line">        <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">        <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">        <span class="comment">// this case.</span></span><br><span class="line">        <span class="keyword">const</span> oldProps = current !== <span class="literal">null</span> ? current.memoizedProps : newProps;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">type</span> = finishedWork.type;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Type the updateQueue to be specific to host components.</span></span><br><span class="line">        <span class="keyword">const</span> updatePayload: <span class="literal">null</span> | UpdatePayload = (finishedWork.updateQueue: <span class="built_in">any</span>);</span><br><span class="line">        finishedWork.updateQueue = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (updatePayload !== <span class="literal">null</span>) &#123;</span><br><span class="line">          commitUpdate(</span><br><span class="line">            instance,</span><br><span class="line">            updatePayload,</span><br><span class="line">            <span class="keyword">type</span>,</span><br><span class="line">            oldProps,</span><br><span class="line">            newProps,</span><br><span class="line">            finishedWork,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostText: &#123;</span><br><span class="line">      <span class="keyword">const</span> textInstance: TextInstance = finishedWork.stateNode;</span><br><span class="line">      <span class="keyword">const</span> newText: <span class="built_in">string</span> = finishedWork.memoizedProps;</span><br><span class="line">      <span class="comment">// For hydration we reuse the update path but we treat the oldProps</span></span><br><span class="line">      <span class="comment">// as the newProps. The updatePayload will contain the real change in</span></span><br><span class="line">      <span class="comment">// this case.</span></span><br><span class="line">      <span class="keyword">const</span> oldText: <span class="built_in">string</span> =</span><br><span class="line">        current !== <span class="literal">null</span> ? current.memoizedProps : newText;</span><br><span class="line">      commitTextUpdate(textInstance, oldText, newText);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> HostRoot: &#123;</span><br><span class="line">      <span class="keyword">if</span> (supportsHydration) &#123;</span><br><span class="line">        <span class="keyword">const</span> root: FiberRoot = finishedWork.stateNode;</span><br><span class="line">        <span class="keyword">if</span> (root.hydrate) &#123;</span><br><span class="line">          <span class="comment">// We've just hydrated. No need to hydrate again.</span></span><br><span class="line">          root.hydrate = <span class="literal">false</span>;</span><br><span class="line">          commitHydratedContainer(root.containerInfo);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> Profiler: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseComponent: &#123;</span><br><span class="line">      commitSuspenseComponent(finishedWork);</span><br><span class="line">      attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> SuspenseListComponent: &#123;</span><br><span class="line">      attachSuspenseRetryListeners(finishedWork);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> IncompleteClassComponent: &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> ScopeComponent: &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableScopeAPI) &#123;</span><br><span class="line">        <span class="keyword">const</span> scopeInstance = finishedWork.stateNode;</span><br><span class="line">        prepareScopeUpdate(scopeInstance, finishedWork);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> OffscreenComponent:</span><br><span class="line">    <span class="keyword">case</span> LegacyHiddenComponent: &#123;</span><br><span class="line">      <span class="keyword">const</span> newState: OffscreenState | <span class="literal">null</span> = finishedWork.memoizedState;</span><br><span class="line">      <span class="keyword">const</span> isHidden = newState !== <span class="literal">null</span>;</span><br><span class="line">      hideOrUnhideAllChildren(finishedWork, isHidden);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitPlacement</span>(<span class="params">finishedWork: Fiber</span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!supportsMutation) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Recursively insert all host nodes into the parent.</span></span><br><span class="line">  <span class="keyword">const</span> parentFiber = getHostParentFiber(finishedWork);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note: these two variables *must* always be updated together.</span></span><br><span class="line">  <span class="keyword">let</span> parent;</span><br><span class="line">  <span class="keyword">let</span> isContainer;</span><br><span class="line">  <span class="keyword">const</span> parentStateNode = parentFiber.stateNode;</span><br><span class="line">  <span class="keyword">switch</span> (parentFiber.tag) &#123;</span><br><span class="line">    <span class="keyword">case</span> HostComponent:</span><br><span class="line">      parent = parentStateNode;</span><br><span class="line">      isContainer = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HostRoot:</span><br><span class="line">      parent = parentStateNode.containerInfo;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> HostPortal:</span><br><span class="line">      parent = parentStateNode.containerInfo;</span><br><span class="line">      isContainer = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line-no-fallthrough</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (parentFiber.flags &amp; ContentReset) &#123;</span><br><span class="line">    <span class="comment">// Reset the text content of the parent before doing any insertions</span></span><br><span class="line">    resetTextContent(parent);</span><br><span class="line">    <span class="comment">// Clear ContentReset from the effect tag</span></span><br><span class="line">    parentFiber.flags &amp;= ~ContentReset;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> before = getHostSibling(finishedWork);</span><br><span class="line">  <span class="comment">// 插入 dom 元素</span></span><br><span class="line">  <span class="keyword">if</span> (isContainer) &#123;</span><br><span class="line">    insertOrAppendPlacementNodeIntoContainer(finishedWork, before, parent);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    insertOrAppendPlacementNode(finishedWork, before, parent);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isHostParent</span>(<span class="params">fiber: Fiber</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    fiber.tag === HostComponent ||</span><br><span class="line">    fiber.tag === HostRoot ||</span><br><span class="line">    fiber.tag === HostPortal</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHostSibling</span>(<span class="params">fiber: Fiber</span>): ?<span class="title">Instance</span> </span>&#123;</span><br><span class="line">  <span class="comment">// We're going to search forward into the tree until we find a sibling host</span></span><br><span class="line">  <span class="comment">// node. Unfortunately, if multiple insertions are done in a row we have to</span></span><br><span class="line">  <span class="comment">// search past them. This leads to exponential search for the next sibling.</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> Find a more efficient way to do this.</span></span><br><span class="line">  <span class="keyword">let</span> node: Fiber = fiber;</span><br><span class="line">  siblings: <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// If we didn't find anything, let's try the next sibling.</span></span><br><span class="line">    <span class="keyword">while</span> (node.sibling === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.return === <span class="literal">null</span> || isHostParent(node.return)) &#123;</span><br><span class="line">        <span class="comment">// If we pop out of the root or hit the parent the fiber we are the</span></span><br><span class="line">        <span class="comment">// last sibling.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.return;</span><br><span class="line">    &#125;</span><br><span class="line">    node.sibling.return = node.return;</span><br><span class="line">    node = node.sibling;</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">      node.tag !== HostComponent &amp;&amp;</span><br><span class="line">      node.tag !== HostText &amp;&amp;</span><br><span class="line">      node.tag !== DehydratedFragment</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// If it is not host node and, we might have a host node inside it.</span></span><br><span class="line">      <span class="comment">// Try to search down until we find one.</span></span><br><span class="line">      <span class="keyword">if</span> (node.flags &amp; Placement) &#123;</span><br><span class="line">        <span class="comment">// If we don't have a child, try the siblings instead.</span></span><br><span class="line">        <span class="keyword">continue</span> siblings;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// If we don't have a child, try the siblings instead.</span></span><br><span class="line">      <span class="comment">// We also skip portals because they are not part of this host tree.</span></span><br><span class="line">      <span class="keyword">if</span> (node.child === <span class="literal">null</span> || node.tag === HostPortal) &#123;</span><br><span class="line">        <span class="keyword">continue</span> siblings;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        node.child.return = node;</span><br><span class="line">        node = node.child;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check if this host node is stable or about to be placed.</span></span><br><span class="line">    <span class="keyword">if</span> (!(node.flags &amp; Placement)) &#123;</span><br><span class="line">      <span class="comment">// Found it!</span></span><br><span class="line">      <span class="keyword">return</span> node.stateNode;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertOrAppendPlacementNodeIntoContainer</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  node: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  before: ?Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Container,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;tag&#125; = node;</span><br><span class="line">  <span class="keyword">const</span> isHost = tag === HostComponent || tag === HostText;</span><br><span class="line">  <span class="keyword">if</span> (isHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = node.stateNode;</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      insertInContainerBefore(parent, stateNode, before);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      appendChildToContainer(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === HostPortal) &#123;</span><br><span class="line">    <span class="comment">// If the insertion itself is a portal, then we don't want to traverse</span></span><br><span class="line">    <span class="comment">// down its children. Instead, we'll get insertions from each child in</span></span><br><span class="line">    <span class="comment">// the portal directly.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = node.child;</span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      insertOrAppendPlacementNodeIntoContainer(child, before, parent);</span><br><span class="line">      <span class="keyword">let</span> sibling = child.sibling;</span><br><span class="line">      <span class="keyword">while</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">        insertOrAppendPlacementNodeIntoContainer(sibling, before, parent);</span><br><span class="line">        sibling = sibling.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">insertOrAppendPlacementNode</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  node: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  before: ?Instance,</span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Instance,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;tag&#125; = node;</span><br><span class="line">  <span class="keyword">const</span> isHost = tag === HostComponent || tag === HostText;</span><br><span class="line">  <span class="keyword">if</span> (isHost) &#123;</span><br><span class="line">    <span class="keyword">const</span> stateNode = node.stateNode;</span><br><span class="line">    <span class="keyword">if</span> (before) &#123;</span><br><span class="line">      insertBefore(parent, stateNode, before);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      appendChild(parent, stateNode);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tag === HostPortal) &#123;</span><br><span class="line">    <span class="comment">// If the insertion itself is a portal, then we don't want to traverse</span></span><br><span class="line">    <span class="comment">// down its children. Instead, we'll get insertions from each child in</span></span><br><span class="line">    <span class="comment">// the portal directly.</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> child = node.child;</span><br><span class="line">    <span class="keyword">if</span> (child !== <span class="literal">null</span>) &#123;</span><br><span class="line">      insertOrAppendPlacementNode(child, before, parent);</span><br><span class="line">      <span class="keyword">let</span> sibling = child.sibling;</span><br><span class="line">      <span class="keyword">while</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">        insertOrAppendPlacementNode(sibling, before, parent);</span><br><span class="line">        sibling = sibling.sibling;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="commitLayoutEffects"><a href="#commitLayoutEffects" class="headerlink" title="commitLayoutEffects"></a><code>commitLayoutEffects</code></h5><p>执行生命周期钩子，在离开当前节点时调用钩子函数<br>遍历顺序为： 根节点—&gt; 父节点 —&gt; 叶子节点 —&gt; 兄弟叶子节点 —&gt; 父节点 —&gt; 根节点</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file: packages/react-reconciler/src/ReactFiberCommitWork.old.js</span></span><br><span class="line"><span class="comment">// nextEffect, focusedInstanceHandle,inProgressLanes,inProgressRoot 全局变量</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffects</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  finishedWork: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">void</span> </span>&#123;</span><br><span class="line">  inProgressLanes = committedLanes</span><br><span class="line">  inProgressRoot = root</span><br><span class="line">  nextEffect = finishedWork</span><br><span class="line"></span><br><span class="line">  commitLayoutEffects_begin(finishedWork, root, committedLanes)</span><br><span class="line"></span><br><span class="line">  inProgressLanes = <span class="literal">null</span></span><br><span class="line">  inProgressRoot = <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutEffects_begin</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Suspense layout effects semantics don't change for legacy roots.</span></span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.mode &amp; ConcurrentMode) !== NoMode</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line">    <span class="keyword">const</span> firstChild = fiber.child</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics &amp;&amp; isModernRoot) &#123;</span><br><span class="line">      <span class="comment">// Keep track of the current Offscreen stack's state.</span></span><br><span class="line">      <span class="keyword">if</span> (fiber.tag === OffscreenComponent) &#123;</span><br><span class="line">        <span class="keyword">const</span> current = fiber.alternate</span><br><span class="line">        <span class="keyword">const</span> wasHidden = current !== <span class="literal">null</span> &amp;&amp; current.memoizedState !== <span class="literal">null</span></span><br><span class="line">        <span class="keyword">const</span> isHidden = fiber.memoizedState !== <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> newOffscreenSubtreeIsHidden = isHidden || offscreenSubtreeIsHidden</span><br><span class="line">        <span class="keyword">const</span> newOffscreenSubtreeWasHidden =</span><br><span class="line">          wasHidden || offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">          newOffscreenSubtreeIsHidden !== offscreenSubtreeIsHidden ||</span><br><span class="line">          newOffscreenSubtreeWasHidden !== offscreenSubtreeWasHidden</span><br><span class="line">        ) &#123;</span><br><span class="line">          <span class="keyword">const</span> prevOffscreenSubtreeIsHidden = offscreenSubtreeIsHidden</span><br><span class="line">          <span class="keyword">const</span> prevOffscreenSubtreeWasHidden = offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Traverse the Offscreen subtree with the current Offscreen as the root.</span></span><br><span class="line">          offscreenSubtreeIsHidden = newOffscreenSubtreeIsHidden</span><br><span class="line">          offscreenSubtreeWasHidden = newOffscreenSubtreeWasHidden</span><br><span class="line">          commitLayoutEffects_begin(</span><br><span class="line">            fiber, <span class="comment">// New root; bubble back up to here and stop.</span></span><br><span class="line">            root,</span><br><span class="line">            committedLanes</span><br><span class="line">          )</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Restore Offscreen state and resume in our-progress traversal.</span></span><br><span class="line">          nextEffect = fiber</span><br><span class="line">          offscreenSubtreeIsHidden = prevOffscreenSubtreeIsHidden</span><br><span class="line">          offscreenSubtreeWasHidden = prevOffscreenSubtreeWasHidden</span><br><span class="line">          commitLayoutMountEffects_complete(subtreeRoot, root, committedLanes)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((fiber.subtreeFlags &amp; LayoutMask) !== NoFlags &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(firstChild, fiber)</span><br><span class="line">      nextEffect = firstChild</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (enableSuspenseLayoutEffectSemantics &amp;&amp; isModernRoot) &#123;</span><br><span class="line">        <span class="keyword">const</span> visibilityChanged =</span><br><span class="line">          !offscreenSubtreeIsHidden &amp;&amp; offscreenSubtreeWasHidden</span><br><span class="line"></span><br><span class="line">        <span class="comment">// TODO (Offscreen) Also check: subtreeFlags &amp; LayoutStatic</span></span><br><span class="line">        <span class="keyword">if</span> (visibilityChanged &amp;&amp; firstChild !== <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// We've just shown or hidden a Offscreen tree that contains layout effects.</span></span><br><span class="line">          <span class="comment">// We only enter this code path for subtrees that are updated,</span></span><br><span class="line">          <span class="comment">// because newly mounted ones would pass the LayoutMask check above.</span></span><br><span class="line">          ensureCorrectReturnPointer(firstChild, fiber)</span><br><span class="line">          nextEffect = firstChild</span><br><span class="line">          <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      commitLayoutMountEffects_complete(subtreeRoot, root, committedLanes)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">commitLayoutMountEffects_complete</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  subtreeRoot: Fiber,</span></span></span><br><span class="line"><span class="function"><span class="params">  root: FiberRoot,</span></span></span><br><span class="line"><span class="function"><span class="params">  committedLanes: Lanes</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Suspense layout effects semantics don't change for legacy roots.</span></span><br><span class="line">  <span class="keyword">const</span> isModernRoot = (subtreeRoot.mode &amp; ConcurrentMode) !== NoMode</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (nextEffect !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> fiber = nextEffect</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      enableSuspenseLayoutEffectSemantics &amp;&amp;</span><br><span class="line">      isModernRoot &amp;&amp;</span><br><span class="line">      offscreenSubtreeWasHidden &amp;&amp;</span><br><span class="line">      !offscreenSubtreeIsHidden</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// Inside of an Offscreen subtree that changed visibility during this commit.</span></span><br><span class="line">      <span class="comment">// If this subtree was hidden, layout effects will have already been destroyed (during mutation phase)</span></span><br><span class="line">      <span class="comment">// but if it was just shown, we need to (re)create the effects now.</span></span><br><span class="line">      <span class="comment">// TODO (Offscreen) Check: flags &amp; LayoutStatic</span></span><br><span class="line">      <span class="keyword">switch</span> (fiber.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> FunctionComponent:</span><br><span class="line">        <span class="keyword">case</span> ForwardRef:</span><br><span class="line">        <span class="keyword">case</span> SimpleMemoComponent: &#123;</span><br><span class="line">          safelyCallCommitHookLayoutEffectListMount(fiber, fiber.return)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent: &#123;</span><br><span class="line">          <span class="keyword">const</span> instance = fiber.stateNode</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> instance.componentDidMount === <span class="string">'function'</span>) &#123;</span><br><span class="line">            safelyCallComponentDidMount(fiber, fiber.return, instance)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// TODO (Offscreen) Check flags &amp; RefStatic</span></span><br><span class="line">      <span class="keyword">switch</span> (fiber.tag) &#123;</span><br><span class="line">        <span class="keyword">case</span> ClassComponent:</span><br><span class="line">        <span class="keyword">case</span> HostComponent:</span><br><span class="line">          safelyAttachRef(fiber, fiber.return)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((fiber.flags &amp; LayoutMask) !== NoFlags) &#123;</span><br><span class="line">      <span class="keyword">const</span> current = fiber.alternate</span><br><span class="line">      commitLayoutEffectOnFiber(root, current, fiber, committedLanes)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fiber === subtreeRoot) &#123;</span><br><span class="line">      nextEffect = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> sibling = fiber.sibling</span><br><span class="line">    <span class="keyword">if</span> (sibling !== <span class="literal">null</span>) &#123;</span><br><span class="line">      ensureCorrectReturnPointer(sibling, fiber.return)</span><br><span class="line">      nextEffect = sibling</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextEffect = fiber.return</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/06/14/react的同步更新/" data-id="ckqza38kt005nyys618q1egkk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react中的事件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/12/react中的事件/" class="article-date">
  <time datetime="2021-06-12T12:34:30.000Z" itemprop="datePublished">2021-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/12/react中的事件/">react中的事件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="react-中的事件"><a href="#react-中的事件" class="headerlink" title="react 中的事件"></a><code>react</code> 中的事件</h3><h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><ol>
<li>在 <code>react-dom</code> 模块的 <code>src/client/ReactDOM</code> 中引入 <code>ReactDOMEventHandle</code> 文件，把该文件中的 <code>createEventHandle</code> 函数导出为 <code>unstable_createEventHandle</code> 以供第三方使用</li>
<li><p>在 <code>ReactDOMEventHandle</code> 文件中引入 <code>events/DOMPluginEventSystem</code> 文件，在模块中注册了顶级事件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// <span class="doctag">TODO:</span> remove top-level side effect.</span></span><br><span class="line">SimpleEventPlugin.registerEvents()</span><br><span class="line">EnterLeaveEventPlugin.registerEvents()</span><br><span class="line">ChangeEventPlugin.registerEvents()</span><br><span class="line">SelectEventPlugin.registerEvents()</span><br><span class="line">BeforeInputEventPlugin.registerEvents()</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 <code>events/EventRegistry</code> 模块中调用方法把注册的事件放入存储的 <code>Set</code> 和对象中，<code>allNativeEvents Set</code> 负责存储所有注册过的事件名称，<code>registrationNameDependencies</code> 以 <code>{[reactEventName]: [nativeEventName] }</code>负责存储注册的事件依赖</p>
</li>
<li>合成事件的初始化完毕</li>
</ol>
<h4 id="事件挂载"><a href="#事件挂载" class="headerlink" title="事件挂载"></a>事件挂载</h4><ol>
<li>调用 <code>react-dom</code> 模块中的 <code>render</code> 时，若第一次挂载则递归依次调用 <code>legacyCreateRootFromDOMContainer</code>、<code>createLegacyRoot</code> 创建容器对象 <code>ReactDOMLegacyRoot</code> 的实例</li>
<li><code>ReactDOMLegacyRoot</code> 递归依次调用 <code>createRootImpl</code>、<code>createContainer</code> 创建了组件挂载的根元素，并表及为根元素</li>
<li>调用 <code>listenToAllSupportedEvents</code> 在根元素上挂载事件，若当前容器为注释元素，则取当前元素的父元素为事件挂载的节点</li>
<li><p>在 <code>listenToAllSupportedEvents</code> 中遍历初始化时注册的 <code>allNativeEvents</code> 事件列表注册事件，判断根元素是否为 <code>documet</code> 节点，不是则获取 <code>document</code> 节点，在 <code>document</code> 节点节点上注册 <code>selectionchange</code> 事件</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> listeningMarker = <span class="string">'_reactListening'</span> +<span class="built_in">Math</span>.random().toString(<span class="number">36</span>).slice(<span class="number">2</span>);</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">listenToAllSupportedEvents</span>(<span class="params">rootContainerElement: EventTarget</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!(rootContainerElement: <span class="built_in">any</span>)[listeningMarker]) &#123;</span><br><span class="line">    rootContainerElement[listeningMarker] = <span class="literal">true</span></span><br><span class="line">    allNativeEvents.forEach(<span class="function">(<span class="params">domEventName</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// We handle selectionchange separately because it</span></span><br><span class="line">      <span class="comment">// doesn't bubble and needs to be on the document.</span></span><br><span class="line">      <span class="keyword">if</span> (domEventName !== <span class="string">'selectionchange'</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!nonDelegatedEvents.has(domEventName)) &#123;</span><br><span class="line">          listenToNativeEvent(domEventName, <span class="literal">false</span>, rootContainerElement)</span><br><span class="line">        &#125;</span><br><span class="line">        listenToNativeEvent(domEventName, <span class="literal">true</span>, rootContainerElement)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> ownerDocument =</span><br><span class="line">      rootContainerElement.nodeType === DOCUMENT_NODE</span><br><span class="line">        ? rootContainerElement</span><br><span class="line">        : (rootContainerElement).ownerDocument</span><br><span class="line">    <span class="keyword">if</span> (ownerDocument !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// The selectionchange event also needs deduplication</span></span><br><span class="line">      <span class="comment">// but it is attached to the document.</span></span><br><span class="line">      <span class="keyword">if</span> (!(ownerDocument)[listeningMarker]) &#123;</span><br><span class="line">        ownerDocument[listeningMarker] = <span class="literal">true</span></span><br><span class="line">        listenToNativeEvent(<span class="string">'selectionchange'</span>, <span class="literal">false</span>, ownerDocument)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="组件事件注册"><a href="#组件事件注册" class="headerlink" title="组件事件注册"></a>组件事件注册</h4><h4 id="事件触发"><a href="#事件触发" class="headerlink" title="事件触发"></a>事件触发</h4><ol>
<li>有事件触发时，调用 <code>events/ReactDOMEventListener</code> 下的 <code>dispatchEvent</code> 触发事件</li>
<li>当事件不可重新触发时直接调用 <code>attemptToDispatchEvent</code> 进行事件的触发，否则事件放入队列等待调用</li>
<li>在 <code>attemptToDispatchEvent</code> 调用 <code>events/DOMPluginEventSystem</code> 文件下的 <code>dispatchEventForPluginEventSystem</code>，找出触发事件元素的根节点，然后通过 <code>dispatchEventsForPlugins</code> 批量更新</li>
<li><code>dispatchEventsForPlugins</code> 先获取当前 <code>Fiber</code> 上绑定的对应事件，然后 <code>processDispatchQueue</code> 通过按照顺序 <code>processDispatchQueueItemsInOrder</code> 处理各个事件</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/06/12/react中的事件/" data-id="ckqza38j3002ryys6ahxyobnr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react中的jsx语法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/06/react中的jsx语法/" class="article-date">
  <time datetime="2021-06-06T14:30:07.000Z" itemprop="datePublished">2021-06-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/06/react中的jsx语法/">react中的jsx语法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a><code>JSX</code></h2><p><code>JSX</code> 是一种嵌入式的类似 <code>XML</code> 的语法。 它可以被转换成合法的 <code>JavaScript</code>，尽管转换的语义是依据不同的实现而定的。 <code>JSX</code> 因 <code>React</code> 框架而流行，但也存在其它的实现。</p>
<h3 id="React-中的-JSX"><a href="#React-中的-JSX" class="headerlink" title="React 中的 JSX"></a><code>React</code> 中的 <code>JSX</code></h3><p><code>JSX</code> 为我们提供了创建 <code>React</code> 元素方法（<code>React.createElement(component, props, ...children)</code>）的语法糖（<code>syntactic sugar</code>）</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> element = &lt;div&gt;Hello, world!&lt;/div&gt;</span><br><span class="line"><span class="comment">// 编译后会被转化为</span></span><br><span class="line"><span class="keyword">var</span> element = React.createElement(<span class="string">'div'</span>, <span class="literal">null</span>, <span class="string">'Hello, world!'</span>) <span class="comment">// 返回一个对象</span></span><br></pre></td></tr></table></figure>
<h4 id="JSX-代表-JS-对象"><a href="#JSX-代表-JS-对象" class="headerlink" title="JSX 代表 JS 对象"></a><code>JSX</code> 代表 <code>JS</code> 对象</h4><p><code>JSX</code> 本身也是一个表达式，在编译后，<code>JSX</code> 表达式会变成普通的 <code>JavaScript</code> 对象。执行 <code>React.createElement</code> 之后最终会执行一下代码生成一个普通的 <code>JavaScript</code> 对象。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ReactElement = <span class="function"><span class="keyword">function</span> (<span class="params">type, key, ref, self, source, owner, props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> element = &#123;</span><br><span class="line">    <span class="comment">// This tag allows us to uniquely identify this as a React Element</span></span><br><span class="line">    $$<span class="keyword">typeof</span>: REACT_ELEMENT_TYPE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Built-in properties that belong on the element</span></span><br><span class="line">    type: type,</span><br><span class="line">    key: key,</span><br><span class="line">    ref: ref,</span><br><span class="line">    props: props,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Record the component responsible for creating this element.</span></span><br><span class="line">    _owner: owner,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> element</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上可以看出，执行 <code>React.createElement</code> 时只支持表达式，同时可以在以下情况中使用</p>
<ul>
<li>可以在 <code>if</code> 语句或 <code>for</code> 循环中使用 <code>JSX</code></li>
<li>可以将它赋值给变量</li>
<li>可以将它作为参数接收</li>
<li>可以在函数中返回 <code>JSX</code>。</li>
</ul>
<h5 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h5><p>在 <code>JavaScript</code> 中，表达式就是一个短语，<code>Javascript</code> 解释器会将其计算出一个结果，常量就是最简单的一类表达式。常用的表达式有：</p>
<ul>
<li>变量名</li>
<li>函数定义表达式</li>
<li>属性访问表达式</li>
<li>函数调用表达式</li>
<li>算数表达式</li>
<li>关系表达式</li>
<li>逻辑表达式</li>
</ul>
<p>注意: <code>if</code> 语句以及 <code>for</code> 循环不是 <code>JavaScript</code> 表达式</p>
<h4 id="JSX-可自动防范注入攻击"><a href="#JSX-可自动防范注入攻击" class="headerlink" title="JSX 可自动防范注入攻击"></a><code>JSX</code> 可自动防范注入攻击</h4><p>在默认情况下，React DOM 会将所有嵌入 JSX 的值进行编码，利用 <code>createTextNode</code> 进行 <code>HTML</code> 转义</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createTextNode</span>(<span class="params">text, rootContainerElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getOwnerDocumentFromRootContainer(rootContainerElement).createTextNode(</span><br><span class="line">    text</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若希望直接将字符串不经转义编码直接插入到 <code>HTML</code> 文档流，可以使用 <code>dangerouslySetInnerHTML</code> 属性，这是一个 <code>React</code> 版的 <code>innerHTML</code>，该属性接收一个 <code>key</code> 为 <code>__html</code> 的对象</p>
<h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><ul>
<li><code>JSX</code> 会自动删除一行中开头和结尾处的空白符；</li>
<li><code>JSX</code> 会自动删除空行；</li>
<li><code>JSX</code> 会删除紧邻标签的换行；</li>
<li><code>JSX</code> 会删除字符串中的换行；</li>
<li>字符串中的换行会被转换成一个空格。</li>
</ul>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>允许使用熟悉的语法来定义 <code>HTML</code> 元素树</li>
<li>提供了更加语义化且易懂的标签</li>
<li>程序结构更容易被直观化</li>
<li>抽象了 <code>React Element</code> 的创建过程</li>
<li>可以随时掌控 <code>HTML</code> 标签以及生成这些标签的代码</li>
<li>原生 <code>Javascript</code></li>
</ul>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.tslang.cn/docs/handbook/jsx.html" target="_blank" rel="noopener">JSX</a></li>
<li><a href="https://www.cnblogs.com/candlia/p/11920070.html" target="_blank" rel="noopener">JSX 语法使用详解</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/06/06/react中的jsx语法/" data-id="ckqza38j1002oyys62vznfzg8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-react中的异步实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/05/30/react中的异步实现/" class="article-date">
  <time datetime="2021-05-30T13:37:54.000Z" itemprop="datePublished">2021-05-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/05/30/react中的异步实现/">react中的异步实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h3><p>由于 <code>JS</code> 是单线程非阻塞的，所有的任务都需要在这个线程中来处理。当需要执行异步任务时主线程会先挂起这个任务，当异步任务执行完毕之后主线程会根据规则执行回调。当任务处理完毕之后， <code>JS</code> 会将这个事件加入队列中，这个队列即被称为事件队列。</p>
<h4 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h4><ul>
<li>进程： <code>CPU</code> 在运行指令及加载和保存上下文所需的时间，放在应用上来说就代表了一个程序。</li>
<li>线程： 进程中的更小单位，描述了执行一段指令所需的时间。</li>
</ul>
<p>在浏览器中，当你打开一个 <code>Tab</code> 页时，其实就是创建了一个进程，一个进程中可以有多个线程，比如渲染线程、<code>JS</code> 引擎线程、<code>HTTP</code> 请求线程等等。当你发起一个请求时，其实就是创建了一个线程，当请求结束后，该线程可能就会被销毁。</p>
<p>在 <code>JS</code> 运行的时候会阻止 <code>UI</code> 渲染，这是因为 <code>JS</code> 可以修改 <code>DOM</code>，如果在 <code>JS</code> 执行的时候 <code>UI</code> 线程还在工作，就可能导致不能安全的渲染 <code>UI</code>。这其实也是一个单线程的好处，得益于 <code>JS</code> 是单线程运行的，可以达到节省内存，节约上下文切换时间，没有锁的问题的好处。</p>
<p>对于锁的问题，形象的来说就是当我读取一个数字 <code>15</code> 的时候，同时有两个操作对数字进行了加减，这时候结果就出现了错误。解决这个问题也不难，只需要在读取的时候加锁，直到读取完毕之前都不能进行写入操作。</p>
<h4 id="执行栈"><a href="#执行栈" class="headerlink" title="执行栈"></a>执行栈</h4><p>所有的 <code>JS</code> 代码在运行时都是在执行上下文中进行的。<code>JS</code> 中有三种执行上下文：</p>
<ul>
<li>全局执行上下文，默认的，浏览器中是 <code>window</code> 对象，<code>nodejs</code> 中是 <code>global</code>，并且 <code>this</code> 在非严格模式下指向它们。</li>
<li>函数执行上下文，<code>JS</code> 的函数每当被调用时会创建一个上下文。</li>
<li><code>Eval</code> 执行上下文，<code>eval</code> 函数会产生自己的上下文。</li>
</ul>
<p>栈是一种数据结构，具有先进后出的原则。<code>JS</code> 中的执行栈就具有这样的结构，当引擎第一次遇到 <code>JS</code> 代码时，会产生一个全局执行上下文并压入执行栈，每遇到一个函数调用，就会往栈中压入一个新的上下文。引擎执行栈顶的函数，执行完毕，弹出当前执行上下文。</p>
<h4 id="微任务和宏任务"><a href="#微任务和宏任务" class="headerlink" title="微任务和宏任务"></a>微任务和宏任务</h4><p>异步任务被分为两种类型，微任务和宏任务</p>
<h5 id="微任务"><a href="#微任务" class="headerlink" title="微任务"></a>微任务</h5><ul>
<li><code>Promise.then</code></li>
<li><code>MutationObserver</code></li>
<li><code>process.nextTick</code></li>
</ul>
<h5 id="宏任务"><a href="#宏任务" class="headerlink" title="宏任务"></a>宏任务</h5><ul>
<li><code>script</code>(整体代码)</li>
<li><code>setTimout</code></li>
<li><code>setInterval</code></li>
<li><code>setImmediate</code></li>
<li><code>MessageChannel</code></li>
<li><code>requestAnimationFrame</code></li>
<li><code>postMessage</code></li>
<li><code>I/O</code></li>
<li><code>UI</code> 交互事件</li>
</ul>
<h4 id="事件循环-1"><a href="#事件循环-1" class="headerlink" title="事件循环"></a>事件循环</h4><p><code>Event Loop</code>(事件循环)中，每一次循环称为 <code>tick</code>, 每一次 <code>tick</code> 的任务如下：</p>
<ol>
<li>执行栈选择最先进入队列的宏任务(通常是 <code>script</code> 整体代码)，如果有则执行</li>
<li>检查是否存在 <code>Microtask</code>，如果存在则不停的执行，直至清空 <code>microtask</code> 队列</li>
<li>更新 <code>render</code>(每一次事件循环，浏览器都可能会去更新渲染)</li>
<li>重复以上步骤</li>
</ol>
<p>宏任务 &gt; 所有微任务 &gt; 宏任务，如下图所示：</p>
<p><img src="/images/js/eventLoop.jpg" alt="新建工程"></p>
<ol>
<li>将所有任务看成两个队列：执行队列与事件队列。</li>
<li>执行队列是同步的，事件队列是异步的，宏任务放入事件列表，微任务放入执行队列之后，事件队列之前。</li>
<li>当执行完同步代码之后，就会执行位于执行列表之后的微任务，然后再执行事件列表中的宏任务</li>
</ol>
<h3 id="react-中的异步实现"><a href="#react-中的异步实现" class="headerlink" title="react 中的异步实现"></a>react 中的异步实现</h3><p><code>react</code> 中的异步是通过宏任务来实现的，优先使用 <code>setImmediate</code> ，然后使用 <code>MessageChannel</code>，若都不支持则使用 <code>setTimeout</code> 实现</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> schedulePerformWorkUntilDeadline</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> localSetImmediate === <span class="string">'function'</span>) &#123;</span><br><span class="line">  <span class="comment">// Node.js and old IE.</span></span><br><span class="line">  <span class="comment">// There's a few reasons for why we prefer setImmediate.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Unlike MessageChannel, it doesn't prevent a Node.js process from exiting.</span></span><br><span class="line">  <span class="comment">// (Even though this is a DOM fork of the Scheduler, you could get here</span></span><br><span class="line">  <span class="comment">// with a mix of Node.js 15+, which has a MessageChannel, and jsdom.)</span></span><br><span class="line">  <span class="comment">// https://github.com/facebook/react/issues/20756</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// But also, it runs earlier which is the semantic we want.</span></span><br><span class="line">  <span class="comment">// If other browsers ever implement it, it's better to use it.</span></span><br><span class="line">  <span class="comment">// Although both of these would be inferior to native scheduling.</span></span><br><span class="line">  schedulePerformWorkUntilDeadline = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    localSetImmediate(performWorkUntilDeadline)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> MessageChannel !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">  <span class="comment">// DOM and Worker environments.</span></span><br><span class="line">  <span class="comment">// We prefer MessageChannel because of the 4ms setTimeout clamping.</span></span><br><span class="line">  <span class="keyword">const</span> channel = <span class="keyword">new</span> MessageChannel()</span><br><span class="line">  <span class="keyword">const</span> port = channel.port2</span><br><span class="line">  channel.port1.onmessage = performWorkUntilDeadline</span><br><span class="line">  schedulePerformWorkUntilDeadline = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    port.postMessage(<span class="literal">null</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// We should only fallback here in non-browser environments.</span></span><br><span class="line">  schedulePerformWorkUntilDeadline = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    localSetTimeout(performWorkUntilDeadline, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>判断是否存在 <code>setImmediate</code>，如果存在则使用 <code>setImmediate</code>，不存在下一步</li>
<li>判断是否支持 <code>MessageChannel</code>，如果支持则创建一个消息通道，通过消息通道实现宏任务，否则进行下一步</li>
<li>回落到 <code>setTimeout</code> 实现异步</li>
</ol>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://zhuanlan.zhihu.com/p/59784952" target="_blank" rel="noopener">深入理解 JavaScript 执行上下文和执行栈</a></li>
<li><a href="https://segmentfault.com/a/1190000015317434" target="_blank" rel="noopener">Js 的事件循环(Event Loop)机制以及实例讲解</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MessageChannel" target="_blank" rel="noopener">MessageChannel</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/05/30/react中的异步实现/" data-id="ckqza38j4002tyys6lwffav4h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-前端框架" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/18/前端框架/" class="article-date">
  <time datetime="2021-04-17T22:48:43.000Z" itemprop="datePublished">2021-04-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/18/前端框架/">前端框架</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="DOM-操作时代"><a href="#DOM-操作时代" class="headerlink" title="DOM 操作时代"></a>DOM 操作时代</h3><p>代表库 <a href="https://jquery.com/" target="_blank" rel="noopener"><code>jQuery</code></a> 和 <a href="https://zeptojs.com/" target="_blank" rel="noopener"><code>zepto</code></a></p>
<ul>
<li>简化选择器</li>
<li>简化 <code>DOM</code> 操作</li>
<li>简化 <code>AJAX</code> 操作</li>
<li>统一事件绑定</li>
<li>兼容性实现</li>
<li>延时对象（<code>$.Deferred</code>）</li>
</ul>
<h4 id="DOM-操作的一般流程"><a href="#DOM-操作的一般流程" class="headerlink" title="DOM 操作的一般流程"></a>DOM 操作的一般流程</h4><ol>
<li><code>DOM</code> 加载</li>
<li><code>js</code> 脚本加载</li>
<li><code>js</code>脚本执行，发送异步请求获取数据</li>
<li>操作 <code>DOM</code> 进行数据渲染</li>
<li>对 <code>DOM</code> 节点进行事件绑定</li>
</ol>
<p><img src="/images/domprocess.png" alt="DOM 操作流程"></p>
<h3 id="MV-交互模式"><a href="#MV-交互模式" class="headerlink" title="MV* 交互模式"></a>MV* 交互模式</h3><h4 id="MVC-模式"><a href="#MVC-模式" class="headerlink" title="MVC 模式"></a>MVC 模式</h4><p>将 <code>DOM</code> 交互部分的内容分为数据模型、视图和事件控制三部分</p>
<ul>
<li><code>Model</code>：存放请求的数据结果和数据对象</li>
<li><code>View</code>: 页面 <code>DOM</code> 的更新与修改</li>
<li><code>Controller</code>: 根据前端路由条件调用不同的 <code>Model</code> 和 <code>View</code>渲染不同的数据内容</li>
</ul>
<p>用户的操作直接通过 <code>Controller</code> 控制</p>
<h4 id="MVP-模式"><a href="#MVP-模式" class="headerlink" title="MVP 模式"></a>MVP 模式</h4><p><code>Model-View-Presenter</code>，将 <code>DOM</code> 交互部分的内容分为数据模型、视图和 <code>Presenter</code> 三部分</p>
<ul>
<li><code>Model</code>：存放请求的数据结果和数据对象（仅提供数据）</li>
<li><code>View</code>: 页面 <code>DOM</code> 的更新与修改（仅提供视图模板）</li>
<li><code>Presenter</code>: 根据前端路由条件调用不同的 <code>Model</code> 和 <code>View</code>渲染不同的数据内容（主要的逻辑处理）</li>
</ul>
<p><code>Presenter</code> 与 <code>View</code> 的绑定是双向的，<code>Presenter</code> 的改变会改变 <code>View</code>，<code>View</code> 的改变也会触发 <code>Presenter</code>，所有的逻辑调用数据和渲染视图 <code>View</code> 模板都在 <code>Presenter</code> 中完成，同时用户在 <code>View</code> 层操作的改变反馈到 <code>Presenter</code> 改变 <code>Model</code>并渲染新的 <code>View</code> 视图。</p>
<ul>
<li>优点：只需关注 <code>Presenter</code> 的逻辑</li>
<li>缺点：内容较重</li>
</ul>
<h4 id="MVVM-模式"><a href="#MVVM-模式" class="headerlink" title="MVVM 模式"></a>MVVM 模式</h4><p>自动化的 <code>MVP</code> 框架，用 <code>ViewModel</code> 代替 <code>Presenter</code>，<code>Model</code> 的调用和 <code>View</code> 由 <code>ViewModel</code> 自动触发完成<br>用户操作时， <code>ViewModel</code> 捕获数据变化，将变化反应到 <code>View</code> 上。 <code>ViewModel</code> 的数据操作最终在页面上以 <code>Directive</code> 的形式体现，通过对 <code>Directive</code> 的识别来渲染数据或绑定事件。</p>
<h5 id="通用基本设计"><a href="#通用基本设计" class="headerlink" title="通用基本设计"></a>通用基本设计</h5><ul>
<li><code>Directive</code>: 指令，即自定义执行函数</li>
<li><code>Filter</code>: 过滤器，对传入的初始数据信进行处理，然后把处理结果交给下一步（<code>Directive</code> 或 <code>Filter</code>）。</li>
<li>表达式：控制页面内容按照具体条件展示</li>
<li><code>ViewModel</code>: 实现传入的 <code>Model</code> 数据在内存中存放，也提供一些基本的读取或修改数据的 <code>API</code></li>
<li>数据变更检查： 即数据变化自动触发其它操作，通过手动触发、脏检测、对象劫持、<code>Proxy</code> 等</li>
</ul>
<h6 id="数据变更检查"><a href="#数据变更检查" class="headerlink" title="数据变更检查"></a>数据变更检查</h6><ul>
<li>手动触发: 通过在数据对象上定义 <code>get</code> 和 <code>set</code> 方法，调用时手动触发 <code>get</code> 和 <code>set</code> 来获取和修改数据，改变后主动触发 <code>get</code> 和 <code>set</code> 中 <code>View</code> 层的重新渲染功能</li>
<li>脏检测: 在 <code>ViewModel</code> 对象的某个属性值发生变化时找到与这个属性值相关的所有元素，然后比较数据变化，如果有变化则进行 <code>Directive</code> 指令调用，对这个元素进行重新扫描渲染</li>
<li>前端数据对象劫持： 使用 <code>Object.defineProperty</code> 和 <code>Object.defineProperties</code> 对 <code>ViewModel</code> 数据对象进行属性 <code>get</code> 和 <code>set</code> 的监听，当有数据读取和赋值时则扫描节点元素，运行指定对应节点的 <code>Directive</code> 指令。</li>
<li><code>ES6 Proxy</code>:类似与 <code>Object.defineProperty</code> 和 <code>Object.defineProperties</code></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/04/18/前端框架/" data-id="ckqza38jv003zyys6hej1kihq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/other/">other</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-用Hexo搭建静态博客" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/04/用Hexo搭建静态博客/" class="article-date">
  <time datetime="2021-04-04T15:05:16.564Z" itemprop="datePublished">2021-04-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/04/用Hexo搭建静态博客/">用Hexo搭建静态博客</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><ul>
<li>Git 安装及使用：<a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000" target="_blank" rel="noopener">廖雪峰的网站</a></li>
<li>Node.js 的安装：<a href="http://www.runoob.com/nodejs/nodejs-install-setup.html" target="_blank" rel="noopener">Node.js 安装配置</a></li>
<li>Hexo 的安装及使用：<a href="https://hexo.io/zh-cn/docs/index.html" target="_blank" rel="noopener">Hexo 文档</a></li>
<li>yilia 主题的安装配置：<a href="https://github.com/litten/hexo-theme-yilia" target="_blank" rel="noopener">yilia 简介、安装、配置</a></li>
</ul>
<h2 id="hexo-环境配置"><a href="#hexo-环境配置" class="headerlink" title="hexo 环境配置"></a>hexo 环境配置</h2><ul>
<li>创建文件夹 blog 作为项目文件夹</li>
<li>初始化项目文件夹</li>
</ul>
<ul>
<li><p>指定文件夹初始化</p>
<pre><code>hexo init blog
</code></pre></li>
<li><p>或者，进入文件夹再初始化</p>
<pre><code>cd blog
hexo init
</code></pre></li>
</ul>
<ul>
<li><p>安装插件 deployer</p>
<pre><code>npm install hexo-deployer-git --save
</code></pre></li>
<li><p>修改根目录下的 _config.yml 文件</p>
<pre><code>deploy:
type: git
repo: git@github.com:JackXuyi/JackXuyi.github.io.git
branch: master
</code></pre></li>
<li><p>配置域名：在 source 目录下添加 CNAME 文件，并在文件里写入你的域名</p>
<pre><code>xuyi-emb.win
</code></pre></li>
</ul>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><ul>
<li>源代码和发布的网站的存储位置不在同一个地方，使用不同分支保存数据，具体解释见 <a href="http://www.zhihu.com/question/21193762" target="_blank" rel="noopener">使用 hexo，如果换了电脑怎么更新博客？</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/04/04/用Hexo搭建静态博客/" data-id="ckqza38kb004oyys6hh6bquam" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/other/">other</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-与native交互" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/04/与native交互/" class="article-date">
  <time datetime="2021-04-03T20:06:35.000Z" itemprop="datePublished">2021-04-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/04/与native交互/">与native交互</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Hybird-App"><a href="#Hybird-App" class="headerlink" title="Hybird App"></a><code>Hybird App</code></h3><p>在 <code>Native App</code> 引用基础上结合了 <code>Web App</code> 应用所形成的模式，一般通过 <code>webview</code> 的模式引入</p>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>系统资源较少，包括 <code>CPU</code> 、内存、网卡、网络链接等。</li>
<li>支持更新的浏览器特性，不用考虑 <code>IE</code> 的兼容性问题</li>
<li>可以实现离线应用，通过新的浏览器特性或 <code>Native</code> 的文件读取机制进行文件级的文件缓存和离线更新</li>
<li>不同机型设备的兼容问题</li>
<li>可以调用客户端 <code>Native</code> 的能力，例如摄像头、定位、传感器、本地文件访问等。</li>
</ul>
<h3 id="Web-到-Native-的协议调用"><a href="#Web-到-Native-的协议调用" class="headerlink" title="Web 到 Native 的协议调用"></a><code>Web</code> 到 <code>Native</code> 的协议调用</h3><h4 id="通过-URI-请求"><a href="#通过-URI-请求" class="headerlink" title="通过 URI 请求"></a>通过 <code>URI</code> 请求</h4><p>在系统中注册一个 <code>Schema</code> 协议的 <code>URI</code> ，这个 <code>URI</code> 可以在系统的任意地方调起一段原生方法或一个原生的界面</p>
<p><img src="/images/webtonative.svg" alt="`web` 通过 `URI` 请求 `Native` 流程"></p>
<h4 id="通过-addJavascriptInterface-注入方法到页面中调用"><a href="#通过-addJavascriptInterface-注入方法到页面中调用" class="headerlink" title="通过 addJavascriptInterface 注入方法到页面中调用"></a>通过 <code>addJavascriptInterface</code> 注入方法到页面中调用</h4><p>通过 <code>addJavascriptInterface</code> 方法向页面中注入一个全局对象以供调用</p>
<h4 id="注入对象"><a href="#注入对象" class="headerlink" title="注入对象"></a>注入对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明 ws 实例</span></span><br><span class="line">WebSettings ws = webView.getSetting();</span><br><span class="line"><span class="comment">// 开启执行 JavaScript 脚本</span></span><br><span class="line">ws.setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 加载页面</span></span><br><span class="line">ws.loadUrl(<span class="string">"xxx"</span>);</span><br><span class="line"><span class="comment">// 注入全局对象</span></span><br><span class="line">ws.addJavascriptInterface(<span class="keyword">new</span> Object(), <span class="string">"native"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// 调用注入的 native 方法</span></span></span><br><span class="line">    native.method()</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Native-到-Web-的调用"><a href="#Native-到-Web-的调用" class="headerlink" title="Native 到 Web 的调用"></a><code>Native</code> 到 <code>Web</code> 的调用</h3><ul>
<li>安卓：通过 <code>webView.loadUrl</code> 方法实现</li>
<li>iOS ：通过 <code>stringByEvaluatingJavaScriptFromString</code> 方法实现</li>
</ul>
<h4 id="html-定义方法"><a href="#html-定义方法" class="headerlink" title="html 定义方法"></a>html 定义方法</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">log</span>(<span class="params">msg</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">console</span>.log(msg)</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="原生调用"><a href="#原生调用" class="headerlink" title="原生调用"></a>原生调用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明 ws 实例</span></span><br><span class="line">WebSettings ws = webView.getSetting();</span><br><span class="line"><span class="comment">// 开启执行 JavaScript 脚本</span></span><br><span class="line">ws.setJavaScriptEnabled(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// 加载页面</span></span><br><span class="line">ws.loadUrl(<span class="string">"xxx"</span>);</span><br><span class="line"><span class="comment">// 调用 js 方法</span></span><br><span class="line">webView.loadUr(<span class="string">"javascript: log('hello world')"</span>)</span><br></pre></td></tr></table></figure>
<h3 id="JSBridge"><a href="#JSBridge" class="headerlink" title="JSBridge"></a><code>JSBridge</code></h3><p>通信规则： <code>jsBridge://className:callbackMethod/methodName?jsonObj</code></p>
<h4 id="安卓实现"><a href="#安卓实现" class="headerlink" title="安卓实现"></a>安卓实现</h4><p>通过 <code>prompt</code> 方式调用。 <code>addJavascriptInterface</code> 存在安全漏洞，可以通过 <code>JavascriptInterface</code> 来解决，但是其存在兼容性问题。所以通过 <code>webView.setWebChromeClient</code> 来实现： <code>JavaScript</code> 在执行 <code>alert</code> 和 <code>prompt</code> 时， <code>Native</code> 端会自动触发 <code>onJsAlert</code> 和 <code>onJsPrompt</code> 的方法回调函数，由于 <code>alert</code> 比较常用，所以可以通过重写 <code>onJsPrompt</code> 的方法实现对 <code>Native</code> 端方法的调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置 prompt 监听</span></span><br><span class="line">webView.setWebChromeClient(<span class="keyword">new</span> WebChromeClient() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onJsPrompt</span><span class="params">(WebView wv, String url, String msg, String defaultValue, JsPromptResult res)</span> </span>&#123;</span><br><span class="line">        res.confirm(JSBridge.callJsPrompt(MainActivity.<span class="keyword">this</span>, wv, msg));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="iOS-实现"><a href="#iOS-实现" class="headerlink" title="iOS 实现"></a><code>iOS</code> 实现</h4><p>通过 <code>iframe</code> 的方式调用</p>
<h4 id="调用流程"><a href="#调用流程" class="headerlink" title="调用流程"></a>调用流程</h4><ol>
<li>安卓通过 <code>prompt(jsBridge://className:callbackMethod/methodName?jsonObj)</code> 调用，<code>iOS</code> 通过 <code>iframe</code> 方式调用</li>
<li><code>Native</code> 解析协议，调用对应的 <code>className</code> 对象中的 <code>methodName</code> 方法，并把对应的参数 <code>jsonObj</code> 序列化后作为方法的参数</li>
<li>执行完成后调用 <code>JavaScript</code> 回调函数返回结果</li>
</ol>
<p><img src="/images/jsbridge.svg" alt="调用流程"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/04/04/与native交互/" data-id="ckqza38ju003xyys60gsyszdo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/other/">other</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-实时协议" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/04/02/实时协议/" class="article-date">
  <time datetime="2021-04-01T23:38:14.000Z" itemprop="datePublished">2021-04-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/04/02/实时协议/">实时协议</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="websocket"><a href="#websocket" class="headerlink" title="websocket"></a>websocket</h3><p><code>WebSocket</code> 是一种在单个 <code>TCP</code> 连接上进行全双工通信的协议，允许服务端主动向客户端推送数据。在 <code>WebSocket API</code> 中，浏览器和服务器只需要完成一次握手，两者之间就直接可以创建持久性的连接，并进行双向数据传输。</p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p><a href="/2021/01/06/nodejs中实现websocket服务/">nodejs 中实现 websocket 服务</a></p>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>较少的控制开销。在连接创建后，服务器和客户端之间交换数据时，用于协议控制的数据包头部相对较小。在不包含扩展的情况下，对于服务器到客户端的内容，此头部大小只有 2 至 10 字节（和数据包长度有关）；对于客户端到服务器的内容，此头部还需要加上额外的 4 字节的掩码。相对于 HTTP 请求每次都要携带完整的头部，此项开销显著减少了。</li>
<li>更强的实时性。由于协议是全双工的，所以服务器可以随时主动给客户端下发数据。相对于 HTTP 请求需要等待客户端发起请求服务端才能响应，延迟明显更少；即使是和 Comet 等类似的长轮询比较，其也能在短时间内更多次地传递数据。</li>
<li>保持连接状态。与 HTTP 不同的是，Websocket 需要先创建连接，这就使得其成为一种有状态的协议，之后通信时可以省略部分状态信息。而 HTTP 请求可能需要在每个请求都携带状态信息（如身份认证等）。</li>
<li>更好的二进制支持。Websocket 定义了二进制帧，相对 HTTP，可以更轻松地处理二进制内容。</li>
<li>可以支持扩展。Websocket 定义了扩展，用户可以扩展协议、实现部分自定义的子协议。如部分浏览器支持压缩等。</li>
<li>更好的压缩效果。相对于 HTTP 压缩，Websocket 在适当的扩展支持下，可以沿用之前内容的上下文，在传递类似的数据时，可以显著地提高压缩率。</li>
</ul>
<h3 id="长轮询"><a href="#长轮询" class="headerlink" title="长轮询"></a>长轮询</h3><p><code>HTTP</code> 请求设置一个较长的超时等待时间，网络请求可以维持一个较长的时间来等待返回结果，如果在等待的时间内有结果会立即返回结果，如果没有结果就会超时自动断开链接，等待下一次请求。</p>
<p><img src="/images/long-poll.svg" alt="长轮询流程"></p>
<h3 id="短轮询"><a href="#短轮询" class="headerlink" title="短轮询"></a>短轮询</h3><p>每隔一段时间定时向服务端发起一次请求拉取数据。</p>
<p><img src="/images/poll.svg" alt="短轮询流程"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://baike.baidu.com/item/WebSocket/1953845?fr=aladdin" target="_blank" rel="noopener">WebSocket</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/04/02/实时协议/" data-id="ckqza38jx0043yys683ys266y" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-HTTPS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/28/HTTPS/" class="article-date">
  <time datetime="2021-03-27T20:13:54.000Z" itemprop="datePublished">2021-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/28/HTTPS/">HTTPS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><code>HTTPS</code> 协议是通过加入 <code>SSL</code> 层来加密 <code>HTTP</code> 数据进行安全通信的</p>
<h3 id="HTTPS-建立链接的过程"><a href="#HTTPS-建立链接的过程" class="headerlink" title="HTTPS 建立链接的过程"></a><code>HTTPS</code> 建立链接的过程</h3><ol>
<li>客户端发起请求，携带客户端支持加密算法，同时携带随机串 1</li>
<li>服务端收到请求后与自己支持的加密算法进行比对，从双方都支持的加密算法中选择一个返回，同时返回域名相关的公钥和证书签名信息（包括证书时间、日期、颁发机构）及随机串 2</li>
<li>客户端收到响应后验证证书的合法性和公钥的正确性（通过请求证书颁发机构来验证证书的合法性）</li>
<li>证书验证通过后，利用公钥加密一个随机字符串作为后续传输数据的密钥，同时加入利用公钥加密随机串 1 和随机串 2 组成的握手信息，然后发送给服务端</li>
<li>服务端获取到信息后利用私钥进行解密得到客户端生成的随机字符串把它作为后续传输的密钥，利用密钥对传输的随机串 1 和随机串 2 进行加密，然后返回</li>
<li>客户端利用上述生成的随机串对返回的信息进行解密，然后验证其合法性，后续传输就是堆成加密传输</li>
</ol>
<p><img src="/images/https.svg" alt="HTTPS 获取密钥过程"></p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="https://www.jianshu.com/p/33d0f8631f90" target="_blank" rel="noopener">https 建立连接过程</a></li>
<li><a href="https://blog.csdn.net/xiaoming100001/article/details/81109617" target="_blank" rel="noopener">HTTP 和 HTTPS 协议，看一篇就够了
</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/03/28/HTTPS/" data-id="ckqza38he0001yys6wl0pwwr3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-网络安全" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/28/网络安全/" class="article-date">
  <time datetime="2021-03-27T19:34:30.000Z" itemprop="datePublished">2021-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/28/网络安全/">网络安全</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前端攻击"><a href="#前端攻击" class="headerlink" title="前端攻击"></a>前端攻击</h3><h4 id="XSS"><a href="#XSS" class="headerlink" title="XSS"></a><code>XSS</code></h4><p>跨站脚本攻击，由插入页面处理的数据未经处理导致。</p>
<ul>
<li>存储型 <code>XSS</code> ：提交的数据未经处理存储到数据库中，然后从数据库中获取数据插入页面导致的</li>
<li>反射型 <code>XSS</code> ：通过 <code>URL</code> 提取参数未经处理直接插入到页面导致</li>
<li><code>MXSS</code> ：渲染 <code>DOM</code> 时插入了攻击脚本（模板渲染）</li>
</ul>
<p>通过字符转义的方式把特殊的符号转化为安全的 <code>HTML</code> 字符（如 &lt;、&gt;等）</p>
<h4 id="SQL-注入攻击"><a href="#SQL-注入攻击" class="headerlink" title="SQL 注入攻击"></a><code>SQL</code> 注入攻击</h4><p>结构性查询语言注入攻击，页面提交的数据直接拼接到 <code>SQL</code> 语句进行操作导致，通过对查询数据进行合法性校验即可避免</p>
<h4 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a><code>CSRF</code></h4><p>跨站请求伪造，非源站点按照源站点数据格式提交非法数据给源站点的一种攻击方式。大部分网站是通过 <code>COOKIE</code> 的方式来验证登录的用户信息，由于浏览器的策略导致请求时会自动携带相关 <code>COOKIE</code>，当非源站点请求源站点数据时也会携带相关 <code>COOKIE</code>，此时构造一个非法的请求也会请求成功。解决办法就是通过在页面中预先植入 <code>TOKEN</code> ，在接口请求时再手动携带上相关的值，由于浏览器的安全策略限制非源站点无法读取相关数据进而导致请求失败</p>
<h3 id="网络劫持"><a href="#网络劫持" class="headerlink" title="网络劫持"></a>网络劫持</h3><p>网络资源请求在请求过程中因为人为的攻击导致没有加载到预期的资源内容。</p>
<h4 id="DNS-劫持"><a href="#DNS-劫持" class="headerlink" title="DNS 劫持"></a><code>DNS</code> 劫持</h4><p>攻击者通过篡改 <code>DNS</code> 服务器的域名解析记录，导致用户无法访问正确的网络 <code>IP</code> ，而是访问篡改后的错误 <code>IP</code> 地址。</p>
<h4 id="HTTP-劫持"><a href="#HTTP-劫持" class="headerlink" title="HTTP 劫持"></a><code>HTTP</code> 劫持</h4><p>在用户浏览器和访问的目的服务器之间建立的网络数据传输通道中从网关或防火墙层上监视特定的数据信息，当满足特定条件时，就会在正常的数据包中插入或篡改网络数据包（如 <code>ISP</code> 在部分第三方网站页面中植入广告）。可以通过 <code>HTTPS</code> 协议来预防</p>
<h3 id="浏览器-WEB-安全控制"><a href="#浏览器-WEB-安全控制" class="headerlink" title="浏览器 WEB 安全控制"></a>浏览器 <code>WEB</code> 安全控制</h3><h4 id="X-XSS-Protection"><a href="#X-XSS-Protection" class="headerlink" title="X-XSS-Protection"></a><code>X-XSS-Protection</code></h4><p>防止反射型 <code>XSS</code> 问题的发生，浏览器层面增强前端网页的安全性。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">X-XSS-Protection:</span> <span class="number">0</span> <span class="comment"># 禁止XSS过滤。</span></span><br><span class="line"><span class="attr">X-XSS-Protection:</span> <span class="number">1</span> <span class="comment"># 启用XSS过滤（通常浏览器是默认的）。 如果检测到跨站脚本攻击，浏览器将清除页面（删除不安全的部分）。</span></span><br><span class="line"><span class="attr">X-XSS-Protection:</span> <span class="number">1</span><span class="string">;</span> <span class="string">mode=block</span> <span class="comment"># 启用XSS过滤。 如果检测到攻击，浏览器将不会清除页面，而是阻止页面加载。</span></span><br><span class="line"><span class="attr">X-XSS-Protection:</span> <span class="number">1</span><span class="string">;</span> <span class="string">report=&lt;reporting-uri&gt;</span> <span class="comment"># 启用XSS过滤。 如果检测到跨站脚本攻击，浏览器将清除页面并使用CSP report-uri (en-US)指令的功能发送违规报告。</span></span><br></pre></td></tr></table></figure>
<h4 id="Strict-Transport-Security"><a href="#Strict-Transport-Security" class="headerlink" title="Strict-Transport-Security"></a><code>Strict-Transport-Security</code></h4><p>配置浏览器和服务器之间安全通信的机制，防止中间者攻击（强制使用 <code>HTTPS</code> 协议，普通协议无效）</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Strict-Transport-Security:</span> <span class="string">max-age=&lt;expire-time&gt;</span> <span class="comment"># 设置在浏览器收到这个请求后的&lt;expire-time&gt;秒的时间内凡是访问这个域名下的请求都使用HTTPS请求。</span></span><br><span class="line"><span class="attr">Strict-Transport-Security:</span> <span class="string">max-age=&lt;expire-time&gt;;</span> <span class="string">includeSubDomains</span> <span class="comment"># 如果这个可选的参数被指定，那么说明此规则也适用于该网站的所有子域名。</span></span><br><span class="line"><span class="attr">Strict-Transport-Security:</span> <span class="string">max-age=&lt;expire-time&gt;;</span> <span class="string">preload</span> <span class="comment"># 查看 预加载 HSTS 获得详情。不是标准的一部分。</span></span><br></pre></td></tr></table></figure>
<h4 id="Content-Security-Policy"><a href="#Content-Security-Policy" class="headerlink" title="Content-Security-Policy"></a><code>Content-Security-Policy</code></h4><p>开发者定义的安全策略性声明，浏览器只可以加载指定可信域名来源的内容（包括脚本、图片、<code>iframe</code>、<code>font</code>、<code>style</code> 等）</p>
<h4 id="Access-Control-Allow-Origin"><a href="#Access-Control-Allow-Origin" class="headerlink" title="Access-Control-Allow-Origin"></a><code>Access-Control-Allow-Origin</code></h4><p>决定哪些网站可以访问当前服务器资源，通过定义通配符可以让所有网站来访问当前网站的所有资源。若 <code>Access-Control-Allow-Origin</code> 为 <code>*</code>，则 <code>Access-Control-Allow-Credentials</code> 无效。若想 <code>Access-Control-Allow-Credentials</code> 有效（即请求携带 <code>Cookie</code>），则必须明确配置来源。</p>
<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/X-XSS-Protection" target="_blank" rel="noopener"><code>X-XSS-Protection</code></a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Strict-Transport-Security" target="_blank" rel="noopener"><code>Strict-Transport-Security</code></a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" target="_blank" rel="noopener"><code>Content-Security-Policy</code></a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Access-Control-Allow-Origin" target="_blank" rel="noopener"><code>Access-Control-Allow-Origin</code></a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/03/28/网络安全/" data-id="ckqza38kg004yyys6c3clfc2n" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-http协议" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/22/http协议/" class="article-date">
  <time datetime="2021-03-21T16:41:21.000Z" itemprop="datePublished">2021-03-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/22/http协议/">http协议</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><p>无状态、无连接的应用层协议</p>
<h3 id="HTTP-1-0"><a href="#HTTP-1-0" class="headerlink" title="HTTP 1.0"></a>HTTP 1.0</h3><p>浏览器和服务器保持短暂的连接，浏览器的每次请求都需要与服务器建立一个 TCP 连接，服务器处理完成后立即断开 TCP 连接（无连接），服务器不跟踪每个客户端也不记录过去的请求（无状态）。</p>
<h3 id="HTTP-1-1"><a href="#HTTP-1-1" class="headerlink" title="HTTP 1.1"></a>HTTP 1.1</h3><p>发布于 1999 年，默认使用文本格式传输数据</p>
<h4 id="长链接"><a href="#长链接" class="headerlink" title="长链接"></a>长链接</h4><p>默认包含 <code>Connection: keep-alive</code> 头，可以让客户端和服务端在一段时间内可以复用这个链接，无需再次建立链接。链接复用发生在应用层，且复用是串行的</p>
<h4 id="支持请求管道化"><a href="#支持请求管道化" class="headerlink" title="支持请求管道化"></a>支持请求管道化</h4><p>基于 HTTP1.1 的长连接，使得请求管线化成为可能。管线化使得请求能够“并行”传输。虽然 HTTP1.1 支持管道化，但是服务器必须按照客户端请求的先后顺序依次回送相应的结果，以保证客户端能够区分出每次请求的响应内容。</p>
<p><img src="/images/brower/http_pipe.png" alt="HTTP1.1 支持管道化链接图"></p>
<p>由于“管道化”技术存在各种各样的问题，所以很多浏览器要么根本不支持它，要么就直接默认关闭。</p>
<h4 id="协议扩展切换"><a href="#协议扩展切换" class="headerlink" title="协议扩展切换"></a>协议扩展切换</h4><p>支持在请求头部域消息中包含 <code>Upgrade</code> 头并让客户端通过头部标识令服务器知道它能够支持其它备用通信协议的一种机制，服务器根据客户端请求的其它协议进行切换，切换后使用备用协议与客户端进行通信</p>
<h4 id="缓存控制"><a href="#缓存控制" class="headerlink" title="缓存控制"></a>缓存控制</h4><p>新增 <code>Cache-Control</code> 字段，支持 <code>max-age</code> 用来表示相对过期时间；服务器也可以通过 <code>Etag</code> 和 <code>Last-Modified</code> 来判断是否从浏览器中加载文件，此时缓存的控制和判断将决定响应状态码是 200 还是 304。参考<a href="/2020/08/31/浏览器缓存/">浏览器缓存</a>章节</p>
<h4 id="部分内容传输优化"><a href="#部分内容传输优化" class="headerlink" title="部分内容传输优化"></a>部分内容传输优化</h4><p>引入了 <code>range</code> 头域支持超文本文件的部分传输。如允许请求一个文件的起始位置和偏移长度来进行文件内容的部分传输</p>
<h4 id="Host-头处理"><a href="#Host-头处理" class="headerlink" title="Host 头处理"></a>Host 头处理</h4><p>请求消息和响应消息都支持 <code>Host</code> 头域，且请求消息中如果没有 <code>Host</code> 头域会报告一个错误（<code>400 Bad Request</code>）</p>
<h4 id="错误通知的管理"><a href="#错误通知的管理" class="headerlink" title="错误通知的管理"></a>错误通知的管理</h4><p>新增了 <code>24</code> 个错误状态响应码，如 <code>409（Conflict）</code>表示请求的资源与资源的当前状态发生冲突；<code>410（Gone）</code>表示服务器上的某个资源被永久性的删除。</p>
<h3 id="HTTP-2-0"><a href="#HTTP-2-0" class="headerlink" title="HTTP 2.0"></a>HTTP 2.0</h3><ul>
<li>采用完全的二进制格式来传输数据，其在网络中以帧的形式传播，多个帧在网络中形成了帧的传输网络流，即流式传播的。</li>
<li>使用 <code>TCP</code> 复用的方式来降低网络请求链接的建立和关闭的开销，多个请求可以通过一个链接来进行并发完成。复用发生在传输层，是帧的多路复用，不同文件的传输可以在一个 <code>TCP</code> 连接中一起同时进行流式传播</li>
<li>支持传输流的优先级和流量控制机制</li>
<li>支持服务端推送</li>
</ul>
<h4 id="二进制分帧"><a href="#二进制分帧" class="headerlink" title="二进制分帧"></a>二进制分帧</h4><p>通过在应用层和传输层之间增加一个二进制分帧层，突破了 HTTP1.1 的性能限制、改进传输性能。</p>
<p><img src="/images/brower/http_bf.jpg" alt="二进制分帧结构图"></p>
<h4 id="多路复用（连接共享）"><a href="#多路复用（连接共享）" class="headerlink" title="多路复用（连接共享）"></a>多路复用（连接共享）</h4><ul>
<li>流（stream）：已建立连接上的双向字节流。</li>
<li>消息：与逻辑消息对应的完整的一系列数据帧。</li>
<li>帧（frame）：HTTP2.0 通信的最小单位，每个帧包含帧头部，至少也会标识出当前帧所属的流（stream id）。</li>
</ul>
<p><img src="/images/brower/http_stream.jpg" alt="多路复用（连接共享）"></p>
<p>所有的 HTTP2.0 通信都在一个 TCP 连接上完成，这个连接可以承载任意数量的双向数据流。每个数据流以消息的形式发送，而消息由一或多个帧组成。这些帧可以乱序发送，然后再根据每个帧头部的流标识符（stream id）重新组装。</p>
<h4 id="头部压缩"><a href="#头部压缩" class="headerlink" title="头部压缩"></a>头部压缩</h4><p>使用 encoder 来减少需要传输的 header 大小，通讯双方各自 cache 一份 header fields 表，既避免了重复 header 的传输，又减小了需要传输的大小。高效的压缩算法可以很大的压缩 header，减少发送包的数量从而降低延迟。</p>
<p>在头部压缩技术中，客户端和服务器均会维护两份相同的静态字典和动态字典。在静态字典中，包含了常见的头部名称以及头部名称与值的组合。静态字典在首次请求时就可以使用。那么现在头部的字段就可以被简写成静态字典中相应字段对应的 index。而动态字典跟连接的上下文相关，每个 HTTP/2 连接维护的动态字典是不尽相同的。动态字典可以在连接中不听的进行更新。原本完整的 HTTP 报文头部的键值对或字段，由于字典的存在，现在可以转换成索引 index，在相应的端再进行查找还原，也就起到了压缩的作用。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.jianshu.com/p/be29d679cbff" target="_blank" rel="noopener">HTTP1.0、HTTP1.1 和 HTTP2.0 的区别</a></li>
<li><a href="https://segmentfault.com/a/1190000013028798?utm_source=tag-newest" target="_blank" rel="noopener">HTTP1.0 HTTP1.1 HTTP2.0 主要特性对比</a></li>
<li><a href="https://www.jianshu.com/p/52d86558ca57" target="_blank" rel="noopener">如何优雅的谈论 HTTP／1.0／1.1／2.0</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/03/22/http协议/" data-id="ckqza38i6000vyys6qwcgj3nd" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-commonjs" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/03/commonjs/" class="article-date">
  <time datetime="2021-03-02T23:44:49.000Z" itemprop="datePublished">2021-03-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/03/commonjs/">commonjs</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="commonjs-规范"><a href="#commonjs-规范" class="headerlink" title="commonjs 规范"></a>commonjs 规范</h3><ul>
<li>模块引用：通过 <code>require</code> 方法把模块引入上下文</li>
<li>模块定义：模块中通过 <code>exports</code> 属性导出模块的方法和变量，<code>module</code> 代表模块自身</li>
<li>模块标识：传递给 <code>require</code> 方法的参数</li>
</ul>
<h3 id="node-实现"><a href="#node-实现" class="headerlink" title="node 实现"></a>node 实现</h3><h5 id="引入模块的流程"><a href="#引入模块的流程" class="headerlink" title="引入模块的流程"></a>引入模块的流程</h5><ol>
<li>路径分析</li>
<li>文件定位</li>
<li>编译执行</li>
</ol>
<h5 id="模块分类"><a href="#模块分类" class="headerlink" title="模块分类"></a>模块分类</h5><ol>
<li>核心模块：<code>Node</code> 源代码的编译过程中，编译进了二进制执行文件。<code>Node</code> 启动时已经被加载入内存中</li>
<li>文件模块：运行时动态加载</li>
</ol>
<h4 id="模块缓存"><a href="#模块缓存" class="headerlink" title="模块缓存"></a>模块缓存</h4><ol>
<li>引入过的模块都会进行缓存</li>
<li>缓存优先</li>
</ol>
<h4 id="路径分析和文件定位"><a href="#路径分析和文件定位" class="headerlink" title="路径分析和文件定位"></a>路径分析和文件定位</h4><h5 id="模块路径"><a href="#模块路径" class="headerlink" title="模块路径"></a>模块路径</h5><p><code>Node</code> 中在定位文件模块的具体文件时制定的查找策略，根据查找规则生成查找路径数组，查找规则如下</p>
<ol>
<li>查找当前目录下的 <code>node_modules</code> 目录</li>
<li>父目录下的 <code>node_modules</code> 目录</li>
<li>沿着路径向上逐级递归直到找到根目录的 <code>node_modules</code> 目录</li>
</ol>
<h5 id="模块标志符分析"><a href="#模块标志符分析" class="headerlink" title="模块标志符分析"></a>模块标志符分析</h5><ul>
<li>核心模块</li>
<li>相对路径模块和绝对路径模块：转化为真实路径作为索引来查找和缓存模块</li>
<li>非路径形式的文件模块</li>
</ul>
<h5 id="文件定位"><a href="#文件定位" class="headerlink" title="文件定位"></a>文件定位</h5><ul>
<li>文件扩展名分析：<code>Node</code> 会按照 <code>.js</code>、<code>.json</code>、<code>.node</code>的次序依次尝试扩展名，尝试过程中会阻塞式的判断文件是否存在</li>
<li>目录分析与包：分析标识符得到一个文件夹时，<code>Node</code> 会按照 <code>package.json</code>、<code>index.js</code>、<code>index.json</code>、<code>index.node</code>来查找文件，若查找到 <code>package.json</code> 会提取 <code>main</code> 指定的文件来进行定位</li>
</ul>
<h4 id="模块编译"><a href="#模块编译" class="headerlink" title="模块编译"></a>模块编译</h4><p>定位到具体的文件之后，<code>Node</code> 会构建一个模块对象，然后根据路径载入并编译</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Module</span>(<span class="params">id, parent</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.id = id</span><br><span class="line">  <span class="keyword">this</span>.parent = parent</span><br><span class="line">  <span class="keyword">this</span>.exports = &#123;&#125;</span><br><span class="line">  <span class="keyword">this</span>.filename = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">this</span>.loaded = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">this</span>.children = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (parent &amp;&amp; parent.children) &#123;</span><br><span class="line">    parent.children.push(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="不同扩展名的载入方式"><a href="#不同扩展名的载入方式" class="headerlink" title="不同扩展名的载入方式"></a>不同扩展名的载入方式</h5><ul>
<li><code>.js</code> 文件：通过 <code>fs</code> 模块同步读取文件后编译执行</li>
<li><code>.node</code> 文件：<code>c/c++</code> 写的扩展文件，通过 <code>dlopen()</code> 方法加载编译生成的文件</li>
<li><code>.json</code> 文件：通过 <code>fs</code> 模块同步读取文件后返回 <code>JSON.parse</code> 的结果</li>
<li>其它类型的文件：当作 <code>.js</code> 文件来处理</li>
</ul>
<h6 id="注：-可以通过-require-extensions-quot-ext-quot-的方式来扩展方式，但是已不推荐"><a href="#注：-可以通过-require-extensions-quot-ext-quot-的方式来扩展方式，但是已不推荐" class="headerlink" title="注： 可以通过 require.extensions[&quot;.ext&quot;] 的方式来扩展方式，但是已不推荐"></a>注： 可以通过 <code>require.extensions[&quot;.ext&quot;]</code> 的方式来扩展方式，但是已不推荐</h6><h5 id="JavaScript-模块的编译"><a href="#JavaScript-模块的编译" class="headerlink" title="JavaScript 模块的编译"></a><code>JavaScript</code> 模块的编译</h5><p><code>Node</code> 对获取的 <code>JavaScript</code> 文件内容做了包装，在头部添加了 <code>(function(exports, require, module, __filename, __dirname){\n</code>，在尾部添加了 <code>\n})</code>，包装之后的代码会通过 <code>vm</code> 原生的 <code>runInThisContext()</code> 方法执行，返回一个 <code>function</code> 对象，然后将当前模块对象的 <code>exports</code> 属性、<code>require</code> 方法、 <code>module</code>（模块对象自身）、模块定位中的完整文件路径和目录作为参数传递给这个函数执行，执行之后模块的 <code>exports</code> 属性被返回给了调用方</p>
<h6 id="注：-exports-属性是作为形参传入的，直接赋值会改变形参的引用，通过-module-exports-赋值采用迂回的方案不改变形参的引用"><a href="#注：-exports-属性是作为形参传入的，直接赋值会改变形参的引用，通过-module-exports-赋值采用迂回的方案不改变形参的引用" class="headerlink" title="注： exports 属性是作为形参传入的，直接赋值会改变形参的引用，通过 module.exports 赋值采用迂回的方案不改变形参的引用"></a>注： <code>exports</code> 属性是作为形参传入的，直接赋值会改变形参的引用，通过 <code>module.exports</code> 赋值采用迂回的方案不改变形参的引用</h6><h5 id="c-c-模块的编译"><a href="#c-c-模块的编译" class="headerlink" title="c/c++ 模块的编译"></a><code>c/c++</code> 模块的编译</h5><p><code>Node</code> 调用 <code>process.dlopen</code> 方法进行加载和执行，模块的 <code>exports</code> 对象和 <code>.node</code> 模块产生联系并返回给调用者</p>
<ul>
<li>优点： 执行效率高</li>
<li>缺点：门槛高</li>
</ul>
<h5 id="JSON-文件的编译"><a href="#JSON-文件的编译" class="headerlink" title="JSON 文件的编译"></a><code>JSON</code> 文件的编译</h5><p><code>Node</code> 利用 <code>fs</code> 模块同步读取 <code>JSON</code> 文件内容之后，调用 <code>JSON.parse</code> 方法得到对象，然后赋值给对象的 <code>exports</code> 属性供外部调用</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/03/03/commonjs/" data-id="ckqza38hy000jyys6w9esv7k8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-浏览器基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/02/浏览器基础/" class="article-date">
  <time datetime="2021-03-01T23:06:23.000Z" itemprop="datePublished">2021-03-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/02/浏览器基础/">浏览器基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="浏览器组成"><a href="#浏览器组成" class="headerlink" title="浏览器组成"></a>浏览器组成</h3><h4 id="用户界面"><a href="#用户界面" class="headerlink" title="用户界面"></a>用户界面</h4><p>包括浏览器中可见的地址输入框、浏览器前进返回按钮、打开书签、打开历史记录等用户可操作的功能选项</p>
<h4 id="浏览器引擎"><a href="#浏览器引擎" class="headerlink" title="浏览器引擎"></a>浏览器引擎</h4><p>可以在用户界面和渲染引擎之间传送指令或在客户端本地缓存中读写数据等，是浏览器各个部分通信的核心。</p>
<h4 id="渲染引擎（内核）"><a href="#渲染引擎（内核）" class="headerlink" title="渲染引擎（内核）"></a>渲染引擎（内核）</h4><p>解析 <code>DOM</code> 文档和 <code>CSS</code> 规则并将内容排版到浏览器中显示有样式的界面</p>
<h4 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h4><p>开启网络线程发送请求或下载资源文件</p>
<h4 id="UI-后端"><a href="#UI-后端" class="headerlink" title="UI 后端"></a>UI 后端</h4><p>绘制基本的浏览器窗口内的控件，比如组合选择框、按钮、输入框等</p>
<h4 id="JavaScript-引擎"><a href="#JavaScript-引擎" class="headerlink" title="JavaScript 引擎"></a><code>JavaScript</code> 引擎</h4><p>解析和执行 <code>JavaScript</code> 脚本，比如 <code>V8</code> 引擎</p>
<h4 id="持久化数据存储"><a href="#持久化数据存储" class="headerlink" title="持久化数据存储"></a>持久化数据存储</h4><p>数据持久化存储，涉及 <code>cookie</code> 、 <code>localStorage</code> 等客户端存储技术</p>
<h3 id="渲染引擎"><a href="#渲染引擎" class="headerlink" title="渲染引擎"></a>渲染引擎</h3><ol>
<li>解析 <code>HTML</code> 构建 <code>DOM</code>树：将 HTML 元素标签解析成由多个 DOM 元素对象节点组成的具有节点父子关系的 DOM 树结构</li>
<li>构建渲染树：按顺序提取 DOM 元素对象的样式数据，构建带样式描述的 DOM 渲染树对象</li>
<li>渲染布局阶段：根据节点的大小和位置把元素绘制在页面上，主要是布局属性（例如： postion、float、margin、padding 等）生效</li>
<li>绘制渲染树：将节点的背景、颜色、文本等样式信息应用到节点上，主要是元素的内部显示样式（例如： color、background、text-shadow 等）生效</li>
</ol>
<h4 id="gecko-内核渲染流程"><a href="#gecko-内核渲染流程" class="headerlink" title="gecko 内核渲染流程"></a>gecko 内核渲染流程</h4><p>先解析 HTM，生成内容 Sink （Content Sink 可以认为是构建 DOM 结构树的工厂方法），再开始解析 CSS</p>
<p><img src="/images/brower/gecko.svg" alt="gecko内核渲染流程"></p>
<h4 id="webkit-内核渲染流程"><a href="#webkit-内核渲染流程" class="headerlink" title="webkit 内核渲染流程"></a>webkit 内核渲染流程</h4><p>HTML 和 CSS 的解析是并行的</p>
<p><img src="/images/brower/webkit.svg" alt="webkit内核渲染流程"></p>
<h3 id="持久化技术"><a href="#持久化技术" class="headerlink" title="持久化技术"></a>持久化技术</h3><ul>
<li><a href="/2020/08/31/浏览器缓存/">HTTP 文件缓存</a></li>
<li><code>localStorage</code></li>
<li><code>sessionStorage</code></li>
<li><code>cookie</code></li>
<li><code>webSQL</code></li>
<li><code>Application cache</code></li>
<li><code>cacheStorage</code></li>
<li><code>flash</code> 缓存</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/03/02/浏览器基础/" data-id="ckqza38k7004iyys6msxnnho9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-简单代码热更新" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/28/简单代码热更新/" class="article-date">
  <time datetime="2021-02-28T15:19:45.000Z" itemprop="datePublished">2021-02-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/28/简单代码热更新/">简单代码热更新</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><ol>
<li>开发静态页面修改样式时需要手动刷新页面才会在页面上看到效果比较麻烦</li>
<li>了解了热更新原理需要实践下</li>
<li>手动实现了<a href="/2021/01/06/nodejs中实现websocket服务/">对 <code>websocket</code> 的解析</a>，趁热打铁把 <code>websocket</code> 应用在实际项目中</li>
</ol>
<h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><ol>
<li>服务端监听文件改动</li>
<li>当文件有改动之后服务端发送事件通知客户端</li>
<li>客户端接收到事件之后做出对应的处理</li>
</ol>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="服务端监听文件改动"><a href="#服务端监听文件改动" class="headerlink" title="服务端监听文件改动"></a>服务端监听文件改动</h4><p>nodejs 在 <code>fs</code> 模块中提供了两个监听文件改动的方法 <code>fs.watch</code> 和 <code>fs.watchFile</code> 两个方法。</p>
<h5 id="fs-watch-参考"><a href="#fs-watch-参考" class="headerlink" title="fs.watch 参考"></a><a href="http://nodejs.cn/api/fs.html#fs_fs_watch_filename_options_listener" target="_blank" rel="noopener"><code>fs.watch</code> 参考</a></h5><p>监听文件及文件夹下的改动，通过如下方式调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.watch(filename[, options], listener)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>filename</code>: 文件或目录</li>
<li><code>options</code>: 可选的，如果 options 传入字符串，则它指定 encoding。 否则，options 应传入对象，属性如下：<ul>
<li><code>persistent</code>: &lt;<code>boolean</code>&gt; 指示如果文件已正被监视，进程是否应继续运行。默认值: <code>true</code></li>
<li><code>recursive</code>: &lt;<code>boolean</code>&gt; 指示应该监视所有子目录，还是仅监视当前目录。这适用于监视目录时，并且仅适用于受支持的平台（参见注意事项）。默认值: <code>false。</code></li>
<li><code>encoding</code>: &lt;<code>string</code>&gt; 指定用于传给监听器的文件名的字符编码。默认值: <code>utf8</code>。</li>
</ul>
</li>
<li><code>listener</code>: 监听器回调有两个参数 <code>(eventType, filename)</code>。 <code>eventType</code> 是 <code>rename</code> 或 <code>change</code>， <code>filename</code> 是触发事件的文件的名称。</li>
</ul>
<h5 id="fs-watchFile-参考"><a href="#fs-watchFile-参考" class="headerlink" title="fs.watchFile 参考"></a><a href="http://nodejs.cn/api/fs.html#fs_fs_watchfile_filename_options_listener" target="_blank" rel="noopener"><code>fs.watchFile</code> 参考</a></h5><p>监听特定文件的改动，通过如下方式调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fs.watchFile(filename[, options], listener)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>filename</code>: 文件</li>
<li><code>options</code>: 可选的，options 应传入对象，属性如下：<ul>
<li><code>persistent</code>: &lt;<code>boolean</code>&gt; 指示如果文件已正被监视，进程是否应继续运行。默认值: <code>true</code>。</li>
<li><code>interval</code>: 指示轮询目标的频率（以毫秒为单位）。</li>
<li><code>bigint</code>: 回调函数的参数对象是否为<code>BigInts</code>类型。</li>
</ul>
</li>
<li><code>listener</code>: 监听器回调有两个参数 <code>(curr, prev)</code>。 <code>curr</code> 是文件修改后的 <code>fs.Stat</code> 实例， <code>prev</code> 是文件修改前的 <code>fs.Stat</code> 实例。</li>
</ul>
<h4 id="通知客户端"><a href="#通知客户端" class="headerlink" title="通知客户端"></a>通知客户端</h4><p>通过建立一个 <code>websocket</code> 服务的方式，当文件有变更的时候发送更新消息</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server.on(<span class="string">'upgrade'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, socket, head</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> read = <span class="keyword">new</span> WebsocketRead(req, socket)</span><br><span class="line">  <span class="keyword">const</span> write = <span class="keyword">new</span> WebsocketWrite(socket)</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'websocket connect success'</span>)</span><br><span class="line"></span><br><span class="line">  read.on(<span class="string">'text'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'接收到响应'</span>, data)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  read.on(<span class="string">'ping'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    write.pong()</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  watch.on(<span class="string">'update'</span>, (data) =&gt; &#123;</span><br><span class="line">    write.send(data)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="客户端处理事件"><a href="#客户端处理事件" class="headerlink" title="客户端处理事件"></a>客户端处理事件</h4><p>在客户端插入建立 <code>websocket</code> 链接的代码，接收到更新之后重新刷新页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">const</span> socket = <span class="keyword">new</span> WebSocket(<span class="string">`ws://\$&#123;location.host&#125;`</span>)</span></span><br><span class="line"><span class="javascript">  socket.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> data = e.data</span></span><br><span class="line">    location.reload()</span><br><span class="line">  &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><h4 id="自动注入建立-websocket-链接的代码"><a href="#自动注入建立-websocket-链接的代码" class="headerlink" title="自动注入建立 websocket 链接的代码"></a>自动注入建立 <code>websocket</code> 链接的代码</h4><p>返回 <code>HTML</code> 页面时通过正则的方式在页面中插入代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> data = fs.readFileSync(filePath)</span><br><span class="line"><span class="keyword">if</span> (path.extname(filePath) === <span class="string">'.html'</span>) &#123;</span><br><span class="line">  data = data</span><br><span class="line">    .toString()</span><br><span class="line">    .replace(<span class="regexp">/\&lt;\/\s*body&gt;/</span>, <span class="string">`<span class="subst">$&#123;websocketTemplateStr&#125;</span>&lt;/body&gt;`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="对文件修改监听的封装"><a href="#对文件修改监听的封装" class="headerlink" title="对文件修改监听的封装"></a>对文件修改监听的封装</h4><p>通过封装成对应的方式，利用事件总线的模式实现事件的派发</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; EventEmitter &#125; = <span class="built_in">require</span>(<span class="string">'events'</span>)</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; resolveRootPath &#125; = <span class="built_in">require</span>(<span class="string">'./utils'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watch</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(dir) &#123;</span><br><span class="line">    <span class="keyword">super</span>()</span><br><span class="line">    <span class="keyword">this</span>.watchPath = resolveRootPath(dir)</span><br><span class="line">    fs.watch(<span class="keyword">this</span>.watchPath, &#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;, <span class="keyword">this</span>.handleCallback)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleCallback = <span class="function">(<span class="params">eventType, filename</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> content = fs</span><br><span class="line">        .readFileSync(path.resolve(<span class="keyword">this</span>.watchPath, filename), &#123;</span><br><span class="line">          encoding: <span class="string">'utf-8'</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">        .toString()</span><br><span class="line">      <span class="keyword">this</span>.emit(<span class="string">'update'</span>, &#123;</span><br><span class="line">        filename,</span><br><span class="line">        content,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">this</span>.emit(<span class="string">'remove'</span>, &#123;</span><br><span class="line">        filename,</span><br><span class="line">        content: <span class="literal">null</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = Watch</span><br></pre></td></tr></table></figure>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><ol>
<li><code>fs.watch</code> 和 <code>fs.watchFile</code> 兼容性考虑，在不兼容的平台上可以通过定时检查文件的方式判断文件是否有改动</li>
<li><code>websocket</code> 兼容性考虑，不支持的平台上降级为短轮询或长轮询的方式</li>
<li>文件修改时可以在抛出的事件中提供更多的信息，事件局部文件的热更新而不用刷新整个页面</li>
</ol>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul>
<li><a href="http://nodejs.cn/api/fs.html" target="_blank" rel="noopener"><code>nodejs</code> <code>fs</code> 模块</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket/WebSocket" target="_blank" rel="noopener">浏览器<code>websocket</code></a></li>
<li><a href="/2021/01/06/nodejs中实现websocket服务/">nodejs 中实现 websocket 服务</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/02/28/简单代码热更新/" data-id="ckqza38kc004qyys6802wa4uf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-粘贴图片" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/24/粘贴图片/" class="article-date">
  <time datetime="2021-01-23T22:16:19.000Z" itemprop="datePublished">2021-01-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/24/粘贴图片/">粘贴图片</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>优化用户编辑体验，实现在编辑内容（markdown 或富文本）时通过复制的方式实现图片的插入</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ol>
<li>监听剪贴板事件中的 <code>paste</code> 事件</li>
<li>通过事件的回调对象获取粘贴内容，若为文本则执行默认操作，若为图片类型则阻止默认操作并继续处理</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cb = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> data = event.clipboardData <span class="comment">// 获取粘贴内容</span></span><br><span class="line">  <span class="keyword">let</span> fileContent</span><br><span class="line">  <span class="keyword">let</span> stopFlag = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// 遍历对象获取粘贴文件</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; data &amp;&amp; data.items &amp;&amp; i &lt; data.items.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> item = data.items[i]</span><br><span class="line">    <span class="keyword">if</span> (item.kind === <span class="string">'file'</span> &amp;&amp; item.type.match(<span class="string">'^image/'</span>)) &#123;</span><br><span class="line">      stopFlag = <span class="literal">true</span></span><br><span class="line">      fileContent = item.getAsFile()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 对 fileContent 做处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><ul>
<li><code>event</code> 是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ClipboardEvent" target="_blank" rel="noopener"><code>ClipboardEvent</code></a> 类型，可以通过 <code>clipboardData</code> 属性拿到数据内容</li>
<li><code>clipboardData</code> 是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransfer" target="_blank" rel="noopener"> DataTransfer`</a>对象，在粘贴事件中可以通过 <code>items</code> 属性获取粘贴的内容和数据类型，其是一个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItemList" target="_blank" rel="noopener"><code>DataTransferItemList</code></a> 对象，通过 <code>for</code> 循环的方式遍历每一个元素，每个元素都是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DataTransferItem" target="_blank" rel="noopener"><code>DataTransferItem</code></a>对象</li>
</ul>
<h4 id="DataTransferItem-对象"><a href="#DataTransferItem-对象" class="headerlink" title="DataTransferItem 对象"></a><code>DataTransferItem</code> 对象</h4><h5 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h5><ul>
<li><code>kind</code>： 拖拽项的种类，<code>string</code> 或是 <code>file</code></li>
<li><code>type</code>：拖拽项的类型，一般是一个 MIME 类型</li>
</ul>
<h5 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h5><ul>
<li><code>getAsFile()</code>：返回一个关联拖拽项的 File 对象 （当拖拽项不是一个文件时返回 null）</li>
<li><code>getAsString()</code>：使用拖拽项的字符串作为参数执行指定回调函数。</li>
<li><code>webkitGetAsEntry()</code>：返回一个基于 FileSystemEntry 的对象来表示文件系统中选中的项目。通常是返回一个 FileSystemFileEntry 或是 FileSystemDirectoryEntry 对象.</li>
</ul>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ol>
<li>在 <code>mac</code> 上复制一张图片文件时会产生两个记录，第一个记录是文件名，第二个对象是文件本身</li>
<li>在 <code>mac</code> 上复制一个非图片类型的文件时，也会产生两个记录，一个是文件名，另一个是文件的缩略图，但是这个文章的缩略图通过 <code>getAsFile</code> 方法无法获取到内容</li>
</ol>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/Events/paste" target="_blank" rel="noopener">paste 事件</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/01/24/粘贴图片/" data-id="ckqza38kd004syys6adwzjts6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-跨页面通信" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/17/跨页面通信/" class="article-date">
  <time datetime="2021-01-17T13:37:39.000Z" itemprop="datePublished">2021-01-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/17/跨页面通信/">跨页面通信</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在浏览器中每个页面都运行在单独的进程中，如何实现页面间的通信？</p>
<h3 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h3><h4 id="BroadCastChannel"><a href="#BroadCastChannel" class="headerlink" title="BroadCastChannel"></a>BroadCastChannel</h4><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/BroadcastChannel" target="_blank" rel="noopener">BroadcastChannel</a> 接口代理了一个命名频道，可以让指定 origin 下的任意 browsing context 来订阅它。它允许同源的不同浏览器窗口，Tab 页，frame 或者 iframe 下的不同文档之间相互通信。通过触发一个 <code>message</code> 事件，消息可以广播到所有监听了该频道的 <code>BroadcastChannel</code> 对象。</p>
<ol>
<li>构建一个实例</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bc = <span class="keyword">new</span> BroadcastChannel(<span class="string">'channel'</span>)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>调用 <code>postMessage</code> 发送消息</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bc.postMessage(data)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>分别监听 <code>onmessage</code> 和 <code>onmessageerror</code> 事件来接收数据和错误消息</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bc.onmessage = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// e.data是发送过来的数据，可以根据数据做一些事情</span></span><br><span class="line">&#125;</span><br><span class="line">bc.onmessageerror = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 错误消息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>调用 <code>close</code> 关闭通道，并销毁 <code>BroadcastChannel</code> 对象</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bc.close()</span><br></pre></td></tr></table></figure>
<h4 id="localStorage-实现"><a href="#localStorage-实现" class="headerlink" title="localStorage 实现"></a>localStorage 实现</h4><p>当前页面使用的 <code>storage</code> 被其他页面修改时会触发 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/StorageEvent" target="_blank" rel="noopener"><code>StorageEvent</code></a> 事件</p>
<ol>
<li>在源页面设置值触发事件</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localStorage.setItem(<span class="string">'newValue'</span>, <span class="string">'new'</span>)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在接收页面监听 <code>storage</code> 事件以实现通信</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">'storage'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// e.newValue表示新设置的值</span></span><br><span class="line">  <span class="comment">// e.key表示新设置的值的键</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="其它方案"><a href="#其它方案" class="headerlink" title="其它方案"></a>其它方案</h4><ol>
<li><code>Service Worker</code>: 一个可以长期运行在后台的 Worker，能够实现与页面的双向通信。</li>
<li><code>Shared Worker</code>: Worker 家族的另一个成员。普通的 Worker 之间是独立运行、数据互不相通；而多个 Tab 注册的 Shared Worker 则可以实现数据共享。</li>
<li><code>IndexedDB</code>: 数据存储技术</li>
<li><code>window.open + window.opener</code>: 当我们使用 window.open 打开页面时，方法会返回一个被打开页面 window 的引用。而在未显示指定 no opener 时，被打开的页面可以通过 window.opener 获取到打开它的页面的引用 —— 通过这种方式我们就将这些页面建立起了联系（一种树形结构）。</li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/visibilitychange_event" target="_blank" rel="noopener"><code>visibilitychange</code></a>: 当其选项卡的内容变得可见或被隐藏时，会在文档上触发 visibilitychange (能见度更改)事件。</li>
</ol>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://github.com/kd-cloud-web/Blog/issues/41" target="_blank" rel="noopener">几种跨页面通信的方案</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/81237384" target="_blank" rel="noopener">跨页面的通信解决方案</a></li>
<li><a href="https://juejin.cn/post/6844903495636615176" target="_blank" rel="noopener">跨页面通信的各种姿势</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/01/17/跨页面通信/" data-id="ckqza38kj0054yys6rni9dqiu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-nodejs中实现websocket服务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/06/nodejs中实现websocket服务/" class="article-date">
  <time datetime="2021-01-05T22:57:14.000Z" itemprop="datePublished">2021-01-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/06/nodejs中实现websocket服务/">nodejs中实现websocket服务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="建立链接"><a href="#建立链接" class="headerlink" title="建立链接"></a>建立链接</h3><p>若要实现 WebSocket 协议，首先需要浏览器主动发起一个 HTTP 请求。</p>
<p>这个请求头包含“Upgrade”字段，内容为“websocket”（注：upgrade 字段用于改变 HTTP 协议版本或换用其他协议，这里显然是换用了 websocket 协议），还有一个最重要的字段“Sec-WebSocket-Key”，这是一个随机的经过 base64 编码的字符串，像密钥一样用于服务器和客户端的握手过程。一旦服务器君接收到来自客户端的 upgrade 请求，便会将请求头中的“Sec-WebSocket-Key”字段提取出来，追加一个固定的“魔串”：<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>，并进行 SHA-1 加密，然后再次经过 base64 编码生成一个新的 key，作为响应头中的“Sec-WebSocket-Accept”字段的内容返回给浏览器。一旦浏览器接收到来自服务器的响应，便会解析响应中的“Sec-WebSocket-Accept”字段，与自己加密编码后的串进行匹配，一旦匹配成功，便有建立连接的可能了（因为还依赖许多其他因素）。</p>
<p>这是一个基本的 Client 请求头：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Upgrade:</span> <span class="string">websocket</span></span><br><span class="line"><span class="attr">Connection:</span> <span class="string">Upgrade</span></span><br><span class="line"><span class="attr">Sec-WebSocket-Key:</span> <span class="string">************==</span></span><br><span class="line"><span class="attr">Sec-WebSocket-Version:</span> <span class="string">**</span></span><br></pre></td></tr></table></figure>
<p>Server 正确接收后，会返回一个响应头：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Upgrade：websocket</span></span><br><span class="line"><span class="attr">Connnection:</span> <span class="string">Upgrade</span></span><br><span class="line"><span class="attr">Sec-WebSocket-Accept:</span> <span class="string">******************</span></span><br></pre></td></tr></table></figure>
<p>这表示双方握手成功了，之后就是全双工的通信。</p>
<h4 id="js-代码实现"><a href="#js-代码实现" class="headerlink" title="js 代码实现"></a>js 代码实现</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构建响应头</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildHeaders</span>(<span class="params">secWebsocketKey</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 计算返回的key</span></span><br><span class="line">  <span class="keyword">const</span> resKey = crypto</span><br><span class="line">    .createHash(<span class="string">'sha1'</span>)</span><br><span class="line">    .update(secWebsocketKey + <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span>)</span><br><span class="line">    .digest(<span class="string">'base64'</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造响应头</span></span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">'HTTP/1.1 101 Switching Protocols'</span>,</span><br><span class="line">    <span class="string">'Upgrade: websocket'</span>,</span><br><span class="line">    <span class="string">'Connection: Upgrade'</span>,</span><br><span class="line">    <span class="string">'Sec-WebSocket-Accept: '</span> + resKey,</span><br><span class="line">  ]</span><br><span class="line">    .concat(<span class="string">''</span>, <span class="string">''</span>)</span><br><span class="line">    .join(<span class="string">'\r\n'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解析数据"><a href="#解析数据" class="headerlink" title="解析数据"></a>解析数据</h3><h4 id="Frame（帧）"><a href="#Frame（帧）" class="headerlink" title="Frame（帧）"></a>Frame（帧）</h4><p>WebSocket 传输的数据都是以 Frame（帧）的形式实现的，就像 TCP/UDP 协议中的报文段 Segment。下面就是一个 Frame：（以 bit 为单位表示）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment">  1               2               3               4</span></span><br><span class="line"><span class="comment">  0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7 0 1 2 3 4 5 6 7</span></span><br><span class="line"><span class="comment"> +-+-+-+-+-------+-+-------------+-------------------------------+</span></span><br><span class="line"><span class="comment"> |F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span></span><br><span class="line"><span class="comment"> |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span></span><br><span class="line"><span class="comment"> |N|V|V|V|       |S|             |   (if payload len==126/127)   |</span></span><br><span class="line"><span class="comment"> | |1|2|3|       |K|             |                               |</span></span><br><span class="line"><span class="comment"> +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span></span><br><span class="line"><span class="comment"> |     Extended payload length continued, if payload len == 127  |</span></span><br><span class="line"><span class="comment"> + - - - - - - - - - - - - - - - +-------------------------------+</span></span><br><span class="line"><span class="comment"> |                               |Masking-key, if MASK set to 1  |</span></span><br><span class="line"><span class="comment"> +-------------------------------+-------------------------------+</span></span><br><span class="line"><span class="comment"> | Masking-key (continued)       |          Payload Data         |</span></span><br><span class="line"><span class="comment"> +-------------------------------- - - - - - - - - - - - - - - - +</span></span><br><span class="line"><span class="comment"> :                     Payload Data continued ...                :</span></span><br><span class="line"><span class="comment"> + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span></span><br><span class="line"><span class="comment"> |                     Payload Data continued ...                |</span></span><br><span class="line"><span class="comment"> +---------------------------------------------------------------+</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h5 id="按照-RFC-中的描述："><a href="#按照-RFC-中的描述：" class="headerlink" title="按照 RFC 中的描述："></a>按照 RFC 中的描述：</h5><ul>
<li>FIN： 1 bit， 0 表示还有后续帧，1 表示最后一帧</li>
<li>RSV1、2、3： 没个 1 bit，除非一个扩展经过协商赋予了非零值以某种含义，否则必须为 0，如果没有定义非零值，并且收到了非零的 RSV，则 websocket 链接会失败</li>
<li>Opcode： 4 bit，如果收到了未知的 opcode，最后会断开链接, 这四位的值组合结果的含义分别如下：</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">0x0 :</span> <span class="string">代表连续的帧</span></span><br><span class="line"><span class="attr">0x1 :</span> <span class="string">text帧</span></span><br><span class="line"><span class="number">0x2</span> <span class="string">：</span> <span class="string">binary帧</span></span><br><span class="line"><span class="number">0x3</span><span class="number">-0x7</span> <span class="string">：</span> <span class="string">为非控制帧而预留的</span></span><br><span class="line"><span class="number">0x8</span> <span class="string">：</span> <span class="string">关闭握手帧</span></span><br><span class="line"><span class="number">0x9</span> <span class="string">：</span> <span class="string">ping帧</span></span><br><span class="line"><span class="attr">0xA :</span> <span class="string">pong</span> <span class="string">帧</span></span><br><span class="line"><span class="number">0xB</span><span class="number">-0xF</span> <span class="string">：</span> <span class="string">为非控制帧而预留的</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Mask： 1 bit，0 表示数据没有添加掩码，1 表示数据被添加了掩码，如果置 1， “Masking-key”就会被赋值，所有从客户端发往服务器的帧都会被置 1</li>
<li>Payload length： 7 bit | 7+16 bit | 7+64 bit，“payload data” 的长度如果在 0~125 bytes 范围内，它就是“payload length”，如果是 126 bytes， 紧随其后的被表示为 16 bits 的 2 bytes 无符号整型就是“payload length”，如果是 127 bytes， 紧随其后的被表示为 64 bits 的 8 bytes 无符号整型就是“payload length”</li>
<li>Masking-key： 0 or 4 bytes，所有从客户端发送到服务器的帧都包含一个 32 bits 的掩码（如果“mask bit”被设置成 1），否则为 0 bit。一旦掩码被设置，所有接收到的 payload data 都必须与该值以一种算法做异或运算来获取真实值。</li>
<li>Payload data: n bytes，数据内容</li>
</ul>
<h4 id="读取数据帧"><a href="#读取数据帧" class="headerlink" title="读取数据帧"></a>读取数据帧</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomReadSocket</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> MAGIC_STRING = <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(req, socket, head) &#123;</span><br><span class="line">    <span class="keyword">super</span>()</span><br><span class="line">    <span class="comment">// 保存上下文信息</span></span><br><span class="line">    <span class="keyword">this</span>.req = req</span><br><span class="line">    <span class="keyword">this</span>.socket = socket</span><br><span class="line">    <span class="keyword">this</span>.head = head</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内部状态</span></span><br><span class="line">    <span class="keyword">this</span>.dataType = <span class="string">''</span></span><br><span class="line">    <span class="keyword">this</span>.resHeaders = <span class="keyword">this</span>.buildHeaders(req.headers[<span class="string">'sec-websocket-key'</span>])</span><br><span class="line">    <span class="keyword">this</span>.buffer = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接收数据</span></span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">'data'</span>, <span class="keyword">this</span>.handleData)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应给客户端</span></span><br><span class="line">    <span class="keyword">this</span>.socket.write(<span class="keyword">this</span>.resHeaders)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建响应头</span></span><br><span class="line">  buildHeaders(secWebsocketKey) &#123;</span><br><span class="line">    <span class="comment">// 计算返回的key</span></span><br><span class="line">    <span class="keyword">const</span> resKey = crypto</span><br><span class="line">      .createHash(<span class="string">'sha1'</span>)</span><br><span class="line">      .update(secWebsocketKey + CustomReadSocket.MAGIC_STRING)</span><br><span class="line">      .digest(<span class="string">'base64'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造响应头</span></span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      <span class="string">'HTTP/1.1 101 Switching Protocols'</span>,</span><br><span class="line">      <span class="string">'Upgrade: websocket'</span>,</span><br><span class="line">      <span class="string">'Connection: Upgrade'</span>,</span><br><span class="line">      <span class="string">'Sec-WebSocket-Accept: '</span> + resKey,</span><br><span class="line">    ]</span><br><span class="line">      .concat(<span class="string">''</span>, <span class="string">''</span>)</span><br><span class="line">      .join(<span class="string">'\r\n'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理收到的数据</span></span><br><span class="line">  handleData = <span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> type = <span class="keyword">this</span>.getFrameType(data[<span class="number">0</span>])</span><br><span class="line">      <span class="keyword">if</span> (type &amp;&amp; type !== <span class="string">'continue'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.dataType = type</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (type === <span class="string">'continue'</span> || type === <span class="string">'text'</span> || type === <span class="string">'binary'</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> maskLen = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.hasMask(data[<span class="number">1</span>])) &#123;</span><br><span class="line">          maskLen = <span class="number">4</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> [start, len] = <span class="keyword">this</span>.getFrameDataLength(data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.getDataFromFrame(</span><br><span class="line">          data.slice(start + maskLen),</span><br><span class="line">          data.slice(start, start + maskLen),</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (!<span class="keyword">this</span>.isLastFrame(data[<span class="number">0</span>]))</span><br><span class="line">    <span class="keyword">this</span>.handleAllType(<span class="keyword">this</span>.dataType)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取当前帧类型</span></span><br><span class="line">  getFrameType(byte) &#123;</span><br><span class="line">    <span class="keyword">const</span> realType = byte &amp; <span class="number">0x7f</span></span><br><span class="line">    <span class="keyword">if</span> (!realType) &#123;</span><br><span class="line">      <span class="comment">// 代表连续的帧</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">'continue'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x01</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'text'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x09</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'ping'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x0a</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'pong'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x02</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'binary'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (realType === <span class="number">0x08</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'close'</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理所有帧类型</span></span><br><span class="line">  handleAllType(type) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'continue'</span>: &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'continue'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'text'</span>: &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'message'</span>, <span class="keyword">this</span>.buffer.toString())</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'binary'</span>: &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'message'</span>, <span class="keyword">this</span>.buffer)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'close'</span>: &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'close'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'ping'</span>: &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'ping'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'pong'</span>: &#123;</span><br><span class="line">        <span class="keyword">this</span>.emit(<span class="string">'pong'</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'others'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 释放 buffer 和重置数据类型</span></span><br><span class="line">    <span class="keyword">this</span>.buffer = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.dataType = <span class="string">''</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否是最后一个帧</span></span><br><span class="line">  isLastFrame(byte) &#123;</span><br><span class="line">    <span class="keyword">return</span> !!(byte &amp; <span class="number">0x80</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 提取帧的长度</span></span><br><span class="line">  getFrameDataLength(buffer) &#123;</span><br><span class="line">    <span class="comment">// 第二个字节的底 7 位</span></span><br><span class="line">    <span class="keyword">const</span> firtLen = buffer[<span class="number">1</span>] &amp; <span class="number">0x7f</span></span><br><span class="line">    <span class="keyword">if</span> (firtLen &lt; <span class="number">125</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [<span class="number">2</span>, firtLen]</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firtLen === <span class="number">126</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> len = buffer.readUInt16BE(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">return</span> [<span class="number">4</span>, len]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> len = buffer.readUInt64BE(<span class="number">2</span>)</span><br><span class="line">      <span class="keyword">return</span> [<span class="number">10</span>, len]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断是否有掩码</span></span><br><span class="line">  hasMask(byte) &#123;</span><br><span class="line">    <span class="keyword">return</span> !!(<span class="number">0x80</span> &amp; byte)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从帧里提取数据</span></span><br><span class="line">  getDataFromFrame(buffer, maskBuffer) &#123;</span><br><span class="line">    <span class="keyword">if</span> (buffer &amp;&amp; buffer.length) &#123;</span><br><span class="line">      <span class="keyword">const</span> len = buffer.length</span><br><span class="line">      <span class="keyword">if</span> (maskBuffer &amp;&amp; maskBuffer.length === <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">          buffer[i] = buffer[i] ^ maskBuffer[i % <span class="number">4</span>]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.buffer = <span class="keyword">this</span>.buffer ? Buffer.concat([<span class="keyword">this</span>.buffer, buffer]) : buffer</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="写入数据帧"><a href="#写入数据帧" class="headerlink" title="写入数据帧"></a>写入数据帧</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomWebsocket</span> <span class="keyword">extends</span> <span class="title">CustomReadSocket</span> </span>&#123;</span><br><span class="line">  timer = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">constructor</span>(req, socket, head, options) &#123;</span><br><span class="line">    <span class="keyword">super</span>(req, socket, head)</span><br><span class="line">    <span class="keyword">this</span>.options = options</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.timeout()</span><br><span class="line">    <span class="keyword">this</span>.socket.on(<span class="string">'data'</span>, () =&gt; &#123;</span><br><span class="line">      <span class="keyword">this</span>.timeout()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  send(message) &#123;</span><br><span class="line">    <span class="keyword">const</span> buffer = Buffer.from(message)</span><br><span class="line">    <span class="keyword">const</span> list = <span class="keyword">this</span>.buildDataFrameList(<span class="string">'text'</span>, buffer)</span><br><span class="line">    list.forEach(<span class="function">(<span class="params">frame</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.socket.write(frame)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">this</span>.timeout()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ping() &#123;</span><br><span class="line">    <span class="keyword">const</span> frame = <span class="keyword">this</span>.buildFrame(<span class="string">'ping'</span>)</span><br><span class="line">    <span class="keyword">this</span>.socket.write(frame)</span><br><span class="line">    <span class="keyword">this</span>.timeout()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pong() &#123;</span><br><span class="line">    <span class="keyword">const</span> frame = <span class="keyword">this</span>.buildFrame(<span class="string">'pong'</span>)</span><br><span class="line">    <span class="keyword">this</span>.socket.write(frame)</span><br><span class="line">    <span class="keyword">this</span>.timeout()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  close() &#123;</span><br><span class="line">    <span class="keyword">const</span> frame = <span class="keyword">this</span>.buildFrame(<span class="string">'close'</span>)</span><br><span class="line">    <span class="keyword">this</span>.socket.write(frame)</span><br><span class="line">    <span class="keyword">this</span>.socket.end()</span><br><span class="line">    process.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.socket.destroy()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  timeout() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; timeout = <span class="number">10000</span> &#125; = <span class="keyword">this</span>.options || &#123;&#125;</span><br><span class="line">    clearTimeout(<span class="keyword">this</span>.timer)</span><br><span class="line">    <span class="keyword">this</span>.timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.ping()</span><br><span class="line">    &#125;, timeout)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  buildDataFrameList(type, buffer) &#123;</span><br><span class="line">    <span class="keyword">const</span> bufferList = []</span><br><span class="line">    <span class="keyword">let</span> tempBuffer = buffer</span><br><span class="line">    <span class="keyword">while</span> (tempBuffer.length) &#123;</span><br><span class="line">      bufferList.push(tempBuffer.slice(<span class="number">0</span>, <span class="keyword">this</span>.MAX_FRAME_SIZE))</span><br><span class="line">      tempBuffer = tempBuffer.slice(<span class="keyword">this</span>.MAX_FRAME_SIZE)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> len = bufferList.length</span><br><span class="line">    <span class="keyword">return</span> bufferList.map(<span class="function">(<span class="params">buf, index</span>) =&gt;</span></span><br><span class="line">      <span class="keyword">this</span>.buildFrame(index ? <span class="string">'continue'</span> : type, len === index + <span class="number">1</span>, buf),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  buildFrame(dataType, isLast = <span class="literal">true</span>, buffer = <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> firstByte = isLast ? <span class="number">0x80</span> : <span class="number">0x00</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="string">`<span class="subst">$&#123;dataType || <span class="string">''</span>&#125;</span>`</span>.toLowerCase()) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'continue'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x00</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'text'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x01</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'binary'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x02</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'close'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x08</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'ping'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x09</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'pong'</span>: &#123;</span><br><span class="line">        firstByte = firstByte | <span class="number">0x0a</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>: &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'others'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> secondByte = <span class="number">0x00</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buffer &amp;&amp; buffer.length) &#123;</span><br><span class="line">      <span class="keyword">const</span> lenByteList = []</span><br><span class="line">      <span class="keyword">const</span> len = buffer.length</span><br><span class="line">      <span class="keyword">if</span> (len &lt;= <span class="number">125</span>) &#123;</span><br><span class="line">        secondByte = secondByte | len</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (len &gt;= <span class="number">126</span> &amp;&amp; len &lt; <span class="number">65536</span>) &#123;</span><br><span class="line">        secondByte = secondByte | <span class="number">0x7e</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">          lenByteList.push(<span class="number">0xff</span> &amp; (len &gt;&gt; (i * <span class="number">8</span>)))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        secondByte = secondByte | <span class="number">0x7f</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">          lenByteList.push(<span class="number">0xff</span> &amp; (len &gt;&gt; (i * <span class="number">8</span>)))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      lenByteList.reverse()</span><br><span class="line">      <span class="keyword">const</span> prefixBuffer = Buffer.from([firstByte, secondByte, ...lenByteList])</span><br><span class="line">      <span class="keyword">return</span> Buffer.concat([prefixBuffer, buffer])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Buffer.from([firstByte, secondByte])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://github.com/abbshr/abbshr.github.io/issues/22" target="_blank" rel="noopener">学习 WebSocket 协议—从顶层到底层的实现原理（修订版）
</a></li>
<li><a href="https://segmentfault.com/a/1190000016467409" target="_blank" rel="noopener">Node.js - 200 多行代码实现 Websocket 协议</a></li>
<li><a href="https://segmentfault.com/a/1190000012709475" target="_blank" rel="noopener">WebSocket：5 分钟从入门到精通</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSockets_API/Writing_WebSocket_servers" target="_blank" rel="noopener">编写 WebSocket 服务器</a></li>
<li><a href="https://github.com/JackXuyi/web-exercise/blob/master/handwriting/socketServer.js" target="_blank" rel="noopener">本文涉及到的页面源代码</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2021/01/06/nodejs中实现websocket服务/" data-id="ckqza38iu0027yys6v6b18s72" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/network/">计算机网络</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-记一次项目打包优化" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/12/23/记一次项目打包优化/" class="article-date">
  <time datetime="2020-12-22T19:19:21.000Z" itemprop="datePublished">2020-12-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/12/23/记一次项目打包优化/">记一次项目打包优化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>由于项目功能越来复杂，打包发布的速度越来越慢，严重影响了开发速度，所以决定优化下打包发布速度</p>
<h2 id="分析打包流程及耗时"><a href="#分析打包流程及耗时" class="headerlink" title="分析打包流程及耗时"></a>分析打包流程及耗时</h2><h3 id="打包流程"><a href="#打包流程" class="headerlink" title="打包流程"></a>打包流程</h3><ul>
<li>代码 clone 到打包服务器上</li>
<li>编译代码，项目采用 nextjs 进行服务端渲染，所以编译编译时分为两个部分，分别为构建服务端 js 和客户端 js，每次编译都要先安装项目依赖，再执行打包构建命令</li>
<li>构建 docker 容器，项目运行在 docker 容器中，每次打包发布都是构建一个新的容器去替换对应环境的容器</li>
<li>部署静态资源，把客户端对应的 js 推送到 CDN 上</li>
<li>替换容器，用之前构建的容器去替换当前环境的容器</li>
</ul>
<h3 id="耗时分析"><a href="#耗时分析" class="headerlink" title="耗时分析"></a>耗时分析</h3><ul>
<li>clone 代码速度由网络和项目大小决定（网络无法控制，源代码不大，优化效果不明显）—— 通常在 10 秒左右</li>
<li>采用 webpack 进行编译，可以通过插件进行构建优化 —— 通常在 2.5 分钟左右</li>
<li>构建 docker 容器时会把 node_modules 下的依赖按照生产模式的方式放入容器中 —— 通常在 4.5 分钟左右</li>
<li>静态资源的上传由上传资源大小及网络决定，上传由基础组控制 —— 2 分钟左右</li>
<li>替换容器由集群控制，业务方无法控制 —— 通常在 1 分左右</li>
</ul>
<h2 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h2><p>通过上面的分析发现，制作 docker 容器和 打包过程最耗费时间，且这两块也在业务方控制之中，所以优化从这两方面着手</p>
<h3 id="docker-容器优化"><a href="#docker-容器优化" class="headerlink" title="docker 容器优化"></a>docker 容器优化</h3><p>通过查看打包日志发现制作 docker 容器时发现制作容器时发送的上下文达 1G 多，对比其它项目明显偏大</p>
<h4 id="优化方向分析"><a href="#优化方向分析" class="headerlink" title="优化方向分析"></a>优化方向分析</h4><ul>
<li>发送的上下文是在生产模式下安装的依赖，即只会安装 <code>dependencies</code> 下的依赖 —— 考虑把所有非服务端必须的依赖安装到 <code>devDependencies</code> 中以减小上下文大小</li>
<li>由于需要 SEO 优化，优化不能减少服务端渲染时的页面内容 —— 只能优化对页面内容没有影响但是需要客户端交互及样式操作相关的库</li>
</ul>
<h4 id="优化操作"><a href="#优化操作" class="headerlink" title="优化操作"></a>优化操作</h4><ul>
<li>通过 webpack 插件提取项目中使用的依赖，结合 package.json 的配置，筛选出项目中无用的依赖</li>
<li>筛选出 <code>dependencies</code> 中的依赖是否可以只在客户端渲染时引入，例如 <code>react-copy-to-clipboard</code> 只会在客户端执行复制操作就可以放入 <code>devDependencies</code> 中以便只在客户端引入</li>
</ul>
<h4 id="优化效果"><a href="#优化效果" class="headerlink" title="优化效果"></a>优化效果</h4><p>构建 docker 容器的时间从优化前的 4.5 分钟左右下降到 2.5 分钟左右，优化了 50%</p>
<h3 id="webpack-打包优化"><a href="#webpack-打包优化" class="headerlink" title="webpack 打包优化"></a>webpack 打包优化</h3><p>此项目是基于 webpack 4.x 进行打包的，可以通过插件和 webpack 配置及 loader 的形式进行打包优化</p>
<h4 id="webpack-4-使用-v8-引擎带来的优化"><a href="#webpack-4-使用-v8-引擎带来的优化" class="headerlink" title="webpack 4 使用 v8 引擎带来的优化"></a>webpack 4 使用 v8 引擎带来的优化</h4><ul>
<li>for of 替代 forEach</li>
<li>Map 和 Set 替代 Object</li>
<li>includes 替代 indexOf()</li>
<li>默认使用更快的 md4 hash 算法 替代 md5 算法，md4 较 md5 速度更快</li>
<li>webpack AST 可以直接从 loader 传递给 AST，从而减少解析时间</li>
<li>使用字符串方法替代正则表达式</li>
</ul>
<h4 id="优化方向分析-1"><a href="#优化方向分析-1" class="headerlink" title="优化方向分析"></a>优化方向分析</h4><p>通过 <a href="https://www.npmjs.com/package/speed-measure-webpack-plugin" target="_blank" rel="noopener">speed-measure-webpack-plugin</a> 插件进行打包耗时分析</p>
<ul>
<li>通过配置 <code>exclude / include</code> 和忽略第三方包指定目录及通过 externals 缩小打包文件范围</li>
<li>多进程并行打包和代码压缩</li>
<li>缓存编译结果</li>
<li>babel 配置的优化</li>
</ul>
<h4 id="优化操作-1"><a href="#优化操作-1" class="headerlink" title="优化操作"></a>优化操作</h4><p>通过研究框架 webpack 配置发现项目已经引入 <code>cache-loader</code>、<code>thread-loader</code> 等 <code>loader</code> 和插件及配置优化代码打包速度，所以未做 <code>webpack</code> 打包优化</p>
<ul>
<li>引入 <code>speed-measure-webpack-plugin</code> 查看打包耗时</li>
</ul>
<h3 id="相关知识点"><a href="#相关知识点" class="headerlink" title="相关知识点"></a>相关知识点</h3><ul>
<li><a href="https://www.webpackjs.com/concepts/" target="_blank" rel="noopener">webpack</a></li>
<li><a href="https://yeasy.gitbook.io/docker_practice/" target="_blank" rel="noopener">docker</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/12/23/记一次项目打包优化/" data-id="ckqza38ke004uyys6uabbcm9k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/node/">node</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/other/">other</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ts之type、interface和class区别" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/12/14/ts之type、interface和class区别/" class="article-date">
  <time datetime="2020-12-13T22:04:08.000Z" itemprop="datePublished">2020-12-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/12/14/ts之type、interface和class区别/">ts之type、interface和class区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p><a href="https://www.typescriptlang.org/docs/handbook/2/everyday-types.html#type-aliases" target="_blank" rel="noopener">任意类型的别名</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">We’ve been using object types and union types by writing them directly in type annotations. This is convenient, but it’s common to want to use the same type more than once and refer to it by a single name.</span><br><span class="line">A type alias is exactly that - a name for any type.</span><br></pre></td></tr></table></figure>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> test = <span class="built_in">number</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// error: 标识符“test”重复。</span></span><br><span class="line"><span class="comment">// type test = string</span></span><br></pre></td></tr></table></figure>
<h4 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h4><ul>
<li>任意类型的别名（包含基本类型）</li>
<li>只可以定义一次（多次定义报 ’标识符“test”重复‘ 错误）</li>
</ul>
<h3 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h3><p><a href="https://www.typescriptlang.org/docs/handbook/interfaces.html" target="_blank" rel="noopener">接口的作用就是为这些类型命名和为你的代码或第三方代码定义契约。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">One of TypeScript’s core principles is that type checking focuses on the shape that values have. This is sometimes called “duck typing” or “structural subtyping”. In TypeScript, interfaces fill the role of naming these types, and are a powerful way of defining contracts within your code as well as contracts with code outside of your project.</span><br></pre></td></tr></table></figure>
<h4 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> Shape &#123;</span><br><span class="line">  color: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Shape &#123;</span><br><span class="line">  size?: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> PenStroke &#123;</span><br><span class="line">  penWidth: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> Square <span class="keyword">extends</span> Shape, PenStroke &#123;</span><br><span class="line">  sideLength: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> square = &lt;Square&gt;&#123;&#125;</span><br><span class="line">square.color = <span class="string">'blue'</span></span><br><span class="line">square.sideLength = <span class="number">10</span></span><br><span class="line">square.penWidth = <span class="number">5.0</span></span><br><span class="line">square.size = <span class="number">100</span></span><br></pre></td></tr></table></figure>
<h3 id="class"><a href="#class" class="headerlink" title="class"></a>class</h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Classes" target="_blank" rel="noopener">类是“特殊的函数”，就像你能够定义的函数表达式和函数声明一样，类语法有两个组成部分：类表达式和类声明。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeScript offers full support for the class keyword introduced in ES2015. As with other JavaScript language features, TypeScript adds type annotations and other syntax to allow you to express relationships between classes and other types.</span><br></pre></td></tr></table></figure>
<h4 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> passcode = <span class="string">'secret passcode'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> Employee &#123;</span><br><span class="line">  <span class="keyword">private</span> _fullName: <span class="built_in">string</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span> fullName(): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>._fullName</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> fullName(newName: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (passcode &amp;&amp; passcode == <span class="string">'secret passcode'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>._fullName = newName</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'Error: Unauthorized update of employee!'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> employee = <span class="keyword">new</span> Employee()</span><br><span class="line">employee.fullName = <span class="string">'Bob Smith'</span></span><br><span class="line"><span class="keyword">if</span> (employee.fullName) &#123;</span><br><span class="line">  alert(employee.fullName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="abstract-class"><a href="#abstract-class" class="headerlink" title="abstract class"></a>abstract class</h3><p><a href="https://www.tslang.cn/docs/handbook/classes.html" target="_blank" rel="noopener">抽象类做为其它派生类的基类使用。 它们一般不会直接被实例化。 不同于接口，抽象类可以包含成员的实现细节。 abstract 关键字是用于定义抽象类和在抽象类内部定义抽象方法。</a></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> Department &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">public</span> name: <span class="built_in">string</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  printName(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Department name: '</span> + <span class="keyword">this</span>.name)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">abstract</span> printMeeting(): <span class="built_in">void</span> <span class="comment">// 必须在派生类中实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> AccountingDepartment <span class="keyword">extends</span> Department &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">'Accounting and Auditing'</span>) <span class="comment">// 在派生类的构造函数中必须调用 super()</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printMeeting(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'The Accounting Department meets each Monday at 10am.'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  generateReports(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Generating accounting reports...'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> department: Department <span class="comment">// 允许创建一个对抽象类型的引用</span></span><br><span class="line">department = <span class="keyword">new</span> Department() <span class="comment">// 错误: 不能创建一个抽象类的实例</span></span><br><span class="line">department = <span class="keyword">new</span> AccountingDepartment() <span class="comment">// 允许对一个抽象子类进行实例化和赋值</span></span><br><span class="line">department.printName()</span><br><span class="line">department.printMeeting()</span><br><span class="line">department.generateReports() <span class="comment">// 错误: 方法在声明的抽象类中不存在</span></span><br></pre></td></tr></table></figure>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><ul>
<li>接口创建了一个新的名字，可以在其它任何地方使用。 类型别名并不创建新名字—比如，错误信息就不会使用别名。</li>
<li>类型别名不能被 extends 和 implements（自己也不能 extends 和 implements 其它类型）。</li>
<li>接口只能用来声明对象，而不能重新命名基本数据类型。</li>
<li>接口名称将始终以原始形式出现在错误消息中，当按名称使用时才显示。</li>
<li>接口可以进行声明合并</li>
<li>抽象类和接口一样不可以被实例化，但是抽象类可以包含部分属性方法的实现</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/12/14/ts之type、interface和class区别/" data-id="ckqza38jt003vyys6qjisj5n5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TypeScript/">TypeScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-for-in和for-of的区别" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/11/22/for-in和for-of的区别/" class="article-date">
  <time datetime="2020-11-21T17:09:16.000Z" itemprop="datePublished">2020-11-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/11/22/for-in和for-of的区别/">for...in和for...of的区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Iterator（遍历器）的概念"><a href="#Iterator（遍历器）的概念" class="headerlink" title="Iterator（遍历器）的概念"></a>Iterator（遍历器）的概念</h3><p>遍历器（Iterator）一种接口，为各种不同的数据结构提供统一的访问机制。任何数据结构只要部署 Iterator 接口，就可以完成遍历操作（即依次处理该数据结构的所有成员）。</p>
<h4 id="Iterator-的作用"><a href="#Iterator-的作用" class="headerlink" title="Iterator 的作用"></a>Iterator 的作用</h4><ul>
<li>为各种数据结构，提供一个统一的、简便的访问接口。</li>
<li>使得数据结构的成员能够按某种次序排列。</li>
<li>ES6 创造了一种新的遍历命令 for…of 循环，Iterator 接口主要供 for…of 消费。</li>
</ul>
<h4 id="Iterator-的遍历"><a href="#Iterator-的遍历" class="headerlink" title="Iterator 的遍历"></a>Iterator 的遍历</h4><ol>
<li>创建一个指针对象，指向当前数据结构的起始位置。也就是说，遍历器对象本质上，就是一个指针对象。</li>
<li>第一次调用指针对象的 next 方法，可以将指针指向数据结构的第一个成员。</li>
<li>第二次调用指针对象的 next 方法，指针就指向数据结构的第二个成员。</li>
<li>不断调用指针对象的 next 方法，直到它指向数据结构的结束位置。</li>
</ol>
<h4 id="Iterator-接口"><a href="#Iterator-接口" class="headerlink" title="Iterator 接口"></a>Iterator 接口</h4><p>一种数据结构只要部署了 Iterator 接口，我们就称这种数据结构是“可遍历的”（iterable）。ES6 规定，默认的 Iterator 接口部署在数据结构的 Symbol.iterator 属性，或者说，一个数据结构只要具有 Symbol.iterator 属性，就可以认为是“可遍历的”（iterable）。Symbol.iterator 属性本身是一个函数，就是当前数据结构默认的遍历器生成函数。执行这个函数，就会返回一个遍历器。</p>
<h5 id="ES6-原生具备-Iterator-接口的数据结构"><a href="#ES6-原生具备-Iterator-接口的数据结构" class="headerlink" title="ES6 原生具备 Iterator 接口的数据结构"></a>ES6 原生具备 Iterator 接口的数据结构</h5><ul>
<li>Array</li>
<li>Map</li>
<li>Set</li>
<li>String</li>
<li>TypedArray</li>
<li>函数的 arguments 对象</li>
<li>NodeList 对象</li>
</ul>
<h4 id="调用-Iterator-接口的场合"><a href="#调用-Iterator-接口的场合" class="headerlink" title="调用 Iterator 接口的场合"></a>调用 Iterator 接口的场合</h4><ul>
<li>解构赋值</li>
<li>扩展运算符</li>
<li>yield*</li>
<li>for…of</li>
<li>Array.from()</li>
<li>Map(), Set(), WeakMap(), WeakSet()</li>
<li>Promise.all()</li>
<li>Promise.race()</li>
</ul>
<h4 id="遍历器对象的-return-，throw"><a href="#遍历器对象的-return-，throw" class="headerlink" title="遍历器对象的 return()，throw()"></a>遍历器对象的 return()，throw()</h4><p>遍历器对象除了具有 next()方法，还可以具有 return()方法和 throw()方法。</p>
<ul>
<li>如果 for…of 循环提前退出（通常是因为出错，或者有 break 语句），就会调用 return()方法。</li>
<li>throw()方法主要是配合 Generator 函数使用，一般的遍历器对象用不到这个方法。</li>
</ul>
<h3 id="for…in-和-for…of-的区别"><a href="#for…in-和-for…of-的区别" class="headerlink" title="for…in 和 for…of 的区别"></a>for…in 和 for…of 的区别</h3><ul>
<li>对于普通的对象，for…in 循环可以遍历键名，for…of 循环会报错。</li>
</ul>
<h4 id="for…in-遍历数组的缺点"><a href="#for…in-遍历数组的缺点" class="headerlink" title="for…in 遍历数组的缺点"></a>for…in 遍历数组的缺点</h4><ul>
<li>数组的键名是数字，但是 for…in 循环是以字符串作为键名“0”、“1”、“2”等等。</li>
<li>for…in 循环不仅遍历数字键名，还会遍历手动添加的其他键，甚至包括原型链上的键。</li>
<li>某些情况下，for…in 循环会以任意顺序遍历键名。</li>
</ul>
<h4 id="for…of-遍历数组的优点"><a href="#for…of-遍历数组的优点" class="headerlink" title="for…of 遍历数组的优点"></a>for…of 遍历数组的优点</h4><ul>
<li>有着同 for…in 一样的简洁语法，但是没有 for…in 那些缺点</li>
<li>不同于 forEach 方法，它可以与 break、continue 和 return 配合使用。</li>
<li>提供了遍历所有数据结构的统一操作接口。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/11/22/for-in和for-of的区别/" data-id="ckqza38i1000oyys66olmdu94" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JavaScript/">JavaScript</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-异步任务按顺序分组执行" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/19/异步任务按顺序分组执行/" class="article-date">
  <time datetime="2020-10-18T16:39:31.000Z" itemprop="datePublished">2020-10-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/19/异步任务按顺序分组执行/">异步任务按顺序分组执行</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>有一个异步请求列表需要按照顺序分多次执行</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>任务可以放入一个队列中，每次从队列中获取若干任务异步执行</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>一次执行的任务放在 Promise.all 中执行，但是如果执行任务中有一个任务花费时间比较长，其它任务消耗时间短就浪费了大量时间，所以采用计数的方式判断是否可以把任务加入任务队列</p>
<h4 id="代码流程"><a href="#代码流程" class="headerlink" title="代码流程"></a>代码流程</h4><ol>
<li>构建任务队列</li>
<li>需要执行的任务放入队列</li>
<li>执行任务，判断是否有任务可以执行，若有任务可以执行，则正在执行的任务队列加一</li>
<li>任务执行完毕之后，再回到第 3 部，直至待执行任务队列和当前执行的任务为空时退出程序</li>
</ol>
<h4 id="具体-js-代码如下"><a href="#具体-js-代码如下" class="headerlink" title="具体 js 代码如下"></a>具体 js 代码如下</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(maxTask) &#123;</span><br><span class="line">    <span class="keyword">this</span>.maxTask = maxTask</span><br><span class="line">    <span class="keyword">this</span>.runningTask = <span class="number">0</span></span><br><span class="line">    <span class="keyword">this</span>.taskQueue = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  push(task) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(task)) &#123;</span><br><span class="line">      task.forEach(<span class="function">(<span class="params">t</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.taskQueue.push(t)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.taskQueue.push(task)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.run()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> runTask(task) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.runningTask++</span><br><span class="line">      <span class="keyword">await</span> task()</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(e)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.run()</span><br><span class="line">      <span class="keyword">this</span>.runningTask--</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  run() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.canRunTask()) &#123;</span><br><span class="line">      <span class="keyword">const</span> task = <span class="keyword">this</span>.taskQueue.shift()</span><br><span class="line">      <span class="keyword">this</span>.runTask(task)</span><br><span class="line">      <span class="keyword">this</span>.run()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  canRunTask() &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">this</span>.isEmpty() &amp;&amp; <span class="keyword">this</span>.runningTask &lt; <span class="keyword">this</span>.maxTask</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isEmpty() &#123;</span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">this</span>.taskQueue.length</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> taskQueue = <span class="keyword">new</span> Queue(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timeList = [<span class="number">100</span>, <span class="number">300</span>, <span class="number">500</span>, <span class="number">900</span>, <span class="number">600</span>]</span><br><span class="line"><span class="keyword">const</span> taskList = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">20</span>).fill(<span class="number">0</span>).map(<span class="function">(<span class="params">item, index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> time = index % timeList.length</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'task '</span>, index, <span class="string">'time '</span>, timeList[time], <span class="string">'start'</span>)</span><br><span class="line">      <span class="keyword">const</span> timer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        clearTimeout(timer)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'task '</span>, index, <span class="string">'time '</span>, timeList[time], <span class="string">'finished'</span>)</span><br><span class="line">        <span class="keyword">if</span> (index % <span class="number">5</span> === <span class="number">0</span>) &#123;</span><br><span class="line">          reject(<span class="string">'error'</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resolve(<span class="string">'success'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, timeList[time])</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">taskQueue.push(taskList)</span><br></pre></td></tr></table></figure>
<h3 id="附件"><a href="#附件" class="headerlink" title="附件"></a>附件</h3><ul>
<li><a href="https://github.com/JackXuyi/web-exercise/blob/master/algorithm/queue.js" target="_blank" rel="noopener">源码参考</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/10/19/异步任务按顺序分组执行/" data-id="ckqza38k3004cyys65wlug43z" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solution/">算法</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-三数之和" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/23/三数之和/" class="article-date">
  <time datetime="2020-09-22T20:52:19.000Z" itemprop="datePublished">2020-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/23/三数之和/">三数之和</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://leetcode-cn.com/problems/3sum/" target="_blank" rel="noopener">leetcode 算法题</a></p>
<h3 id="暴力求解"><a href="#暴力求解" class="headerlink" title="暴力求解"></a>暴力求解</h3><p>三层循环遍历数组把符合条件的数据放入数组之中，然后再去重，时间复杂度 n<em>n</em>n 再加去重时间</p>
<h3 id="优化暴力求解"><a href="#优化暴力求解" class="headerlink" title="优化暴力求解"></a>优化暴力求解</h3><p>数组排序，然后遍历数组，把数据放入对象中去重，避免最后的去重操作，时间复杂度 n<em>n</em>n</p>
<h3 id="双指针方法"><a href="#双指针方法" class="headerlink" title="双指针方法"></a>双指针方法</h3><p>数组进行排序，然后外层循环固定一个数，内层使用两个指针分别指向数组的左右两边，如果三数之和小于 0 则把左边指针右移，若果三数之和大于 0 则把右边指针左移，等于 0 时判断数组是否已经存在结果数组中，若存在则跳过，不存在放入数组并在 map 中标记</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> threeSum = <span class="function"><span class="keyword">function</span> (<span class="params">nums</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> sortNums = nums.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a - b)</span><br><span class="line">  <span class="keyword">const</span> len = sortNums.length</span><br><span class="line">  <span class="keyword">const</span> result = []</span><br><span class="line">  <span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len - <span class="number">2</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> left = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">let</span> right = len - <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> (left &lt; right) &#123;</span><br><span class="line">      <span class="keyword">if</span> (sortNums[i] + sortNums[left] + sortNums[right] &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        right = right - <span class="number">1</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sortNums[i] + sortNums[left] + sortNums[right] &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        left = left + <span class="number">1</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sortNums[i] + sortNums[left] + sortNums[right] === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!obj[<span class="string">`<span class="subst">$&#123;sortNums[i]&#125;</span>,<span class="subst">$&#123;sortNums[left]&#125;</span>,<span class="subst">$&#123;sortNums[right]&#125;</span>`</span>]) &#123;</span><br><span class="line">          result.push([sortNums[i], sortNums[left], sortNums[right]])</span><br><span class="line">          obj[<span class="string">`<span class="subst">$&#123;sortNums[i]&#125;</span>,<span class="subst">$&#123;sortNums[left]&#125;</span>,<span class="subst">$&#123;sortNums[right]&#125;</span>`</span>] = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        left = left + <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/09/23/三数之和/" data-id="ckqza38ku005pyys68gqkclqm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solution/">算法</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-antd中遇到的问题（一）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/09/21/antd中遇到的问题（一）/" class="article-date">
  <time datetime="2020-09-20T22:42:42.000Z" itemprop="datePublished">2020-09-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/09/21/antd中遇到的问题（一）/">antd中遇到的问题（一）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="antd-v4-版本中-Form-Item-子组件-value-不生效问题"><a href="#antd-v4-版本中-Form-Item-子组件-value-不生效问题" class="headerlink" title="antd v4 版本中 Form.Item 子组件 value 不生效问题"></a>antd v4 版本中 Form.Item 子组件 value 不生效问题</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>在 <code>Form.Item</code> 中使用 <code>Input</code> 输入框设置 <code>value</code> 时发现其不生效，查看使用文档也没有发现问题</p>
<h4 id="猜测"><a href="#猜测" class="headerlink" title="猜测"></a>猜测</h4><p><code>Form.Item</code> 对子组件的 <code>value</code> 属性做了劫持，导致手动设置的 <code>value</code> 被覆盖</p>
<h4 id="代码验证"><a href="#代码验证" class="headerlink" title="代码验证"></a>代码验证</h4><ol>
<li>通过查找 <code>return</code> 语句，发现执行了 <code>renderLayout</code> 这个方法</li>
<li>查看 <code>renderLayout</code> 的具体实现子组件实际渲染的是方法的实际参数 <code>baseChildren</code></li>
<li>查看 <code>renderLayout</code> 的调用发现在 <code>!hasName &amp;&amp; !isRenderProps &amp;&amp; !dependencies</code> 才会直接渲染子组件，其它情况会注入 <code>value</code> 等属性</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 先执行</span><br><span class="line">if (!hasName &amp;&amp; !isRenderProps &amp;&amp; !dependencies) &#123;</span><br><span class="line">  return renderLayout(children)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 再执行</span><br><span class="line">if (React.isValidElement(children)) &#123;</span><br><span class="line">  childNode = (</span><br><span class="line">    &lt;MemoInput</span><br><span class="line">      value=&#123;mergedControl[props.valuePropName || &apos;value&apos;]&#125;</span><br><span class="line">      update=&#123;updateRef.current&#125;</span><br><span class="line">    &gt;</span><br><span class="line">      &#123;React.cloneElement(children, childProps)&#125;</span><br><span class="line">    &lt;/MemoInput&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h4><p>去除 <code>Form.Item</code> 中的 <code>name</code> 属性，验证 <code>value</code> 属性生效</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/09/21/antd中遇到的问题（一）/" data-id="ckqza38hu000eyys65fv2spep" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/react/">react</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-language/">C/C++语言</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/">HTML</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">50</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeORM/">TypeORM</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TypeScript/">TypeScript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/express/">express</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/node/">node</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/other/">other</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/react/">react</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/webpack/">webpack</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solution/">算法</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/network/">计算机网络</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/source/">资源</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/c-language/" style="font-size: 12.86px;">C/C++语言</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/TypeORM/" style="font-size: 10px;">TypeORM</a> <a href="/tags/TypeScript/" style="font-size: 10px;">TypeScript</a> <a href="/tags/express/" style="font-size: 11.43px;">express</a> <a href="/tags/mysql/" style="font-size: 11.43px;">mysql</a> <a href="/tags/node/" style="font-size: 18.57px;">node</a> <a href="/tags/other/" style="font-size: 15.71px;">other</a> <a href="/tags/react/" style="font-size: 17.14px;">react</a> <a href="/tags/webpack/" style="font-size: 12.86px;">webpack</a> <a href="/tags/solution/" style="font-size: 14.29px;">算法</a> <a href="/tags/network/" style="font-size: 15.71px;">计算机网络</a> <a href="/tags/source/" style="font-size: 11.43px;">资源</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">四月 2021</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">一月 2021</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">十一月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">十月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">九月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/07/12/浏览器渲染过程详解/">浏览器渲染过程详解</a>
          </li>
        
          <li>
            <a href="/2021/07/11/js执行流程/">js执行流程</a>
          </li>
        
          <li>
            <a href="/2021/06/28/react中hooks实现原理/">react中hooks实现原理</a>
          </li>
        
          <li>
            <a href="/2021/06/20/react从dom-render到初次组件渲染完成/">react从dom.render到初次组件渲染完成</a>
          </li>
        
          <li>
            <a href="/2021/06/17/webpack源码阅读（二）/">webpack源码阅读（二）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 奔跑的蜗牛<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">分类</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>